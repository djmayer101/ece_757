<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: mem/ruby/network/garnet/flexible-pipeline/NetworkInterface.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>mem/ruby/network/garnet/flexible-pipeline/NetworkInterface.cc</h1>  </div>
</div>
<div class="contents">
<a href="NetworkInterface_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2008 Princeton University</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00006"></a>00006 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00007"></a>00007 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00008"></a>00008 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00009"></a>00009 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00010"></a>00010 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00011"></a>00011 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00012"></a>00012 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00013"></a>00013 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00014"></a>00014 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00017"></a>00017 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00018"></a>00018 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00019"></a>00019 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00020"></a>00020 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00021"></a>00021 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00022"></a>00022 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00023"></a>00023 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00024"></a>00024 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00025"></a>00025 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00026"></a>00026 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * Authors: Niket Agarwal</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="cast_8hh.html">base/cast.hh</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="stl__helpers_8hh.html">base/stl_helpers.hh</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;debug/RubyNetwork.hh&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="MessageBuffer_8hh.html">mem/ruby/buffers/MessageBuffer.hh</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="NetworkInterface_8hh.html">mem/ruby/network/garnet/flexible-pipeline/NetworkInterface.hh</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="flitBuffer_8hh.html">mem/ruby/network/garnet/flexible-pipeline/flitBuffer.hh</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="NetworkMessage_8hh.html">mem/ruby/slicc_interface/NetworkMessage.hh</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keyword">using namespace </span>std;
<a name="l00043"></a>00043 <span class="keyword">using</span> m5::stl_helpers::deletePointers;
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="classNetworkInterface.html#ac87930f9646a3eb1abd4f2cb88b5986f">00045</a> <a class="code" href="classNetworkInterface.html#ac87930f9646a3eb1abd4f2cb88b5986f">NetworkInterface::NetworkInterface</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">int</span> virtual_networks,
<a name="l00046"></a>00046                                    <a class="code" href="classGarnetNetwork.html">GarnetNetwork</a> *network_ptr)
<a name="l00047"></a>00047     : <a class="code" href="classFlexibleConsumer.html">FlexibleConsumer</a>(network_ptr)
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049     <a class="code" href="classNetworkInterface.html#ac19946136a5b7563f0247d67c617e2ec">m_id</a> = id;
<a name="l00050"></a>00050     <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a> = network_ptr;
<a name="l00051"></a>00051     <a class="code" href="classNetworkInterface.html#a209388582f8c65c506d19dccdf096fe3">m_virtual_networks</a>  = virtual_networks;
<a name="l00052"></a>00052     <a class="code" href="classNetworkInterface.html#acdbf9dc3b5aaabfe5e6eb7eaa173ff15">m_vc_per_vnet</a> = <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classBaseGarnetNetwork.html#a9605edad6ae1be8fd3fb467cd81f2783">getVCsPerVnet</a>();
<a name="l00053"></a>00053     <a class="code" href="classNetworkInterface.html#a188214563c32e9e96f06fd024714bbdd">m_num_vcs</a> = <a class="code" href="classNetworkInterface.html#acdbf9dc3b5aaabfe5e6eb7eaa173ff15">m_vc_per_vnet</a>*<a class="code" href="classNetworkInterface.html#a209388582f8c65c506d19dccdf096fe3">m_virtual_networks</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055     <a class="code" href="classNetworkInterface.html#a6a7916dc8e17bb32e1bff39472f35651">m_vc_round_robin</a> = 0;
<a name="l00056"></a>00056     <a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>.resize(<a class="code" href="classNetworkInterface.html#a188214563c32e9e96f06fd024714bbdd">m_num_vcs</a>);
<a name="l00057"></a>00057     <a class="code" href="classNetworkInterface.html#a72257ca3a5b360680ce733cc0d0491a4">inNode_ptr</a>.resize(m_virtual_networks);
<a name="l00058"></a>00058     <a class="code" href="classNetworkInterface.html#a5a02a69b64e05ad7cdb35ea7ab38e424">outNode_ptr</a>.resize(m_virtual_networks);
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <span class="comment">// instantiating the NI flit buffers</span>
<a name="l00061"></a>00061     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> =0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classNetworkInterface.html#a188214563c32e9e96f06fd024714bbdd">m_num_vcs</a>; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++)
<a name="l00062"></a>00062         <a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>] = <span class="keyword">new</span> <a class="code" href="classflitBuffer.html">flitBuffer</a>();
<a name="l00063"></a>00063 
<a name="l00064"></a>00064     <a class="code" href="classNetworkInterface.html#ab83389d031cc219cf15b72297478fbd1">m_vc_allocator</a>.resize(m_virtual_networks);
<a name="l00065"></a>00065     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; m_virtual_networks; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l00066"></a>00066         <a class="code" href="classNetworkInterface.html#ab83389d031cc219cf15b72297478fbd1">m_vc_allocator</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>] = 0;
<a name="l00067"></a>00067     }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; m_num_vcs; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l00070"></a>00070         <a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>.push_back(<span class="keyword">new</span> <a class="code" href="classOutVcState.html">OutVcState</a>(<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>));
<a name="l00071"></a>00071         <a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>]-&gt;setState(<a class="code" href="NetworkHeader_8hh.html#aaafaa208359111dcd9f4d47ff377da76a18b46dea81f1c4b313f0291111682145">IDLE_</a>, <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>());
<a name="l00072"></a>00072     }
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="classNetworkInterface.html#adc72badb87b206431e240704e9aaa7c1">00075</a> <a class="code" href="classNetworkInterface.html#adc72badb87b206431e240704e9aaa7c1">NetworkInterface::~NetworkInterface</a>()
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077     <a class="code" href="namespacem5_1_1stl__helpers.html#a789891cb80a549639c232ca96afb3fe1">deletePointers</a>(<a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>);
<a name="l00078"></a>00078     <a class="code" href="namespacem5_1_1stl__helpers.html#a789891cb80a549639c232ca96afb3fe1">deletePointers</a>(<a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>);
<a name="l00079"></a>00079     <span class="keyword">delete</span> <a class="code" href="classNetworkInterface.html#aed91ef36f009a1c24ab937f5b92b21c4">outSrcQueue</a>;
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="keywordtype">void</span>
<a name="l00083"></a><a class="code" href="classNetworkInterface.html#adab666f17651512aef3df8a91634a36d">00083</a> <a class="code" href="classNetworkInterface.html#adab666f17651512aef3df8a91634a36d">NetworkInterface::addInPort</a>(<a class="code" href="classNetworkLink.html">NetworkLink</a> *in_link)
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085     <a class="code" href="classNetworkInterface.html#ae391c2a9129c12b5c26c546311333ec5">inNetLink</a> = in_link;
<a name="l00086"></a>00086     in_link-&gt;<a class="code" href="classNetworkLink.html#ac2cf70dcfc66c27d1721018d5ca126bf">setLinkConsumer</a>(<span class="keyword">this</span>);
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="keywordtype">void</span>
<a name="l00090"></a><a class="code" href="classNetworkInterface.html#a75748f72e000d2578b85844fea231aa4">00090</a> <a class="code" href="classNetworkInterface.html#a75748f72e000d2578b85844fea231aa4">NetworkInterface::addOutPort</a>(<a class="code" href="classNetworkLink.html">NetworkLink</a> *out_link)
<a name="l00091"></a>00091 {
<a name="l00092"></a>00092     <a class="code" href="classNetworkInterface.html#a7b84bcac84080753622fff4cacd1bfc3">outNetLink</a> = out_link;
<a name="l00093"></a>00093     <a class="code" href="classNetworkInterface.html#aed91ef36f009a1c24ab937f5b92b21c4">outSrcQueue</a> = <span class="keyword">new</span> <a class="code" href="classflitBuffer.html">flitBuffer</a>();
<a name="l00094"></a>00094     out_link-&gt;<a class="code" href="classNetworkLink.html#af768f29f7d897898ef4544deb0816718">setSourceQueue</a>(<a class="code" href="classNetworkInterface.html#aed91ef36f009a1c24ab937f5b92b21c4">outSrcQueue</a>);
<a name="l00095"></a>00095     out_link-&gt;<a class="code" href="classNetworkLink.html#a53a83caa8b184c14ee6f9d48f3b4df78">setSource</a>(<span class="keyword">this</span>);
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keywordtype">void</span>
<a name="l00099"></a><a class="code" href="classNetworkInterface.html#a9e75628799599d9969e38cb3c46113b5">00099</a> <a class="code" href="classNetworkInterface.html#a9e75628799599d9969e38cb3c46113b5">NetworkInterface::addNode</a>(<a class="code" href="classstd_1_1vector.html">vector&lt;MessageBuffer*&gt;</a>&amp; in,
<a name="l00100"></a>00100     <a class="code" href="classstd_1_1vector.html">vector&lt;MessageBuffer*&gt;</a>&amp; out)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     assert(in.size() == <a class="code" href="classNetworkInterface.html#a209388582f8c65c506d19dccdf096fe3">m_virtual_networks</a>);
<a name="l00103"></a>00103     <a class="code" href="classNetworkInterface.html#a72257ca3a5b360680ce733cc0d0491a4">inNode_ptr</a> = in;
<a name="l00104"></a>00104     <a class="code" href="classNetworkInterface.html#a5a02a69b64e05ad7cdb35ea7ab38e424">outNode_ptr</a> = out;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="comment">// protocol injects messages into the NI</span>
<a name="l00107"></a>00107     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> = 0; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> &lt; <a class="code" href="classNetworkInterface.html#a209388582f8c65c506d19dccdf096fe3">m_virtual_networks</a>; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>++) {
<a name="l00108"></a>00108         inNode_ptr[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>]-&gt;setConsumer(<span class="keyword">this</span>);
<a name="l00109"></a>00109         inNode_ptr[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>]-&gt;setReceiver(<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         <a class="code" href="classNetworkInterface.html#a5a02a69b64e05ad7cdb35ea7ab38e424">outNode_ptr</a>[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>]-&gt;setSender(<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>);
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="keywordtype">void</span>
<a name="l00116"></a><a class="code" href="classNetworkInterface.html#a6c5b5482baf5b195181e9c43f10472d5">00116</a> <a class="code" href="classNetworkInterface.html#a6c5b5482baf5b195181e9c43f10472d5">NetworkInterface::request_vc</a>(<span class="keywordtype">int</span> in_vc, <span class="keywordtype">int</span> in_port, <a class="code" href="classNetDest.html">NetDest</a> <a class="code" href="namespaceX86ISA.html#aa49a1e243decf460110b2436025d8823">destination</a>,
<a name="l00117"></a>00117                              <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a> request_time)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119     <a class="code" href="classNetworkInterface.html#ae391c2a9129c12b5c26c546311333ec5">inNetLink</a>-&gt;<a class="code" href="classNetworkLink.html#a36087a66fc422d1c600ba087b6905380">grant_vc_link</a>(in_vc, request_time);
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="keywordtype">bool</span>
<a name="l00123"></a><a class="code" href="classNetworkInterface.html#a3f3042e7af893637ec4335ff5589c4fe">00123</a> <a class="code" href="classNetworkInterface.html#a3f3042e7af893637ec4335ff5589c4fe">NetworkInterface::flitisizeMessage</a>(<a class="code" href="classRefCountingPtr.html">MsgPtr</a> msg_ptr, <span class="keywordtype">int</span> vnet)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125     <a class="code" href="classNetworkMessage.html">NetworkMessage</a> *net_msg_ptr = <a class="code" href="cast_8hh.html#a5f660f8e3c1002271ec98c59eeda331f">safe_cast</a>&lt;<a class="code" href="classNetworkMessage.html">NetworkMessage</a> *&gt;(msg_ptr.<a class="code" href="classRefCountingPtr.html#aa785d647c815cf333fa80d79a5a558c9" title="Directly access the pointer itself without taking a reference.">get</a>());
<a name="l00126"></a>00126     <a class="code" href="classNetDest.html">NetDest</a> net_msg_dest = net_msg_ptr-&gt;<a class="code" href="classNetworkMessage.html#a273c8c28cf5df3683d7f898ace0e95e3">getInternalDestination</a>();
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="comment">// get all the destinations associated with this message.</span>
<a name="l00129"></a>00129     <a class="code" href="classstd_1_1vector.html" title="STL vector class.">vector&lt;NodeID&gt;</a> dest_nodes = net_msg_dest.<a class="code" href="classNetDest.html#a9f8ff8b0699e1213d6959e5d699aaff9">getAllDest</a>();
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="comment">// Number of flits is dependent on the link bandwidth available.</span>
<a name="l00132"></a>00132     <span class="comment">// This is expressed in terms of bytes/cycle or the flit size</span>
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keywordtype">int</span> num_flits = (int) ceil((<span class="keywordtype">double</span>) <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classNetwork.html#a95a45f01dcace0a3a32d3c9004ce57bd">MessageSizeType_to_int</a>(
<a name="l00135"></a>00135                 net_msg_ptr-&gt;<a class="code" href="classNetworkMessage.html#a022248e4da0548b2d7b7e339e39fd48b">getMessageSize</a>())/<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classBaseGarnetNetwork.html#a730f190e8a856b4bc696f9cd7a5a104a">getNiFlitSize</a>());
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="comment">// loop to convert all multicast messages into unicast messages</span>
<a name="l00138"></a>00138     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ctr = 0; ctr &lt; dest_nodes.size(); ctr++) {
<a name="l00139"></a>00139         <span class="keywordtype">int</span> vc = <a class="code" href="classNetworkInterface.html#a75606f4ac949f03c364730b4f369bda6">calculateVC</a>(vnet); <span class="comment">// this will return a free output vc</span>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="keywordflow">if</span> (vc == -1) {
<a name="l00142"></a>00142             <span class="comment">// did not find a free output vc</span>
<a name="l00143"></a>00143             <span class="keywordflow">return</span> false ;
<a name="l00144"></a>00144         }
<a name="l00145"></a>00145         <a class="code" href="classRefCountingPtr.html">MsgPtr</a> new_msg_ptr = msg_ptr-&gt;clone();
<a name="l00146"></a>00146         <a class="code" href="TypeDefines_8hh.html#ae8d9d0f49cd0dc16ba088be027f2939f">NodeID</a> destID = dest_nodes[ctr];
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <a class="code" href="classNetworkMessage.html">NetworkMessage</a> *new_net_msg_ptr =
<a name="l00149"></a>00149             <a class="code" href="cast_8hh.html#a5f660f8e3c1002271ec98c59eeda331f">safe_cast</a>&lt;<a class="code" href="classNetworkMessage.html">NetworkMessage</a> *&gt;(new_msg_ptr.<a class="code" href="classRefCountingPtr.html#aa785d647c815cf333fa80d79a5a558c9" title="Directly access the pointer itself without taking a reference.">get</a>());
<a name="l00150"></a>00150         <span class="keywordflow">if</span> (dest_nodes.size() &gt; 1) {
<a name="l00151"></a>00151             <a class="code" href="classNetDest.html">NetDest</a> personal_dest;
<a name="l00152"></a>00152             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a> = 0; <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a> &lt; (int) MachineType_NUM; <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a>++) {
<a name="l00153"></a>00153                 <span class="keywordflow">if</span> ((destID &gt;= MachineType_base_number((MachineType) <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a>)) &amp;&amp;
<a name="l00154"></a>00154                     destID &lt; MachineType_base_number((MachineType) (m+1))) {
<a name="l00155"></a>00155                     <span class="comment">// calculating the NetDest associated with this destID</span>
<a name="l00156"></a>00156                     personal_dest.<a class="code" href="classNetDest.html#abc866bd598bce20c078962987830f9e1">clear</a>();
<a name="l00157"></a>00157                     personal_dest.<a class="code" href="classNetDest.html#a01d261941143e6cd252599bdc174017f">add</a>((<a class="code" href="structMachineID.html">MachineID</a>) {(MachineType) m, (destID -
<a name="l00158"></a>00158                         MachineType_base_number((MachineType) m))});
<a name="l00159"></a>00159                     new_net_msg_ptr-&gt;<a class="code" href="classNetworkMessage.html#a273c8c28cf5df3683d7f898ace0e95e3">getInternalDestination</a>() = personal_dest;
<a name="l00160"></a>00160                     <span class="keywordflow">break</span>;
<a name="l00161"></a>00161                 }
<a name="l00162"></a>00162             }
<a name="l00163"></a>00163             net_msg_dest.<a class="code" href="classNetDest.html#ab84a85a010cc1a309c577ade6098c551">removeNetDest</a>(personal_dest);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165             <span class="comment">// removing the destination from the original message to reflect</span>
<a name="l00166"></a>00166             <span class="comment">// that a message with this particular destination has been</span>
<a name="l00167"></a>00167             <span class="comment">// flitisized and an output vc is acquired</span>
<a name="l00168"></a>00168             net_msg_ptr-&gt;<a class="code" href="classNetworkMessage.html#a273c8c28cf5df3683d7f898ace0e95e3">getInternalDestination</a>().<a class="code" href="classNetDest.html#ab84a85a010cc1a309c577ade6098c551">removeNetDest</a>(personal_dest);
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; num_flits; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l00171"></a>00171             <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classBaseGarnetNetwork.html#ab71ffb90965837335aec3a8d4b2fd622">increment_injected_flits</a>(vnet);
<a name="l00172"></a>00172             <a class="code" href="classflit.html">flit</a> *fl = <span class="keyword">new</span> <a class="code" href="classflit.html">flit</a>(<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>, vc, vnet, num_flits, new_msg_ptr,
<a name="l00173"></a>00173                                 <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>());
<a name="l00174"></a>00174             fl-&gt;<a class="code" href="classflit.html#a9b42036aa80f27a0b9cc60b3f7eadd24">set_delay</a>(<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>() -
<a name="l00175"></a>00175                           <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a0ed1c09106348a3fcd72ea19909256c1">ticksToCycles</a>(msg_ptr-&gt;getTime()));
<a name="l00176"></a>00176             <a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>[vc]-&gt;insert(fl);
<a name="l00177"></a>00177         }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179         <a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[vc]-&gt;setState(<a class="code" href="NetworkHeader_8hh.html#aaafaa208359111dcd9f4d47ff377da76ad6720dcce1c5352be9d53460376fdf5c">VC_AB_</a>, <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>());
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <span class="comment">// setting an output vc request for the next hop.</span>
<a name="l00182"></a>00182         <span class="comment">// This flit will be ready to traverse the link and into the next hop</span>
<a name="l00183"></a>00183         <span class="comment">// only when an output vc is acquired at the next hop</span>
<a name="l00184"></a>00184         <a class="code" href="classNetworkInterface.html#a7b84bcac84080753622fff4cacd1bfc3">outNetLink</a>-&gt;<a class="code" href="classNetworkLink.html#ab3e827bf58f9d020c26a63b52358fb68">request_vc_link</a>(vc,
<a name="l00185"></a>00185                                     new_net_msg_ptr-&gt;<a class="code" href="classNetworkMessage.html#a273c8c28cf5df3683d7f898ace0e95e3">getInternalDestination</a>(),
<a name="l00186"></a>00186                                     <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>());
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="keywordflow">return</span> true ;
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 <span class="comment">// An output vc has been granted at the next hop to one of the vc&#39;s.</span>
<a name="l00193"></a>00193 <span class="comment">// We have to update the state of the vc to reflect this</span>
<a name="l00194"></a>00194 <span class="keywordtype">void</span>
<a name="l00195"></a><a class="code" href="classNetworkInterface.html#afb8114db4126785bdf5a4ddc65a7f023">00195</a> <a class="code" href="classNetworkInterface.html#afb8114db4126785bdf5a4ddc65a7f023">NetworkInterface::grant_vc</a>(<span class="keywordtype">int</span> out_port, <span class="keywordtype">int</span> vc, <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a> grant_time)
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197     assert(<a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[vc]-&gt;isInState(<a class="code" href="NetworkHeader_8hh.html#aaafaa208359111dcd9f4d47ff377da76ad6720dcce1c5352be9d53460376fdf5c">VC_AB_</a>, grant_time));
<a name="l00198"></a>00198     <a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[vc]-&gt;grant_vc(grant_time);
<a name="l00199"></a>00199     <a class="code" href="classConsumer.html#a10ad65fbcd1585d43d431b260c737ead">scheduleEvent</a>(<a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="comment">// The tail flit corresponding to this vc has been buffered at the next hop</span>
<a name="l00203"></a>00203 <span class="comment">// and thus this vc is now free</span>
<a name="l00204"></a>00204 <span class="keywordtype">void</span>
<a name="l00205"></a><a class="code" href="classNetworkInterface.html#aa56cbc7223eb2bd36f829aec9ad72565">00205</a> <a class="code" href="classNetworkInterface.html#aa56cbc7223eb2bd36f829aec9ad72565">NetworkInterface::release_vc</a>(<span class="keywordtype">int</span> out_port, <span class="keywordtype">int</span> vc, <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a> release_time)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     assert(<a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[vc]-&gt;isInState(<a class="code" href="NetworkHeader_8hh.html#aaafaa208359111dcd9f4d47ff377da76a767d5451ce027a7881f351e2961a96a2">ACTIVE_</a>, release_time));
<a name="l00208"></a>00208     <a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[vc]-&gt;setState(<a class="code" href="NetworkHeader_8hh.html#aaafaa208359111dcd9f4d47ff377da76a18b46dea81f1c4b313f0291111682145">IDLE_</a>, release_time);
<a name="l00209"></a>00209     <a class="code" href="classConsumer.html#a10ad65fbcd1585d43d431b260c737ead">scheduleEvent</a>(<a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="comment">// Looking for a free output vc</span>
<a name="l00213"></a>00213 <span class="keywordtype">int</span>
<a name="l00214"></a><a class="code" href="classNetworkInterface.html#a75606f4ac949f03c364730b4f369bda6">00214</a> <a class="code" href="classNetworkInterface.html#a75606f4ac949f03c364730b4f369bda6">NetworkInterface::calculateVC</a>(<span class="keywordtype">int</span> vnet)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <span class="keywordtype">int</span> vc_per_vnet;
<a name="l00217"></a>00217     <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classBaseGarnetNetwork.html#a2d5ccec2265481988ca3fe69ae786ee1">isVNetOrdered</a>(vnet))
<a name="l00218"></a>00218         vc_per_vnet = 1;
<a name="l00219"></a>00219     <span class="keywordflow">else</span>
<a name="l00220"></a>00220         vc_per_vnet = <a class="code" href="classNetworkInterface.html#acdbf9dc3b5aaabfe5e6eb7eaa173ff15">m_vc_per_vnet</a>;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; vc_per_vnet; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l00223"></a>00223         <span class="keywordtype">int</span> delta = <a class="code" href="classNetworkInterface.html#ab83389d031cc219cf15b72297478fbd1">m_vc_allocator</a>[vnet];
<a name="l00224"></a>00224         <a class="code" href="classNetworkInterface.html#ab83389d031cc219cf15b72297478fbd1">m_vc_allocator</a>[vnet]++;
<a name="l00225"></a>00225         <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#ab83389d031cc219cf15b72297478fbd1">m_vc_allocator</a>[vnet] == vc_per_vnet)
<a name="l00226"></a>00226             <a class="code" href="classNetworkInterface.html#ab83389d031cc219cf15b72297478fbd1">m_vc_allocator</a>[vnet] = 0;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[(vnet*<a class="code" href="classNetworkInterface.html#acdbf9dc3b5aaabfe5e6eb7eaa173ff15">m_vc_per_vnet</a>) + delta]-&gt;isInState(<a class="code" href="NetworkHeader_8hh.html#aaafaa208359111dcd9f4d47ff377da76a18b46dea81f1c4b313f0291111682145">IDLE_</a>,
<a name="l00229"></a>00229             <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>())) {
<a name="l00230"></a>00230             <span class="keywordflow">return</span> ((vnet*m_vc_per_vnet) + delta);
<a name="l00231"></a>00231         }
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233     <span class="keywordflow">return</span> -1;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="comment">/*</span>
<a name="l00237"></a>00237 <span class="comment"> * The NI wakeup checks whether there are any ready messages in the protocol</span>
<a name="l00238"></a>00238 <span class="comment"> * buffer. If yes, it picks that up, flitisizes it into a number of flits and</span>
<a name="l00239"></a>00239 <span class="comment"> * puts it into an output buffer and schedules the output link.</span>
<a name="l00240"></a>00240 <span class="comment"> * On a wakeup it also checks whether there are flits in the input link.</span>
<a name="l00241"></a>00241 <span class="comment"> * If yes, it picks them up and if the flit is a tail, the NI inserts the</span>
<a name="l00242"></a>00242 <span class="comment"> * corresponding message into the protocol buffer.</span>
<a name="l00243"></a>00243 <span class="comment"> */</span>
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keywordtype">void</span>
<a name="l00246"></a><a class="code" href="classNetworkInterface.html#a2b3e119532856dda92bdd5ec1abcdf4a">00246</a> <a class="code" href="classNetworkInterface.html#a2b3e119532856dda92bdd5ec1abcdf4a">NetworkInterface::wakeup</a>()
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248     <a class="code" href="classRefCountingPtr.html">MsgPtr</a> msg_ptr;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="comment">//Checking for messages coming from the protocol</span>
<a name="l00251"></a>00251     <span class="comment">// can pick up a message/cycle for each virtual net</span>
<a name="l00252"></a>00252     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> vnet = 0; vnet &lt; <a class="code" href="classNetworkInterface.html#a209388582f8c65c506d19dccdf096fe3">m_virtual_networks</a>; vnet++) {
<a name="l00253"></a>00253         <span class="keywordflow">while</span> (<a class="code" href="classNetworkInterface.html#a72257ca3a5b360680ce733cc0d0491a4">inNode_ptr</a>[vnet]-&gt;isReady()) <span class="comment">// Is there a message waiting</span>
<a name="l00254"></a>00254         {
<a name="l00255"></a>00255             msg_ptr = <a class="code" href="classNetworkInterface.html#a72257ca3a5b360680ce733cc0d0491a4">inNode_ptr</a>[vnet]-&gt;peekMsgPtr();
<a name="l00256"></a>00256             <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a3f3042e7af893637ec4335ff5589c4fe">flitisizeMessage</a>(msg_ptr, vnet)) {
<a name="l00257"></a>00257                 <a class="code" href="classNetworkInterface.html#a72257ca3a5b360680ce733cc0d0491a4">inNode_ptr</a>[vnet]-&gt;pop();
<a name="l00258"></a>00258             } <span class="keywordflow">else</span> {
<a name="l00259"></a>00259                 <span class="keywordflow">break</span>;
<a name="l00260"></a>00260             }
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <a class="code" href="classNetworkInterface.html#ab56d931a6d9629b46aaada2b60c04bbf">scheduleOutputLink</a>();
<a name="l00265"></a>00265     <a class="code" href="classNetworkInterface.html#a6730ad218fa830fcfbc3fb61eb68e6fe">checkReschedule</a>();
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     <span class="comment">/*********** Picking messages destined for this NI **********/</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#ae391c2a9129c12b5c26c546311333ec5">inNetLink</a>-&gt;<a class="code" href="classNetworkLink.html#a4b51fc33389132c875d8e73da5a72d6d">isReady</a>()) {
<a name="l00270"></a>00270         <a class="code" href="classflit.html">flit</a> *t_flit = <a class="code" href="classNetworkInterface.html#ae391c2a9129c12b5c26c546311333ec5">inNetLink</a>-&gt;<a class="code" href="classNetworkLink.html#a359ac9fd60013ae904168189193cde97">consumeLink</a>();
<a name="l00271"></a>00271         <span class="keywordflow">if</span> (t_flit-&gt;<a class="code" href="classflit.html#a07a6a33a4c296f3f027f12c9f0725e4d">get_type</a>() == <a class="code" href="NetworkHeader_8hh.html#a2c6c8cfc6307d086e578093535798328a9fa3c0aede2c8cdf20f0c6410bf6896e">TAIL_</a> || t_flit-&gt;<a class="code" href="classflit.html#a07a6a33a4c296f3f027f12c9f0725e4d">get_type</a>() == HEAD_TAIL_) {
<a name="l00272"></a>00272             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(RubyNetwork, <span class="stringliteral">&quot;m_id: %d, Message delivered at time: %lld\n&quot;</span>,
<a name="l00273"></a>00273                     <a class="code" href="classNetworkInterface.html#ac19946136a5b7563f0247d67c617e2ec">m_id</a>, <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>());
<a name="l00274"></a>00274 
<a name="l00275"></a>00275             <a class="code" href="classNetworkInterface.html#a5a02a69b64e05ad7cdb35ea7ab38e424">outNode_ptr</a>[t_flit-&gt;<a class="code" href="classflit.html#a50c55eda12ab4d8f02925ea8fc8ce8a2">get_vnet</a>()]-&gt;enqueue(
<a name="l00276"></a>00276                 t_flit-&gt;<a class="code" href="classflit.html#afe6d72f1b18ec211c2e2936d4761b6d0">get_msg_ptr</a>(), <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00277"></a>00277 
<a name="l00278"></a>00278             <span class="comment">// signal the upstream router that this vc can be freed now</span>
<a name="l00279"></a>00279             <a class="code" href="classNetworkInterface.html#ae391c2a9129c12b5c26c546311333ec5">inNetLink</a>-&gt;<a class="code" href="classNetworkLink.html#a1cd95dbe0e806f4f3dcce8be514e487a">release_vc_link</a>(t_flit-&gt;<a class="code" href="classflit.html#ab53b2cef7eef99b47aeae971fbbe42cf">get_vc</a>(),
<a name="l00280"></a>00280                 <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>() + <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00281"></a>00281         }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <span class="keywordtype">int</span> vnet = t_flit-&gt;<a class="code" href="classflit.html#a50c55eda12ab4d8f02925ea8fc8ce8a2">get_vnet</a>();
<a name="l00284"></a>00284         <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classBaseGarnetNetwork.html#aacec316314e034d2227e8040b69fe7a2">increment_received_flits</a>(vnet);
<a name="l00285"></a>00285         <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a> network_delay = <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>() -
<a name="l00286"></a>00286                                t_flit-&gt;<a class="code" href="classflit.html#a09ee36afbf37e08f208dc3b500494670">get_enqueue_time</a>();
<a name="l00287"></a>00287         <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a> queueing_delay = t_flit-&gt;<a class="code" href="classflit.html#a000a6a7b05ca953d99132ae3ccf16c72">get_delay</a>();
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classBaseGarnetNetwork.html#a23d6d531c35acfe92367c0aa1001f2b1">increment_network_latency</a>(network_delay, vnet);
<a name="l00290"></a>00290         <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classBaseGarnetNetwork.html#ab970ef4054f027f9fe74bdd2007e415a">increment_queueing_latency</a>(queueing_delay, vnet);
<a name="l00291"></a>00291         <span class="keyword">delete</span> t_flit;
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment">/* This function looks at the NI buffers and if some buffer has flits which</span>
<a name="l00296"></a>00296 <span class="comment"> * are ready to traverse the link in the next cycle and also the downstream</span>
<a name="l00297"></a>00297 <span class="comment"> * output vc associated with this flit has buffers left, the link is scheduled</span>
<a name="l00298"></a>00298 <span class="comment"> * for the next cycle</span>
<a name="l00299"></a>00299 <span class="comment"> */</span>
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="keywordtype">void</span>
<a name="l00302"></a><a class="code" href="classNetworkInterface.html#ab56d931a6d9629b46aaada2b60c04bbf">00302</a> <a class="code" href="classNetworkInterface.html#ab56d931a6d9629b46aaada2b60c04bbf">NetworkInterface::scheduleOutputLink</a>()
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304     <span class="keywordtype">int</span> vc = <a class="code" href="classNetworkInterface.html#a6a7916dc8e17bb32e1bff39472f35651">m_vc_round_robin</a>;
<a name="l00305"></a>00305     <a class="code" href="classNetworkInterface.html#a6a7916dc8e17bb32e1bff39472f35651">m_vc_round_robin</a>++;
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a6a7916dc8e17bb32e1bff39472f35651">m_vc_round_robin</a> == <a class="code" href="classNetworkInterface.html#a188214563c32e9e96f06fd024714bbdd">m_num_vcs</a>)
<a name="l00307"></a>00307         <a class="code" href="classNetworkInterface.html#a6a7916dc8e17bb32e1bff39472f35651">m_vc_round_robin</a> = 0;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classNetworkInterface.html#a188214563c32e9e96f06fd024714bbdd">m_num_vcs</a>; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l00310"></a>00310         vc++;
<a name="l00311"></a>00311         <span class="keywordflow">if</span> (vc == m_num_vcs)
<a name="l00312"></a>00312             vc = 0;
<a name="l00313"></a>00313         <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>[vc]-&gt;isReady(<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>())) {
<a name="l00314"></a>00314             <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a92ce49642f232d945bb58cf76d43e558">m_out_vc_state</a>[vc]-&gt;isInState(<a class="code" href="NetworkHeader_8hh.html#aaafaa208359111dcd9f4d47ff377da76a767d5451ce027a7881f351e2961a96a2">ACTIVE_</a>,
<a name="l00315"></a>00315                <a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>()) &amp;&amp;
<a name="l00316"></a>00316                <a class="code" href="classNetworkInterface.html#a7b84bcac84080753622fff4cacd1bfc3">outNetLink</a>-&gt;<a class="code" href="classNetworkLink.html#a80b95d410568cdfccfb7b344567a174e">isBufferNotFull_link</a>(vc)) {  <span class="comment">// buffer backpressure</span>
<a name="l00317"></a>00317 
<a name="l00318"></a>00318                 <span class="comment">// Just removing the flit</span>
<a name="l00319"></a>00319                 <a class="code" href="classflit.html">flit</a> *t_flit = <a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>[vc]-&gt;getTopFlit();
<a name="l00320"></a>00320                 t_flit-&gt;<a class="code" href="classflit.html#a3a2feea25d821d322074e7f9dff4b28f">set_time</a>(<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>() + <a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00321"></a>00321                 <a class="code" href="classNetworkInterface.html#aed91ef36f009a1c24ab937f5b92b21c4">outSrcQueue</a>-&gt;<a class="code" href="classflitBuffer.html#a748f7a78a1bec30a356e2b2e269ef481">insert</a>(t_flit);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323                 <span class="comment">// schedule the out link</span>
<a name="l00324"></a>00324                 <a class="code" href="classNetworkInterface.html#a7b84bcac84080753622fff4cacd1bfc3">outNetLink</a>-&gt;<a class="code" href="classConsumer.html#a10ad65fbcd1585d43d431b260c737ead">scheduleEvent</a>(<a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00325"></a>00325                 <span class="keywordflow">return</span>;
<a name="l00326"></a>00326             }
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="keywordtype">void</span>
<a name="l00332"></a><a class="code" href="classNetworkInterface.html#a6730ad218fa830fcfbc3fb61eb68e6fe">00332</a> <a class="code" href="classNetworkInterface.html#a6730ad218fa830fcfbc3fb61eb68e6fe">NetworkInterface::checkReschedule</a>()
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> vnet = 0; vnet &lt; <a class="code" href="classNetworkInterface.html#a209388582f8c65c506d19dccdf096fe3">m_virtual_networks</a>; vnet++) {
<a name="l00335"></a>00335         <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a72257ca3a5b360680ce733cc0d0491a4">inNode_ptr</a>[vnet]-&gt;isReady()) { <span class="comment">// Is there a message waiting</span>
<a name="l00336"></a>00336             <a class="code" href="classConsumer.html#a10ad65fbcd1585d43d431b260c737ead">scheduleEvent</a>(<a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00337"></a>00337             <span class="keywordflow">return</span>;
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> vc = 0; vc &lt; <a class="code" href="classNetworkInterface.html#a188214563c32e9e96f06fd024714bbdd">m_num_vcs</a>; vc++) {
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>[vc]-&gt;isReadyForNext(<a class="code" href="classNetworkInterface.html#ae0a7f5334183985d59d2c3940dc21987">m_net_ptr</a>-&gt;<a class="code" href="classClockedObject.html#a2b4a36a0ae697fe2c7c1c493146d7626" title="Determine the current cycle, corresponding to a tick aligned to a clock edge.">curCycle</a>())) {
<a name="l00342"></a>00342             <a class="code" href="classConsumer.html#a10ad65fbcd1585d43d431b260c737ead">scheduleEvent</a>(<a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1));
<a name="l00343"></a>00343             <span class="keywordflow">return</span>;
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="keywordtype">bool</span>
<a name="l00349"></a><a class="code" href="classNetworkInterface.html#ad6a38fbbae255498ac52f0df612347b2">00349</a> <a class="code" href="classNetworkInterface.html#ad6a38fbbae255498ac52f0df612347b2">NetworkInterface::functionalRead</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system (e...">Packet</a> *pkt)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351     <span class="comment">// Go through the internal buffers</span>
<a name="l00352"></a>00352     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>.size(); ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00353"></a>00353         <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>]-&gt;<a class="code" href="classNetworkInterface.html#ad6a38fbbae255498ac52f0df612347b2">functionalRead</a>(pkt)) {
<a name="l00354"></a>00354             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <span class="comment">// Go through the buffer between this network interface and the router</span>
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (<a class="code" href="classNetworkInterface.html#aed91ef36f009a1c24ab937f5b92b21c4">outSrcQueue</a>-&gt;<a class="code" href="classflitBuffer.html#a5f486dc0785ed8d18cc7c5ed9b427932">functionalRead</a>(pkt)) {
<a name="l00360"></a>00360         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 <a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>
<a name="l00367"></a><a class="code" href="classNetworkInterface.html#a7639080801c72447386c5ffa303a5deb">00367</a> <a class="code" href="classNetworkInterface.html#a7639080801c72447386c5ffa303a5deb">NetworkInterface::functionalWrite</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system (e...">Packet</a> *pkt)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     <a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> num_functional_writes = 0;
<a name="l00370"></a>00370     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>.size(); ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00371"></a>00371         num_functional_writes += <a class="code" href="classNetworkInterface.html#a40993d094c8d973f9ec15b4380775a10">m_ni_buffers</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>]-&gt;functionalWrite(pkt);
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     num_functional_writes += <a class="code" href="classNetworkInterface.html#aed91ef36f009a1c24ab937f5b92b21c4">outSrcQueue</a>-&gt;<a class="code" href="classflitBuffer.html#aaf63962d1c68ffe10dcb2cc2bb219f6b">functionalWrite</a>(pkt);
<a name="l00375"></a>00375     <span class="keywordflow">return</span> num_functional_writes;
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="keywordtype">void</span>
<a name="l00379"></a><a class="code" href="classNetworkInterface.html#a4eb4ee0241b0684f831b402e3580928a">00379</a> <a class="code" href="classNetworkInterface.html#a4eb4ee0241b0684f831b402e3580928a">NetworkInterface::print</a>(std::ostream&amp; out)<span class="keyword"> const</span>
<a name="l00380"></a>00380 <span class="keyword"></span>{
<a name="l00381"></a>00381     out &lt;&lt; <span class="stringliteral">&quot;[Network Interface]&quot;</span>;
<a name="l00382"></a>00382 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Sun Apr 7 2013 18:16:46 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.7.1</small></address>

</body>
</html>
