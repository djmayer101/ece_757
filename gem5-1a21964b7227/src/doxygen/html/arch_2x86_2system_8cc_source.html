<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: arch/x86/system.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>arch/x86/system.cc</h1>  </div>
</div>
<div class="contents">
<a href="arch_2x86_2system_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2007 The Hewlett-Packard Development Company</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * The license below extends only to copyright in the software and shall</span>
<a name="l00006"></a>00006 <span class="comment"> * not be construed as granting a license to any other intellectual</span>
<a name="l00007"></a>00007 <span class="comment"> * property including but not limited to intellectual property relating</span>
<a name="l00008"></a>00008 <span class="comment"> * to a hardware implementation of the functionality of the software</span>
<a name="l00009"></a>00009 <span class="comment"> * licensed hereunder.  You may use the software subject to the license</span>
<a name="l00010"></a>00010 <span class="comment"> * terms below provided that you ensure that this notice is replicated</span>
<a name="l00011"></a>00011 <span class="comment"> * unmodified and in its entirety in all distributions of the software,</span>
<a name="l00012"></a>00012 <span class="comment"> * modified or unmodified, in source code or in binary form.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00015"></a>00015 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00016"></a>00016 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00017"></a>00017 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00018"></a>00018 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00019"></a>00019 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00020"></a>00020 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00021"></a>00021 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00022"></a>00022 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00023"></a>00023 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00026"></a>00026 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00027"></a>00027 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00028"></a>00028 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00029"></a>00029 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00030"></a>00030 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00031"></a>00031 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00032"></a>00032 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00033"></a>00033 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00034"></a>00034 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00035"></a>00035 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * Authors: Gabe Black</span>
<a name="l00038"></a>00038 <span class="comment"> */</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="intelmp_8hh.html">arch/x86/bios/intelmp.hh</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="smbios_8hh.html">arch/x86/bios/smbios.hh</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="arch_2x86_2regs_2misc_8hh.html">arch/x86/regs/misc.hh</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="x86_2isa__traits_8hh.html">arch/x86/isa_traits.hh</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="arch_2x86_2system_8hh.html">arch/x86/system.hh</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;arch/vtophys.hh&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="object__file_8hh.html">base/loader/object_file.hh</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="symtab_8hh.html">base/loader/symtab.hh</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="intmath_8hh.html">base/intmath.hh</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="trace_8hh.html">base/trace.hh</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="thread__context_8hh.html">cpu/thread_context.hh</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="port__proxy_8hh.html" title="PortProxy Object Declaration.">mem/port_proxy.hh</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;params/X86System.hh&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="byteswap_8hh.html">sim/byteswap.hh</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">using namespace </span>LittleEndianGuest;
<a name="l00056"></a>00056 <span class="keyword">using namespace </span>X86ISA;
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="classX86System.html#afc6e97d2ed972b74b554451ae04179a0">00058</a> <a class="code" href="classX86System.html#afc6e97d2ed972b74b554451ae04179a0">X86System::X86System</a>(<a class="code" href="classX86System.html#a3c2844c450507194abd4385df0e1aebd">Params</a> *<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>) :
<a name="l00059"></a>00059     <a class="code" href="classSystem.html">System</a>(p), smbiosTable(p-&gt;smbios_table),
<a name="l00060"></a>00060     mpFloatingPointer(p-&gt;intel_mp_pointer),
<a name="l00061"></a>00061     mpConfigTable(p-&gt;intel_mp_table),
<a name="l00062"></a>00062     rsdp(p-&gt;acpi_description_table_pointer)
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00067"></a><a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">00067</a> <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(<a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside of the CPU...">ThreadContext</a> *tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682">SegmentRegIndex</a> <a class="code" href="namespaceX86ISA.html#a5bc8a695e4619ccf733d545021fe664e">seg</a>,
<a name="l00068"></a>00068         SegDescriptor desc, <span class="keywordtype">bool</span> longmode)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070     uint64_t <a class="code" href="namespaceX86ISA.html#aa3826b335948154c40c1b6a32cbd10f5">base</a> = desc.baseLow + (desc.baseHigh &lt;&lt; 24);
<a name="l00071"></a>00071     <span class="keywordtype">bool</span> honorBase = !longmode || seg == <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a4bc5f6023125cc809da4a11abb94053e">SEGMENT_REG_FS</a> ||
<a name="l00072"></a>00072                                   seg == <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a36eca17e44d76f310a507bb0cfea9a6d">SEGMENT_REG_GS</a> ||
<a name="l00073"></a>00073                                   seg == <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a2e563f335a9d535b5f9f6681afacbc64">SEGMENT_REG_TSL</a> ||
<a name="l00074"></a>00074                                   seg == SYS_SEGMENT_REG_TR;
<a name="l00075"></a>00075     uint64_t limit = desc.limitLow | (desc.limitHigh &lt;&lt; 16);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     SegAttr attr = 0;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     attr.dpl = desc.dpl;
<a name="l00080"></a>00080     attr.unusable = 0;
<a name="l00081"></a>00081     attr.defaultSize = desc.d;
<a name="l00082"></a>00082     attr.longMode = desc.l;
<a name="l00083"></a>00083     attr.avl = desc.avl;
<a name="l00084"></a>00084     attr.granularity = desc.g;
<a name="l00085"></a>00085     attr.present = desc.p;
<a name="l00086"></a>00086     attr.system = desc.s;
<a name="l00087"></a>00087     attr.type = desc.type;
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (desc.s) {
<a name="l00089"></a>00089         <span class="keywordflow">if</span> (desc.type.codeOrData) {
<a name="l00090"></a>00090             <span class="comment">// Code segment</span>
<a name="l00091"></a>00091             attr.expandDown = 0;
<a name="l00092"></a>00092             attr.readable = desc.type.r;
<a name="l00093"></a>00093             attr.writable = 0;
<a name="l00094"></a>00094         } <span class="keywordflow">else</span> {
<a name="l00095"></a>00095             <span class="comment">// Data segment</span>
<a name="l00096"></a>00096             attr.expandDown = desc.type.e;
<a name="l00097"></a>00097             attr.readable = 1;
<a name="l00098"></a>00098             attr.writable = desc.type.w;
<a name="l00099"></a>00099         }
<a name="l00100"></a>00100     } <span class="keywordflow">else</span> {
<a name="l00101"></a>00101         attr.readable = 1;
<a name="l00102"></a>00102         attr.writable = 1;
<a name="l00103"></a>00103         attr.expandDown = 0;
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#a310d36d3d8ec55a84d807cb7e1edf7d6">MISCREG_SEG_BASE</a>(seg), base);
<a name="l00107"></a>00107     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#a48969e78833727c474e77163559d3cc0">MISCREG_SEG_EFF_BASE</a>(seg), honorBase ? base : 0);
<a name="l00108"></a>00108     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af93c7fd7ac0d329975952ac0c2a97f98">MISCREG_SEG_LIMIT</a>(seg), limit);
<a name="l00109"></a>00109     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#abb8ec3742a54286da349c98a1a9c9755">MISCREG_SEG_ATTR</a>(seg), (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)attr);
<a name="l00110"></a>00110 }
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="keywordtype">void</span>
<a name="l00113"></a><a class="code" href="classX86System.html#ae3c3008e48f8121a0db0bfe803e114ea">00113</a> <a class="code" href="classX86System.html#ae3c3008e48f8121a0db0bfe803e114ea" title="Serialization stuff.">X86System::initState</a>()
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115     <a class="code" href="classX86System.html#ae3c3008e48f8121a0db0bfe803e114ea" title="Serialization stuff.">System::initState</a>();
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keywordflow">if</span> (!<a class="code" href="classSystem.html#ae35704171009f15c7b5490621fe3dda1" title="Object pointer for the kernel code.">kernel</a>)
<a name="l00118"></a>00118         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;No kernel to load.\n&quot;</span>);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (<a class="code" href="classSystem.html#ae35704171009f15c7b5490621fe3dda1" title="Object pointer for the kernel code.">kernel</a>-&gt;<a class="code" href="classObjectFile.html#a3fa0c59c8b9284ad5dd4ca8543f757ee">getArch</a>() == ObjectFile::I386)
<a name="l00121"></a>00121         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Loading a 32 bit x86 kernel is not supported.\n&quot;</span>);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside of the CPU...">ThreadContext</a> *tc = <a class="code" href="classSystem.html#aeed43dde330823c7fdee0ff1de6692a0">threadContexts</a>[0];
<a name="l00124"></a>00124     <span class="comment">// This is the boot strap processor (BSP). Initialize it to look like</span>
<a name="l00125"></a>00125     <span class="comment">// the boot loader has just turned control over to the 64 bit OS. We</span>
<a name="l00126"></a>00126     <span class="comment">// won&#39;t actually set up real mode or legacy protected mode descriptor</span>
<a name="l00127"></a>00127     <span class="comment">// tables because we aren&#39;t executing any code that would require</span>
<a name="l00128"></a>00128     <span class="comment">// them. We do, however toggle the control bits in the correct order</span>
<a name="l00129"></a>00129     <span class="comment">// while allowing consistency checks and the underlying mechansims</span>
<a name="l00130"></a>00130     <span class="comment">// just to be safe.</span>
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="keyword">const</span> <span class="keywordtype">int</span> NumPDTs = 4;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keyword">const</span> <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> PageMapLevel4 = 0x70000;
<a name="l00135"></a>00135     <span class="keyword">const</span> <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> PageDirPtrTable = 0x71000;
<a name="l00136"></a>00136     <span class="keyword">const</span> <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> PageDirTable[NumPDTs] =
<a name="l00137"></a>00137         {0x72000, 0x73000, 0x74000, 0x75000};
<a name="l00138"></a>00138     <span class="keyword">const</span> <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> GDTBase = 0x76000;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <span class="keyword">const</span> <span class="keywordtype">int</span> PML4Bits = 9;
<a name="l00141"></a>00141     <span class="keyword">const</span> <span class="keywordtype">int</span> PDPTBits = 9;
<a name="l00142"></a>00142     <span class="keyword">const</span> <span class="keywordtype">int</span> PDTBits = 9;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">/*</span>
<a name="l00145"></a>00145 <span class="comment">     * Set up the gdt.</span>
<a name="l00146"></a>00146 <span class="comment">     */</span>
<a name="l00147"></a>00147     uint8_t numGDTEntries = 0;
<a name="l00148"></a>00148     <span class="comment">// Place holder at selector 0</span>
<a name="l00149"></a>00149     uint64_t nullDescriptor = 0;
<a name="l00150"></a>00150     <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(GDTBase + numGDTEntries * 8,
<a name="l00151"></a>00151                         (uint8_t *)(&amp;nullDescriptor), 8);
<a name="l00152"></a>00152     numGDTEntries++;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="comment">//64 bit code segment</span>
<a name="l00155"></a>00155     SegDescriptor csDesc = 0;
<a name="l00156"></a>00156     csDesc.type.codeOrData = 1;
<a name="l00157"></a>00157     csDesc.type.c = 0; <span class="comment">// Not conforming</span>
<a name="l00158"></a>00158     csDesc.type.r = 1; <span class="comment">// Readable</span>
<a name="l00159"></a>00159     csDesc.dpl = 0; <span class="comment">// Privelege level 0</span>
<a name="l00160"></a>00160     csDesc.p = 1; <span class="comment">// Present</span>
<a name="l00161"></a>00161     csDesc.l = 1; <span class="comment">// 64 bit</span>
<a name="l00162"></a>00162     csDesc.d = 0; <span class="comment">// default operand size</span>
<a name="l00163"></a>00163     csDesc.g = 1; <span class="comment">// Page granularity</span>
<a name="l00164"></a>00164     csDesc.s = 1; <span class="comment">// Not a system segment</span>
<a name="l00165"></a>00165     csDesc.limitHigh = 0xF;
<a name="l00166"></a>00166     csDesc.limitLow = 0xFF;
<a name="l00167"></a>00167     <span class="comment">//Because we&#39;re dealing with a pointer and I don&#39;t think it&#39;s</span>
<a name="l00168"></a>00168     <span class="comment">//guaranteed that there isn&#39;t anything in a nonvirtual class between</span>
<a name="l00169"></a>00169     <span class="comment">//it&#39;s beginning in memory and it&#39;s actual data, we&#39;ll use an</span>
<a name="l00170"></a>00170     <span class="comment">//intermediary.</span>
<a name="l00171"></a>00171     uint64_t csDescVal = csDesc;
<a name="l00172"></a>00172     <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(GDTBase + numGDTEntries * 8,
<a name="l00173"></a>00173                         (uint8_t *)(&amp;csDescVal), 8);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     numGDTEntries++;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     SegSelector cs = 0;
<a name="l00178"></a>00178     cs.si = numGDTEntries - 1;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa8232de826765d81b6db037ff1699b613">MISCREG_CS</a>, (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)cs);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <span class="comment">//32 bit data segment</span>
<a name="l00183"></a>00183     SegDescriptor dsDesc = 0;
<a name="l00184"></a>00184     dsDesc.type.codeOrData = 0;
<a name="l00185"></a>00185     dsDesc.type.e = 0; <span class="comment">// Not expand down</span>
<a name="l00186"></a>00186     dsDesc.type.w = 1; <span class="comment">// Writable</span>
<a name="l00187"></a>00187     dsDesc.dpl = 0; <span class="comment">// Privelege level 0</span>
<a name="l00188"></a>00188     dsDesc.p = 1; <span class="comment">// Present</span>
<a name="l00189"></a>00189     dsDesc.d = 1; <span class="comment">// default operand size</span>
<a name="l00190"></a>00190     dsDesc.g = 1; <span class="comment">// Page granularity</span>
<a name="l00191"></a>00191     dsDesc.s = 1; <span class="comment">// Not a system segment</span>
<a name="l00192"></a>00192     dsDesc.limitHigh = 0xF;
<a name="l00193"></a>00193     dsDesc.limitLow = 0xFF;
<a name="l00194"></a>00194     uint64_t dsDescVal = dsDesc;
<a name="l00195"></a>00195     <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(GDTBase + numGDTEntries * 8,
<a name="l00196"></a>00196                         (uint8_t *)(&amp;dsDescVal), 8);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     numGDTEntries++;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     SegSelector <a class="code" href="namespaceMipsISA.html#af759a62a7aa431017a1a62fc14f4e14b">ds</a> = 0;
<a name="l00201"></a>00201     ds.si = numGDTEntries - 1;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa1f7851b8028b79dc54adf44fa21b8717">MISCREG_DS</a>, (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)ds);
<a name="l00204"></a>00204     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa995609a84476eb8f6746d9885f16612f">MISCREG_ES</a>, (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)ds);
<a name="l00205"></a>00205     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fae62b80312f6803c6e9881ba580856992">MISCREG_FS</a>, (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)ds);
<a name="l00206"></a>00206     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fab00d47d54de25b737c41c5347afa18fe">MISCREG_GS</a>, (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)ds);
<a name="l00207"></a>00207     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa8dd245c281a3325d44f4d261db7ffa58">MISCREG_SS</a>, (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)ds);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa8ee8ddf98a2f47f37d6d3c7a91a68ae7">MISCREG_TSL</a>, 0);
<a name="l00210"></a>00210     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa812fd46cf5265bea5b246cc85d194cd4">MISCREG_TSG_BASE</a>, GDTBase);
<a name="l00211"></a>00211     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799faa40e081dbe0f5654718fc41ad0dd049f">MISCREG_TSG_LIMIT</a>, 8 * numGDTEntries - 1);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     SegDescriptor tssDesc = 0;
<a name="l00214"></a>00214     tssDesc.type = 0xB;
<a name="l00215"></a>00215     tssDesc.dpl = 0; <span class="comment">// Privelege level 0</span>
<a name="l00216"></a>00216     tssDesc.p = 1; <span class="comment">// Present</span>
<a name="l00217"></a>00217     tssDesc.d = 1; <span class="comment">// default operand size</span>
<a name="l00218"></a>00218     tssDesc.g = 1; <span class="comment">// Page granularity</span>
<a name="l00219"></a>00219     tssDesc.s = 1; <span class="comment">// Not a system segment</span>
<a name="l00220"></a>00220     tssDesc.limitHigh = 0xF;
<a name="l00221"></a>00221     tssDesc.limitLow = 0xFF;
<a name="l00222"></a>00222     uint64_t tssDescVal = tssDesc;
<a name="l00223"></a>00223     <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(GDTBase + numGDTEntries * 8,
<a name="l00224"></a>00224                         (uint8_t *)(&amp;tssDescVal), 8);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     numGDTEntries++;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     SegSelector tss = 0;
<a name="l00229"></a>00229     tss.si = numGDTEntries - 1;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa597abff17cc7b64d3383d946754173ed">MISCREG_TR</a>, (<a class="code" href="namespaceX86ISA.html#a86cd714c5fb375add9dbe17911d85f22">MiscReg</a>)tss);
<a name="l00232"></a>00232     <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a8a8d2ce816e568531efa9e3f79e15749">SYS_SEGMENT_REG_TR</a>, tssDesc, <span class="keyword">true</span>);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="comment">/*</span>
<a name="l00235"></a>00235 <span class="comment">     * Identity map the first 4GB of memory. In order to map this region</span>
<a name="l00236"></a>00236 <span class="comment">     * of memory in long mode, there needs to be one actual page map level</span>
<a name="l00237"></a>00237 <span class="comment">     * 4 entry which points to one page directory pointer table which</span>
<a name="l00238"></a>00238 <span class="comment">     * points to 4 different page directory tables which are full of two</span>
<a name="l00239"></a>00239 <span class="comment">     * megabyte pages. All of the other entries in valid tables are set</span>
<a name="l00240"></a>00240 <span class="comment">     * to indicate that they don&#39;t pertain to anything valid and will</span>
<a name="l00241"></a>00241 <span class="comment">     * cause a fault if used.</span>
<a name="l00242"></a>00242 <span class="comment">     */</span>
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="comment">// Put valid values in all of the various table entries which indicate</span>
<a name="l00245"></a>00245     <span class="comment">// that those entries don&#39;t point to further tables or pages. Then</span>
<a name="l00246"></a>00246     <span class="comment">// set the values of those entries which are needed.</span>
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="comment">// Page Map Level 4</span>
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="comment">// read/write, user, not present</span>
<a name="l00251"></a>00251     uint64_t pml4e = <a class="code" href="namespaceBigEndianGuest.html#a10c3370b6af5a1216a2a64c0d379f788">X86ISA::htog</a>(0x6);
<a name="l00252"></a>00252     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a> = 0; <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a> &lt; (1 &lt;&lt; PML4Bits) * 8; <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a> += 8) {
<a name="l00253"></a>00253         <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(PageMapLevel4 + offset, (uint8_t *)(&amp;pml4e), 8);
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     <span class="comment">// Point to the only PDPT</span>
<a name="l00256"></a>00256     pml4e = <a class="code" href="namespaceBigEndianGuest.html#a10c3370b6af5a1216a2a64c0d379f788">X86ISA::htog</a>(0x7 | PageDirPtrTable);
<a name="l00257"></a>00257     <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(PageMapLevel4, (uint8_t *)(&amp;pml4e), 8);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">// Page Directory Pointer Table</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="comment">// read/write, user, not present</span>
<a name="l00262"></a>00262     uint64_t pdpe = <a class="code" href="namespaceBigEndianGuest.html#a10c3370b6af5a1216a2a64c0d379f788">X86ISA::htog</a>(0x6);
<a name="l00263"></a>00263     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> offset = 0; offset &lt; (1 &lt;&lt; PDPTBits) * 8; offset += 8) {
<a name="l00264"></a>00264         <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(PageDirPtrTable + offset,
<a name="l00265"></a>00265                             (uint8_t *)(&amp;pdpe), 8);
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267     <span class="comment">// Point to the PDTs</span>
<a name="l00268"></a>00268     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> table = 0; table &lt; NumPDTs; table++) {
<a name="l00269"></a>00269         pdpe = <a class="code" href="namespaceBigEndianGuest.html#a10c3370b6af5a1216a2a64c0d379f788">X86ISA::htog</a>(0x7 | PageDirTable[table]);
<a name="l00270"></a>00270         <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(PageDirPtrTable + table * 8,
<a name="l00271"></a>00271                             (uint8_t *)(&amp;pdpe), 8);
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="comment">// Page Directory Tables</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceX86ISA.html#aa3826b335948154c40c1b6a32cbd10f5">base</a> = 0;
<a name="l00277"></a>00277     <span class="keyword">const</span> <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> pageSize = 2 &lt;&lt; 20;
<a name="l00278"></a>00278     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> table = 0; table &lt; NumPDTs; table++) {
<a name="l00279"></a>00279         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> offset = 0; offset &lt; (1 &lt;&lt; PDTBits) * 8; offset += 8) {
<a name="l00280"></a>00280             <span class="comment">// read/write, user, present, 4MB</span>
<a name="l00281"></a>00281             uint64_t pdte = <a class="code" href="namespaceBigEndianGuest.html#a10c3370b6af5a1216a2a64c0d379f788">X86ISA::htog</a>(0x87 | base);
<a name="l00282"></a>00282             <a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>.<a class="code" href="classPortProxy.html#a1281955c0c58f330652c6e02ba72d97b" title="Write size bytes from p to address.">writeBlob</a>(PageDirTable[table] + offset,
<a name="l00283"></a>00283                                 (uint8_t *)(&amp;pdte), 8);
<a name="l00284"></a>00284             base += pageSize;
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="comment">/*</span>
<a name="l00289"></a>00289 <span class="comment">     * Transition from real mode all the way up to Long mode</span>
<a name="l00290"></a>00290 <span class="comment">     */</span>
<a name="l00291"></a>00291     CR0 cr0 = tc-&gt;<a class="code" href="classThreadContext.html#a1cdc204f9019a41bd6b82e542690e7cd">readMiscRegNoEffect</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799faa2602148c68da24e5e13446f6d165f1e">MISCREG_CR0</a>);
<a name="l00292"></a>00292     <span class="comment">//Turn off paging.</span>
<a name="l00293"></a>00293     cr0.pg = 0;
<a name="l00294"></a>00294     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799faa2602148c68da24e5e13446f6d165f1e">MISCREG_CR0</a>, cr0);
<a name="l00295"></a>00295     <span class="comment">//Turn on protected mode.</span>
<a name="l00296"></a>00296     cr0.pe = 1;
<a name="l00297"></a>00297     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799faa2602148c68da24e5e13446f6d165f1e">MISCREG_CR0</a>, cr0);
<a name="l00298"></a>00298 
<a name="l00299"></a>00299     CR4 cr4 = tc-&gt;<a class="code" href="classThreadContext.html#a1cdc204f9019a41bd6b82e542690e7cd">readMiscRegNoEffect</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa8e093dd535184ca05e4635d7777354c7">MISCREG_CR4</a>);
<a name="l00300"></a>00300     <span class="comment">//Turn on pae.</span>
<a name="l00301"></a>00301     cr4.pae = 1;
<a name="l00302"></a>00302     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa8e093dd535184ca05e4635d7777354c7">MISCREG_CR4</a>, cr4);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     <span class="comment">//Point to the page tables.</span>
<a name="l00305"></a>00305     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fa0fdd22dcd1166df277f7303e999ec14e">MISCREG_CR3</a>, PageMapLevel4);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     Efer efer = tc-&gt;<a class="code" href="classThreadContext.html#a1cdc204f9019a41bd6b82e542690e7cd">readMiscRegNoEffect</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fae1275bdf418a5469280923ab4e55aca3">MISCREG_EFER</a>);
<a name="l00308"></a>00308     <span class="comment">//Enable long mode.</span>
<a name="l00309"></a>00309     efer.lme = 1;
<a name="l00310"></a>00310     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799fae1275bdf418a5469280923ab4e55aca3">MISCREG_EFER</a>, efer);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     <span class="comment">//Start using longmode segments.</span>
<a name="l00313"></a>00313     <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a2a6f5ba1bac6e96104d1d526eac9ce51">SEGMENT_REG_CS</a>, csDesc, <span class="keyword">true</span>);
<a name="l00314"></a>00314     <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a87bcdc0b65d98b32655bcdb4b3c0da56">SEGMENT_REG_DS</a>, dsDesc, <span class="keyword">true</span>);
<a name="l00315"></a>00315     <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682aec9a81ccadce521fcfa555f3ee13e300">SEGMENT_REG_ES</a>, dsDesc, <span class="keyword">true</span>);
<a name="l00316"></a>00316     <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a4bc5f6023125cc809da4a11abb94053e">SEGMENT_REG_FS</a>, dsDesc, <span class="keyword">true</span>);
<a name="l00317"></a>00317     <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a36eca17e44d76f310a507bb0cfea9a6d">SEGMENT_REG_GS</a>, dsDesc, <span class="keyword">true</span>);
<a name="l00318"></a>00318     <a class="code" href="arch_2x86_2system_8cc.html#aec099bd6f3e3fbde886cc7122b44deda">installSegDesc</a>(tc, <a class="code" href="namespaceX86ISA.html#adcf3309de68236e70dea4c9e105e4682a08306ec4ab016be4899b8aab786245d8">SEGMENT_REG_SS</a>, dsDesc, <span class="keyword">true</span>);
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="comment">//Activate long mode.</span>
<a name="l00321"></a>00321     cr0.pg = 1;
<a name="l00322"></a>00322     tc-&gt;<a class="code" href="classThreadContext.html#a97455e30bf1a5a538971e03ecbb3ecde">setMiscReg</a>(<a class="code" href="namespaceX86ISA.html#af8ccd8de02dd5b6c8229d44bf5eb799faa2602148c68da24e5e13446f6d165f1e">MISCREG_CR0</a>, cr0);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     tc-&gt;<a class="code" href="classThreadContext.html#ab15f0db0e7c7afb40dfbbbd13d62dc2e">pcState</a>(tc-&gt;<a class="code" href="classThreadContext.html#a119dd28f703f77bafb74788f8110300c">getSystemPtr</a>()-&gt;<a class="code" href="classSystem.html#aa235315c10b08555718afbc2b41e2a15" title="Entry point in the kernel to start at.">kernelEntry</a>);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="comment">// We should now be in long mode. Yay!</span>
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> ebdaPos = 0xF0000;
<a name="l00329"></a>00329     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> fixed, table;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="comment">//Write out the SMBios/DMI table</span>
<a name="l00332"></a>00332     <a class="code" href="classX86System.html#abc66c2e4225cef0106c042a261cf4cb6">writeOutSMBiosTable</a>(ebdaPos, fixed, table);
<a name="l00333"></a>00333     ebdaPos += (fixed + table);
<a name="l00334"></a>00334     ebdaPos = <a class="code" href="intmath_8hh.html#a4d254a89b294890f6ce3a474f4e8c6c7">roundUp</a>(ebdaPos, 16);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="comment">//Write out the Intel MP Specification configuration table</span>
<a name="l00337"></a>00337     <a class="code" href="classX86System.html#a8e3043118edda31546803e8bfcc44c18">writeOutMPTable</a>(ebdaPos, fixed, table);
<a name="l00338"></a>00338     ebdaPos += (fixed + table);
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="keywordtype">void</span>
<a name="l00342"></a><a class="code" href="classX86System.html#abc66c2e4225cef0106c042a261cf4cb6">00342</a> <a class="code" href="classX86System.html#abc66c2e4225cef0106c042a261cf4cb6">X86System::writeOutSMBiosTable</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> header,
<a name="l00343"></a>00343         <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> &amp;headerSize, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> &amp;structSize, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> table)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     <span class="comment">// If the table location isn&#39;t specified, just put it after the header.</span>
<a name="l00346"></a>00346     <span class="comment">// The header size as of the 2.5 SMBios specification is 0x1F bytes</span>
<a name="l00347"></a>00347     <span class="keywordflow">if</span> (!table)
<a name="l00348"></a>00348         table = header + 0x1F;
<a name="l00349"></a>00349     <a class="code" href="classX86System.html#a90cc704f7188ff52210bddbf885783f5">smbiosTable</a>-&gt;<a class="code" href="classX86ISA_1_1SMBios_1_1SMBiosTable.html#a00ad4fc053952c77be31b51ca3bc9463">setTableAddr</a>(table);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <a class="code" href="classX86System.html#a90cc704f7188ff52210bddbf885783f5">smbiosTable</a>-&gt;<a class="code" href="classX86ISA_1_1SMBios_1_1SMBiosTable.html#ac11c72c230bd353d0fd029d77fa67bed">writeOut</a>(<a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>, header, headerSize, structSize);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="comment">// Do some bounds checking to make sure we at least didn&#39;t step on</span>
<a name="l00354"></a>00354     <span class="comment">// ourselves.</span>
<a name="l00355"></a>00355     assert(header &gt; table || header + headerSize &lt;= table);
<a name="l00356"></a>00356     assert(table &gt; header || table + structSize &lt;= header);
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="keywordtype">void</span>
<a name="l00360"></a><a class="code" href="classX86System.html#a8e3043118edda31546803e8bfcc44c18">00360</a> <a class="code" href="classX86System.html#a8e3043118edda31546803e8bfcc44c18">X86System::writeOutMPTable</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a56d5e501a666b1f5a3c76d7a7eb9ede3">fp</a>,
<a name="l00361"></a>00361         <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> &amp;fpSize, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> &amp;tableSize, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> table)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363     <span class="comment">// If the table location isn&#39;t specified and it exists, just put</span>
<a name="l00364"></a>00364     <span class="comment">// it after the floating pointer. The fp size as of the 1.4 Intel MP</span>
<a name="l00365"></a>00365     <span class="comment">// specification is 0x10 bytes.</span>
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (<a class="code" href="classX86System.html#a08d1555b5c4a1d8b66e0ac0876eb9a8a">mpConfigTable</a>) {
<a name="l00367"></a>00367         <span class="keywordflow">if</span> (!table)
<a name="l00368"></a>00368             table = fp + 0x10;
<a name="l00369"></a>00369         <a class="code" href="classX86System.html#afa26c762e1e36305169a3cd4670df2bd">mpFloatingPointer</a>-&gt;<a class="code" href="classX86ISA_1_1IntelMP_1_1FloatingPointer.html#a27dab77c16c01da11cf743e36ab9c850">setTableAddr</a>(table);
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     fpSize = <a class="code" href="classX86System.html#afa26c762e1e36305169a3cd4670df2bd">mpFloatingPointer</a>-&gt;<a class="code" href="classX86ISA_1_1IntelMP_1_1FloatingPointer.html#a845b131241c31076c4ea62f9f08d5cb9">writeOut</a>(<a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>, fp);
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (<a class="code" href="classX86System.html#a08d1555b5c4a1d8b66e0ac0876eb9a8a">mpConfigTable</a>)
<a name="l00374"></a>00374         tableSize = <a class="code" href="classX86System.html#a08d1555b5c4a1d8b66e0ac0876eb9a8a">mpConfigTable</a>-&gt;<a class="code" href="classX86ISA_1_1IntelMP_1_1ConfigTable.html#a28a57295f3ce350a62903d9aa221c5bf">writeOut</a>(<a class="code" href="classSystem.html#aaa1beaff32cd6384df02c2f5fbb4a0ea" title="Port to physical memory used for writing object files into ram at boot.">physProxy</a>, table);
<a name="l00375"></a>00375     <span class="keywordflow">else</span>
<a name="l00376"></a>00376         tableSize = 0;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     <span class="comment">// Do some bounds checking to make sure we at least didn&#39;t step on</span>
<a name="l00379"></a>00379     <span class="comment">// ourselves and the fp structure was the size we thought it was.</span>
<a name="l00380"></a>00380     assert(fp &gt; table || fp + fpSize &lt;= table);
<a name="l00381"></a>00381     assert(table &gt; fp || table + tableSize &lt;= fp);
<a name="l00382"></a>00382     assert(fpSize == 0x10);
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="classX86System.html#a8beb12774c4df8480c91502fa60cd007">00386</a> <a class="code" href="classX86System.html#a8beb12774c4df8480c91502fa60cd007">X86System::~X86System</a>()
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388     <span class="keyword">delete</span> <a class="code" href="classX86System.html#a90cc704f7188ff52210bddbf885783f5">smbiosTable</a>;
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <a class="code" href="classX86System.html">X86System</a> *
<a name="l00392"></a>00392 X86SystemParams::create()
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classX86System.html#afc6e97d2ed972b74b554451ae04179a0">X86System</a>(<span class="keyword">this</span>);
<a name="l00395"></a>00395 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Sun Apr 7 2013 18:15:46 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.7.1</small></address>

</body>
</html>
