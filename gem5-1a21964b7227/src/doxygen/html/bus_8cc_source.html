<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: mem/bus.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>mem/bus.cc</h1>  </div>
</div>
<div class="contents">
<a href="bus_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2011-2013 ARM Limited</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * The license below extends only to copyright in the software and shall</span>
<a name="l00006"></a>00006 <span class="comment"> * not be construed as granting a license to any other intellectual</span>
<a name="l00007"></a>00007 <span class="comment"> * property including but not limited to intellectual property relating</span>
<a name="l00008"></a>00008 <span class="comment"> * to a hardware implementation of the functionality of the software</span>
<a name="l00009"></a>00009 <span class="comment"> * licensed hereunder.  You may use the software subject to the license</span>
<a name="l00010"></a>00010 <span class="comment"> * terms below provided that you ensure that this notice is replicated</span>
<a name="l00011"></a>00011 <span class="comment"> * unmodified and in its entirety in all distributions of the software,</span>
<a name="l00012"></a>00012 <span class="comment"> * modified or unmodified, in source code or in binary form.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * Copyright (c) 2006 The Regents of The University of Michigan</span>
<a name="l00015"></a>00015 <span class="comment"> * All rights reserved.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00018"></a>00018 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00019"></a>00019 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00020"></a>00020 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00021"></a>00021 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00022"></a>00022 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00023"></a>00023 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00024"></a>00024 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00025"></a>00025 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00026"></a>00026 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00029"></a>00029 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00030"></a>00030 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00031"></a>00031 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00032"></a>00032 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00033"></a>00033 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00034"></a>00034 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00035"></a>00035 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00036"></a>00036 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00038"></a>00038 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> * Authors: Ali Saidi</span>
<a name="l00041"></a>00041 <span class="comment"> *          Andreas Hansson</span>
<a name="l00042"></a>00042 <span class="comment"> *          William Wang</span>
<a name="l00043"></a>00043 <span class="comment"> */</span>
<a name="l00044"></a>00044 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="base_2misc_8hh.html">base/misc.hh</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="trace_8hh.html">base/trace.hh</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;debug/Bus.hh&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;debug/BusAddrRanges.hh&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;debug/Drain.hh&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="bus_8hh.html" title="Declaration of an abstract bus base class.">mem/bus.hh</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="classBaseBus.html#a278397858b7df4c3e184e695c73a5a4e">00057</a> <a class="code" href="classBaseBus.html#a278397858b7df4c3e184e695c73a5a4e">BaseBus::BaseBus</a>(<span class="keyword">const</span> BaseBusParams *<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>)
<a name="l00058"></a>00058     : <a class="code" href="classMemObject.html" title="The MemObject class extends the ClockedObject with accessor functions to get its master and slave por...">MemObject</a>(p),
<a name="l00059"></a>00059       headerCycles(p-&gt;header_cycles), width(p-&gt;width),
<a name="l00060"></a>00060       gotAddrRanges(p-&gt;port_default_connection_count +
<a name="l00061"></a>00061                           p-&gt;port_master_connection_count, false),
<a name="l00062"></a>00062       gotAllAddrRanges(false), defaultPortID(<a class="code" href="base_2types_8hh.html#a65bf40f138cf863f0c5e2d8ca1144126">InvalidPortID</a>),
<a name="l00063"></a>00063       useDefaultRange(p-&gt;use_default_range),
<a name="l00064"></a>00064       blockSize(p-&gt;block_size)
<a name="l00065"></a>00065 {}
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="classBaseBus.html#ac406607e80ed1d18c5d7da02ee3de26b">00067</a> <a class="code" href="classBaseBus.html#ac406607e80ed1d18c5d7da02ee3de26b">BaseBus::~BaseBus</a>()
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069     <span class="keywordflow">for</span> (<a class="code" href="classBaseBus.html#a21526f174730320beef6cb707cbd2f8a">MasterPortIter</a> <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a> = <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>.begin(); <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a> != <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>.end();
<a name="l00070"></a>00070          ++<a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a>) {
<a name="l00071"></a>00071         <span class="keyword">delete</span> *<a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a>;
<a name="l00072"></a>00072     }
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="keywordflow">for</span> (<a class="code" href="classBaseBus.html#a874e9cc499fe41a8fa1b53081bb9f6a5" title="Convenience typedefs.">SlavePortIter</a> <a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a> = <a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>.begin(); <a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a> != <a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>.end();
<a name="l00075"></a>00075          ++<a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a>) {
<a name="l00076"></a>00076         <span class="keyword">delete</span> *<a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a>;
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="keywordtype">void</span>
<a name="l00081"></a><a class="code" href="classBaseBus.html#a7832f2360a15567eccf057345f7d22e5">00081</a> <a class="code" href="classBaseBus.html#a7832f2360a15567eccf057345f7d22e5" title="init() is called after all C++ SimObjects have been created and all ports are connected.">BaseBus::init</a>()
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083     <span class="comment">// determine the maximum peer block size, look at both the</span>
<a name="l00084"></a>00084     <span class="comment">// connected master and slave modules</span>
<a name="l00085"></a>00085     <a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> peer_block_size = 0;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     <span class="keywordflow">for</span> (<a class="code" href="classBaseBus.html#ad7ee39c82ad0805529f638eaa1af9be2">MasterPortConstIter</a> <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a> = <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>.begin(); <a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a> != <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>.end();
<a name="l00088"></a>00088          ++<a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a>) {
<a name="l00089"></a>00089         peer_block_size = std::max((*m)-&gt;peerBlockSize(), peer_block_size);
<a name="l00090"></a>00090     }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="keywordflow">for</span> (<a class="code" href="classBaseBus.html#ac07d836f1db7b7c4eca65419a8405c00">SlavePortConstIter</a> <a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a> = <a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>.begin(); <a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a> != <a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>.end();
<a name="l00093"></a>00093          ++<a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a>) {
<a name="l00094"></a>00094         peer_block_size = std::max((*s)-&gt;peerBlockSize(), peer_block_size);
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="comment">// if the peers do not have a block size, use the default value</span>
<a name="l00098"></a>00098     <span class="comment">// set through the bus parameters</span>
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (peer_block_size != 0)
<a name="l00100"></a>00100         <a class="code" href="classBaseBus.html#a6eb437dd93e7ab9e2937c8d526807468">blockSize</a> = peer_block_size;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="comment">// check if the block size is a value known to work</span>
<a name="l00103"></a>00103     <span class="keywordflow">if</span> (!(<a class="code" href="classBaseBus.html#a6eb437dd93e7ab9e2937c8d526807468">blockSize</a> == 16 || <a class="code" href="classBaseBus.html#a6eb437dd93e7ab9e2937c8d526807468">blockSize</a> == 32 || <a class="code" href="classBaseBus.html#a6eb437dd93e7ab9e2937c8d526807468">blockSize</a> == 64 ||
<a name="l00104"></a>00104           <a class="code" href="classBaseBus.html#a6eb437dd93e7ab9e2937c8d526807468">blockSize</a> == 128))
<a name="l00105"></a>00105         <a class="code" href="base_2misc_8hh.html#abb243c15dfbeedf4ae64aa213f4f18c7">warn_once</a>(<span class="stringliteral">&quot;Block size is neither 16, 32, 64 or 128 bytes.\n&quot;</span>);
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <a class="code" href="classBaseMasterPort.html" title="A BaseMasterPort is a protocol-agnostic master port, responsible only for the structural connection t...">BaseMasterPort</a> &amp;
<a name="l00109"></a><a class="code" href="classBaseBus.html#ad2e670f2b229ca3d2fa116a976e0e29b">00109</a> <a class="code" href="classBaseBus.html#ad2e670f2b229ca3d2fa116a976e0e29b" title="A function used to return the port associated with this bus object.">BaseBus::getMasterPort</a>(<span class="keyword">const</span> std::string &amp;if_name, <a class="code" href="base_2types_8hh.html#acef4d7d41cb21fdc252e20c04cd7bb8e" title="Port index/ID type, and a symbolic name for an invalid port id.">PortID</a> idx)
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111     <span class="keywordflow">if</span> (if_name == <span class="stringliteral">&quot;master&quot;</span> &amp;&amp; idx &lt; <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>.size()) {
<a name="l00112"></a>00112         <span class="comment">// the master port index translates directly to the vector position</span>
<a name="l00113"></a>00113         <span class="keywordflow">return</span> *<a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>[idx];
<a name="l00114"></a>00114     } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (if_name == <span class="stringliteral">&quot;default&quot;</span>) {
<a name="l00115"></a>00115         <span class="keywordflow">return</span> *<a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>[<a class="code" href="classBaseBus.html#a1abe9ff1bd388d3defe19d161a569af7" title="Port that handles requests that don&amp;#39;t match any of the interfaces.">defaultPortID</a>];
<a name="l00116"></a>00116     } <span class="keywordflow">else</span> {
<a name="l00117"></a>00117         <span class="keywordflow">return</span> <a class="code" href="classBaseBus.html#ad2e670f2b229ca3d2fa116a976e0e29b" title="A function used to return the port associated with this bus object.">MemObject::getMasterPort</a>(if_name, idx);
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <a class="code" href="classBaseSlavePort.html" title="A BaseSlavePort is a protocol-agnostic slave port, responsible only for the structural connection to ...">BaseSlavePort</a> &amp;
<a name="l00122"></a><a class="code" href="classBaseBus.html#af9b1a48f0f714485f60ef81b63eaea5c">00122</a> <a class="code" href="classBaseBus.html#af9b1a48f0f714485f60ef81b63eaea5c" title="Get a slave port with a given name and index.">BaseBus::getSlavePort</a>(<span class="keyword">const</span> std::string &amp;if_name, <a class="code" href="base_2types_8hh.html#acef4d7d41cb21fdc252e20c04cd7bb8e" title="Port index/ID type, and a symbolic name for an invalid port id.">PortID</a> idx)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <span class="keywordflow">if</span> (if_name == <span class="stringliteral">&quot;slave&quot;</span> &amp;&amp; idx &lt; <a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>.size()) {
<a name="l00125"></a>00125         <span class="comment">// the slave port index translates directly to the vector position</span>
<a name="l00126"></a>00126         <span class="keywordflow">return</span> *<a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>[idx];
<a name="l00127"></a>00127     } <span class="keywordflow">else</span> {
<a name="l00128"></a>00128         <span class="keywordflow">return</span> <a class="code" href="classBaseBus.html#af9b1a48f0f714485f60ef81b63eaea5c" title="Get a slave port with a given name and index.">MemObject::getSlavePort</a>(if_name, idx);
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="keywordtype">void</span>
<a name="l00133"></a><a class="code" href="classBaseBus.html#a153ff3da7562c68041e2213f636ea6db">00133</a> <a class="code" href="classBaseBus.html#a153ff3da7562c68041e2213f636ea6db" title="Calculate the timing parameters for the packet.">BaseBus::calcPacketTiming</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system (e...">PacketPtr</a> pkt)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135     <span class="comment">// the bus will be called at a time that is not necessarily</span>
<a name="l00136"></a>00136     <span class="comment">// coinciding with its own clock, so start by determining how long</span>
<a name="l00137"></a>00137     <span class="comment">// until the next clock edge (could be zero)</span>
<a name="l00138"></a>00138     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a> = <a class="code" href="classClockedObject.html#afeec54486c377fa6d0825f9d24d64ab3" title="Based on the clock of the object, determine the tick when the next cycle begins, in other words...">nextCycle</a>() - <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <span class="comment">// determine how many cycles are needed to send the data</span>
<a name="l00141"></a>00141     <span class="keywordtype">unsigned</span> dataCycles = pkt-&gt;<a class="code" href="classPacket.html#a9f23402c9a7438f2edab83d028f58d3b">hasData</a>() ? <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>(), <a class="code" href="classBaseBus.html#ab0fed0741b41e613d783f60d27ad4b75" title="the width of the bus in bytes">width</a>) : 0;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="comment">// before setting the bus delay fields of the packet, ensure that</span>
<a name="l00144"></a>00144     <span class="comment">// the delay from any previous bus has been accounted for</span>
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="classPacket.html#a72da3f227887b6d8d316421c92a27108" title="The extra delay from seeing the packet until the first word is transmitted by the bus that provided i...">busFirstWordDelay</a> != 0 || pkt-&gt;<a class="code" href="classPacket.html#a1630a79f0fc7ddf0ee957f23ec25dfde" title="The extra delay from seeing the packet until the last word is transmitted by the bus that provided it...">busLastWordDelay</a> != 0)
<a name="l00146"></a>00146         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Packet %s already has bus delay (%d, %d) that should be &quot;</span>
<a name="l00147"></a>00147               <span class="stringliteral">&quot;accounted for.\n&quot;</span>, pkt-&gt;<a class="code" href="classPacket.html#a50fa8e54b8b71b0d6879307680517697" title="Return the string name of the cmd field (for debugging and tracing).">cmdString</a>(), pkt-&gt;<a class="code" href="classPacket.html#a72da3f227887b6d8d316421c92a27108" title="The extra delay from seeing the packet until the first word is transmitted by the bus that provided i...">busFirstWordDelay</a>,
<a name="l00148"></a>00148               pkt-&gt;<a class="code" href="classPacket.html#a1630a79f0fc7ddf0ee957f23ec25dfde" title="The extra delay from seeing the packet until the last word is transmitted by the bus that provided it...">busLastWordDelay</a>);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">// The first word will be delivered on the cycle after the header.</span>
<a name="l00151"></a>00151     pkt-&gt;<a class="code" href="classPacket.html#a72da3f227887b6d8d316421c92a27108" title="The extra delay from seeing the packet until the first word is transmitted by the bus that provided i...">busFirstWordDelay</a> = (<a class="code" href="classBaseBus.html#a798757135dd084f75b93b7a9c389e889" title="cycles of overhead per transaction">headerCycles</a> + 1) * <a class="code" href="classClockedObject.html#a3f0850d695e3722cdd7d33bbaf3e5f43">clockPeriod</a>() + offset;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="comment">// Note that currently busLastWordDelay can be smaller than</span>
<a name="l00154"></a>00154     <span class="comment">// busFirstWordDelay if the packet has no data</span>
<a name="l00155"></a>00155     pkt-&gt;<a class="code" href="classPacket.html#a1630a79f0fc7ddf0ee957f23ec25dfde" title="The extra delay from seeing the packet until the last word is transmitted by the bus that provided it...">busLastWordDelay</a> = (<a class="code" href="classBaseBus.html#a798757135dd084f75b93b7a9c389e889" title="cycles of overhead per transaction">headerCycles</a> + dataCycles) * <a class="code" href="classClockedObject.html#a3f0850d695e3722cdd7d33bbaf3e5f43">clockPeriod</a>() +
<a name="l00156"></a>00156         offset;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00160"></a><a class="code" href="classBaseBus_1_1Layer.html#a035951c7c563b8eb06660eb2bf03083f">00160</a> <a class="code" href="classBaseBus_1_1Layer.html#a035951c7c563b8eb06660eb2bf03083f" title="Create a bus layer and give it a name.">BaseBus::Layer&lt;PortClass&gt;::Layer</a>(<a class="code" href="classBaseBus.html" title="The base bus contains the common elements of the non-coherent and coherent bus.">BaseBus</a>&amp; _bus, <span class="keyword">const</span> std::string&amp; _name) :
<a name="l00161"></a>00161     <a class="code" href="classDrainable.html" title="Interface for objects that might require draining before checkpointing.">Drainable</a>(),
<a name="l00162"></a>00162     bus(_bus), _name(_name), state(IDLE), drainManager(NULL),
<a name="l00163"></a>00163     releaseEvent(this)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00168"></a><a class="code" href="classBaseBus_1_1Layer.html#aeddfe27c898747bbb9a844226fbeb30e">00168</a> <span class="keywordtype">void</span> <a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;PortClass&gt;::occupyLayer</a>(<a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> until)
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170     <span class="comment">// ensure the state is busy or in retry and never idle at this</span>
<a name="l00171"></a>00171     <span class="comment">// point, as the bus should transition from idle as soon as it has</span>
<a name="l00172"></a>00172     <span class="comment">// decided to forward the packet to prevent any follow-on calls to</span>
<a name="l00173"></a>00173     <span class="comment">// sendTiming seeing an unoccupied bus</span>
<a name="l00174"></a>00174     assert(<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> != <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea385f63a8de84d7c8377abc42827173bf">IDLE</a>);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="comment">// note that we do not change the bus state here, if we are going</span>
<a name="l00177"></a>00177     <span class="comment">// from idle to busy it is handled by tryTiming, and if we</span>
<a name="l00178"></a>00178     <span class="comment">// are in retry we should remain in retry such that</span>
<a name="l00179"></a>00179     <span class="comment">// succeededTiming still sees the accurate state</span>
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="comment">// until should never be 0 as express snoops never occupy the bus</span>
<a name="l00182"></a>00182     assert(until != 0);
<a name="l00183"></a>00183     <a class="code" href="classBaseBus_1_1Layer.html#af741a2bf64542bdbb1cd74c3604106bb" title="The bus this layer is a part of.">bus</a>.<a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classBaseBus_1_1Layer.html#a74dcdfd93fa9dafaf72c6623ea744d35" title="event used to schedule a release of the layer">releaseEvent</a>, until);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classBaseBus.html" title="The base bus contains the common elements of the non-coherent and coherent bus.">BaseBus</a>, <span class="stringliteral">&quot;The bus is now busy from tick %d to %d\n&quot;</span>,
<a name="l00186"></a>00186             <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>(), until);
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00190"></a>00190 <span class="keywordtype">bool</span>
<a name="l00191"></a><a class="code" href="classBaseBus_1_1Layer.html#ae79f7322120c9c9ea28a78256c80635d">00191</a> <a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;PortClass&gt;::tryTiming</a>(PortClass* port)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <span class="comment">// first we see if the bus is busy, next we check if we are in a</span>
<a name="l00194"></a>00194     <span class="comment">// retry with a port other than the current one</span>
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7eab9f1c78c525fd42013d5e76f6af583c4">BUSY</a> || (<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea1b7506b9feae7917ac48e5efa428a192">RETRY</a> &amp;&amp; port != <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.front())) {
<a name="l00196"></a>00196         <span class="comment">// put the port at the end of the retry list</span>
<a name="l00197"></a>00197         <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.push_back(port);
<a name="l00198"></a>00198         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="comment">// update the state which is shared for request, response and</span>
<a name="l00202"></a>00202     <span class="comment">// snoop responses, if we were idle we are now busy, if we are in</span>
<a name="l00203"></a>00203     <span class="comment">// a retry, then do not change</span>
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea385f63a8de84d7c8377abc42827173bf">IDLE</a>)
<a name="l00205"></a>00205         <a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> = BUSY;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00211"></a>00211 <span class="keywordtype">void</span>
<a name="l00212"></a><a class="code" href="classBaseBus_1_1Layer.html#aedf35a1aef57ed0c4a8bf2dac11f9671">00212</a> <a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;PortClass&gt;::succeededTiming</a>(<a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> busy_time)
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214     <span class="comment">// if a retrying port succeeded, also take it off the retry list</span>
<a name="l00215"></a>00215     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea1b7506b9feae7917ac48e5efa428a192">RETRY</a>) {
<a name="l00216"></a>00216         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classBaseBus.html" title="The base bus contains the common elements of the non-coherent and coherent bus.">BaseBus</a>, <span class="stringliteral">&quot;Remove retry from list %s\n&quot;</span>,
<a name="l00217"></a>00217                 <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.front()-&gt;name());
<a name="l00218"></a>00218         <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.pop_front();
<a name="l00219"></a>00219         <a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> = BUSY;
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment">// we should either have gone from idle to busy in the</span>
<a name="l00223"></a>00223     <span class="comment">// tryTiming test, or just gone from a retry to busy</span>
<a name="l00224"></a>00224     assert(<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7eab9f1c78c525fd42013d5e76f6af583c4">BUSY</a>);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">// occupy the bus accordingly</span>
<a name="l00227"></a>00227     <a class="code" href="classBaseBus_1_1Layer.html#aeddfe27c898747bbb9a844226fbeb30e" title="Occupy the bus layer until until.">occupyLayer</a>(busy_time);
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00231"></a>00231 <span class="keywordtype">void</span>
<a name="l00232"></a><a class="code" href="classBaseBus_1_1Layer.html#ae9bc4e9649aea64d91a8b62e930561d9">00232</a> <a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;PortClass&gt;::failedTiming</a>(PortClass* port, <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> busy_time)
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234     <span class="comment">// if we are not in a retry, i.e. busy (but never idle), or we are</span>
<a name="l00235"></a>00235     <span class="comment">// in a retry but not for the current port, then add the port at</span>
<a name="l00236"></a>00236     <span class="comment">// the end of the retry list</span>
<a name="l00237"></a>00237     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> != <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea1b7506b9feae7917ac48e5efa428a192">RETRY</a> || port != <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.front()) {
<a name="l00238"></a>00238         <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.push_back(port);
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <span class="comment">// even if we retried the current one and did not succeed,</span>
<a name="l00242"></a>00242     <span class="comment">// we are no longer retrying but instead busy</span>
<a name="l00243"></a>00243     <a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> = BUSY;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <span class="comment">// occupy the bus accordingly</span>
<a name="l00246"></a>00246     <a class="code" href="classBaseBus_1_1Layer.html#aeddfe27c898747bbb9a844226fbeb30e" title="Occupy the bus layer until until.">occupyLayer</a>(busy_time);
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00250"></a>00250 <span class="keywordtype">void</span>
<a name="l00251"></a><a class="code" href="classBaseBus_1_1Layer.html#a05fc3ca444ae273cc2dae70643236d81">00251</a> <a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;PortClass&gt;::releaseLayer</a>()
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     <span class="comment">// releasing the bus means we should now be idle</span>
<a name="l00254"></a>00254     assert(<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7eab9f1c78c525fd42013d5e76f6af583c4">BUSY</a>);
<a name="l00255"></a>00255     assert(!<a class="code" href="classBaseBus_1_1Layer.html#a74dcdfd93fa9dafaf72c6623ea744d35" title="event used to schedule a release of the layer">releaseEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="comment">// update the state</span>
<a name="l00258"></a>00258     <a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> = IDLE;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="comment">// bus is now idle, so if someone is waiting we can retry</span>
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (!<a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.empty()) {
<a name="l00262"></a>00262         <span class="comment">// note that we block (return false on recvTiming) both</span>
<a name="l00263"></a>00263         <span class="comment">// because the bus is busy and because the destination is</span>
<a name="l00264"></a>00264         <span class="comment">// busy, and in the latter case the bus may be released before</span>
<a name="l00265"></a>00265         <span class="comment">// we see a retry from the destination</span>
<a name="l00266"></a>00266         <a class="code" href="classBaseBus_1_1Layer.html#a163fea8370a2e85a247d26ce3f958054" title="Send a retry to the port at the head of the retryList.">retryWaiting</a>();
<a name="l00267"></a>00267     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a04b762a3c9438c2389d88d9aaaded0e9" title="manager to signal when drained">drainManager</a>) {
<a name="l00268"></a>00268         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Drain, <span class="stringliteral">&quot;Bus done draining, signaling drain manager\n&quot;</span>);
<a name="l00269"></a>00269         <span class="comment">//If we weren&#39;t able to drain before, do it now.</span>
<a name="l00270"></a>00270         <a class="code" href="classBaseBus_1_1Layer.html#a04b762a3c9438c2389d88d9aaaded0e9" title="manager to signal when drained">drainManager</a>-&gt;<a class="code" href="classDrainManager.html#abd134e8277be09e702b63f36f6ee31d0" title="Notify the DrainManager that a Drainable object has finished draining.">signalDrainDone</a>();
<a name="l00271"></a>00271         <span class="comment">// Clear the drain event once we&#39;re done with it.</span>
<a name="l00272"></a>00272         <a class="code" href="classBaseBus_1_1Layer.html#a04b762a3c9438c2389d88d9aaaded0e9" title="manager to signal when drained">drainManager</a> = NULL;
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00277"></a>00277 <span class="keywordtype">void</span>
<a name="l00278"></a><a class="code" href="classBaseBus_1_1Layer.html#a163fea8370a2e85a247d26ce3f958054">00278</a> <a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;PortClass&gt;::retryWaiting</a>()
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280     <span class="comment">// this should never be called with an empty retry list</span>
<a name="l00281"></a>00281     assert(!<a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.empty());
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="comment">// we always go to retrying from idle</span>
<a name="l00284"></a>00284     assert(<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea385f63a8de84d7c8377abc42827173bf">IDLE</a>);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// update the state which is shared for request, response and</span>
<a name="l00287"></a>00287     <span class="comment">// snoop responses</span>
<a name="l00288"></a>00288     <a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> = RETRY;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">// note that we might have blocked on the receiving port being</span>
<a name="l00291"></a>00291     <span class="comment">// busy (rather than the bus itself) and now call retry before the</span>
<a name="l00292"></a>00292     <span class="comment">// destination called retry on the bus</span>
<a name="l00293"></a>00293     <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.front()-&gt;sendRetry();
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     <span class="comment">// If the bus is still in the retry state, sendTiming wasn&#39;t</span>
<a name="l00296"></a>00296     <span class="comment">// called in zero time (e.g. the cache does this)</span>
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea1b7506b9feae7917ac48e5efa428a192">RETRY</a>) {
<a name="l00298"></a>00298         <a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.pop_front();
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="comment">//Burn a cycle for the missed grant.</span>
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         <span class="comment">// update the state which is shared for request, response and</span>
<a name="l00303"></a>00303         <span class="comment">// snoop responses</span>
<a name="l00304"></a>00304         <a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> = BUSY;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         <span class="comment">// occupy the bus layer until the next cycle ends</span>
<a name="l00307"></a>00307         <a class="code" href="classBaseBus_1_1Layer.html#aeddfe27c898747bbb9a844226fbeb30e" title="Occupy the bus layer until until.">occupyLayer</a>(<a class="code" href="classBaseBus_1_1Layer.html#af741a2bf64542bdbb1cd74c3604106bb" title="The bus this layer is a part of.">bus</a>.<a class="code" href="classClockedObject.html#a7c1f64c925f158530be84323a503dbb7" title="Determine the tick when a cycle begins, by default the current one, but the argument also enables the...">clockEdge</a>(<a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1)));
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00312"></a>00312 <span class="keywordtype">void</span>
<a name="l00313"></a><a class="code" href="classBaseBus_1_1Layer.html#aae90c86a793cbf67eed3847e654736b4">00313</a> <a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;PortClass&gt;::recvRetry</a>()
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315     <span class="comment">// we got a retry from a peer that we tried to send something to</span>
<a name="l00316"></a>00316     <span class="comment">// and failed, but we sent it on the account of someone else, and</span>
<a name="l00317"></a>00317     <span class="comment">// that source port should be on our retry list, however if the</span>
<a name="l00318"></a>00318     <span class="comment">// bus layer is released before this happens and the retry (from</span>
<a name="l00319"></a>00319     <span class="comment">// the bus point of view) is successful then this no longer holds</span>
<a name="l00320"></a>00320     <span class="comment">// and we could in fact have an empty retry list</span>
<a name="l00321"></a>00321     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.empty())
<a name="l00322"></a>00322         <span class="keywordflow">return</span>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <span class="comment">// if the bus layer is idle</span>
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> == <a class="code" href="classBaseBus_1_1Layer.html#a65ff7c4fb4781d5ea63e09458f728c7ea385f63a8de84d7c8377abc42827173bf">IDLE</a>) {
<a name="l00326"></a>00326         <span class="comment">// note that we do not care who told us to retry at the moment, we</span>
<a name="l00327"></a>00327         <span class="comment">// merely let the first one on the retry list go</span>
<a name="l00328"></a>00328         <a class="code" href="classBaseBus_1_1Layer.html#a163fea8370a2e85a247d26ce3f958054" title="Send a retry to the port at the head of the retryList.">retryWaiting</a>();
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <a class="code" href="base_2types_8hh.html#acef4d7d41cb21fdc252e20c04cd7bb8e" title="Port index/ID type, and a symbolic name for an invalid port id.">PortID</a>
<a name="l00333"></a><a class="code" href="classBaseBus.html#aefad5d7ae58d363841b55bb42ecc2aaf">00333</a> <a class="code" href="classBaseBus.html#aefad5d7ae58d363841b55bb42ecc2aaf" title="Find which port connected to this bus (if any) should be given a packet with this address...">BaseBus::findPort</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceX86ISA.html#a79b5c08c190167d17c9b9b3fd40112f6">addr</a>)
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335     <span class="comment">// we should never see any address lookups before we&#39;ve got the</span>
<a name="l00336"></a>00336     <span class="comment">// ranges of all connected slave modules</span>
<a name="l00337"></a>00337     assert(<a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a>);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="comment">// Check the cache</span>
<a name="l00340"></a>00340     <a class="code" href="base_2types_8hh.html#acef4d7d41cb21fdc252e20c04cd7bb8e" title="Port index/ID type, and a symbolic name for an invalid port id.">PortID</a> dest_id = <a class="code" href="classBaseBus.html#a438eb07a3a94b8b3729add2934ab60a0">checkPortCache</a>(addr);
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (dest_id != <a class="code" href="base_2types_8hh.html#a65bf40f138cf863f0c5e2d8ca1144126">InvalidPortID</a>)
<a name="l00342"></a>00342         <span class="keywordflow">return</span> dest_id;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="comment">// Check the address map interval tree</span>
<a name="l00345"></a>00345     <a class="code" href="classBaseBus.html#af3da67d0c195e60889a991915afbcc09">PortMapConstIter</a> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#a8bc6ae7f986debf8b073c3fddb0bf1b5">find</a>(addr);
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (i != <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#ac471bee6c67d52c75a6578e73187b298">end</a>()) {
<a name="l00347"></a>00347         dest_id = i-&gt;second;
<a name="l00348"></a>00348         <a class="code" href="classBaseBus.html#ab99e5914ab59e36c4ff608607bcb6d88">updatePortCache</a>(dest_id, i-&gt;first);
<a name="l00349"></a>00349         <span class="keywordflow">return</span> dest_id;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="comment">// Check if this matches the default range</span>
<a name="l00353"></a>00353     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a4f2dabd2f8fe46f4e5743c9d5543c3cc" title="If true, use address range provided by default device.">useDefaultRange</a>) {
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>.<a class="code" href="classAddrRange.html#a425758158128be6e402ae66825b78bcb" title="Determine if the range contains an address.">contains</a>(addr)) {
<a name="l00355"></a>00355             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;  found addr %#llx on default\n&quot;</span>,
<a name="l00356"></a>00356                     addr);
<a name="l00357"></a>00357             <span class="keywordflow">return</span> <a class="code" href="classBaseBus.html#a1abe9ff1bd388d3defe19d161a569af7" title="Port that handles requests that don&amp;#39;t match any of the interfaces.">defaultPortID</a>;
<a name="l00358"></a>00358         }
<a name="l00359"></a>00359     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a1abe9ff1bd388d3defe19d161a569af7" title="Port that handles requests that don&amp;#39;t match any of the interfaces.">defaultPortID</a> != <a class="code" href="base_2types_8hh.html#a65bf40f138cf863f0c5e2d8ca1144126">InvalidPortID</a>) {
<a name="l00360"></a>00360         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;Unable to find destination for addr %#llx, &quot;</span>
<a name="l00361"></a>00361                 <span class="stringliteral">&quot;will use default port\n&quot;</span>, addr);
<a name="l00362"></a>00362         <span class="keywordflow">return</span> <a class="code" href="classBaseBus.html#a1abe9ff1bd388d3defe19d161a569af7" title="Port that handles requests that don&amp;#39;t match any of the interfaces.">defaultPortID</a>;
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="comment">// we should use the range for the default port and it did not</span>
<a name="l00366"></a>00366     <span class="comment">// match, or the default port is not set</span>
<a name="l00367"></a>00367     <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Unable to find destination for addr %#llx on bus %s\n&quot;</span>, addr,
<a name="l00368"></a>00368           <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 
<a name="l00372"></a>00372 <span class="keywordtype">void</span>
<a name="l00373"></a><a class="code" href="classBaseBus.html#a88b2c8908820c59362dca5e173360322">00373</a> <a class="code" href="classBaseBus.html#a88b2c8908820c59362dca5e173360322" title="Function called by the port when the bus is recieving a range change.">BaseBus::recvRangeChange</a>(<a class="code" href="base_2types_8hh.html#acef4d7d41cb21fdc252e20c04cd7bb8e" title="Port index/ID type, and a symbolic name for an invalid port id.">PortID</a> master_port_id)
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;Received range change from slave port %s\n&quot;</span>,
<a name="l00376"></a>00376             <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>[master_port_id]-&gt;<a class="code" href="classBaseBus.html#af9b1a48f0f714485f60ef81b63eaea5c" title="Get a slave port with a given name and index.">getSlavePort</a>().<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     <span class="comment">// remember that we got a range from this master port and thus the</span>
<a name="l00379"></a>00379     <span class="comment">// connected slave module</span>
<a name="l00380"></a>00380     <a class="code" href="classBaseBus.html#a6ffbd336a7afc35a1d96ea708aa9d410" title="Remember for each of the master ports of the bus if we got an address range from the connected slave...">gotAddrRanges</a>[master_port_id] = <span class="keyword">true</span>;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="comment">// update the global flag</span>
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (!<a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a>) {
<a name="l00384"></a>00384         <span class="comment">// take a logical AND of all the ports and see if we got</span>
<a name="l00385"></a>00385         <span class="comment">// ranges from everyone</span>
<a name="l00386"></a>00386         <a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a> = <span class="keyword">true</span>;
<a name="l00387"></a>00387         <a class="code" href="classstd_1_1vector.html" title="STL vector class.">std::vector&lt;bool&gt;::const_iterator</a> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> = <a class="code" href="classBaseBus.html#a6ffbd336a7afc35a1d96ea708aa9d410" title="Remember for each of the master ports of the bus if we got an address range from the connected slave...">gotAddrRanges</a>.begin();
<a name="l00388"></a>00388         <span class="keywordflow">while</span> (<a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a> &amp;&amp;  r != <a class="code" href="classBaseBus.html#a6ffbd336a7afc35a1d96ea708aa9d410" title="Remember for each of the master ports of the bus if we got an address range from the connected slave...">gotAddrRanges</a>.end()) {
<a name="l00389"></a>00389             <a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a> &amp;= *r++;
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391         <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a>)
<a name="l00392"></a>00392             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;Got address ranges from all slaves\n&quot;</span>);
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="comment">// note that we could get the range from the default port at any</span>
<a name="l00396"></a>00396     <span class="comment">// point in time, and we cannot assume that the default range is</span>
<a name="l00397"></a>00397     <span class="comment">// set before the other ones are, so we do additional checks once</span>
<a name="l00398"></a>00398     <span class="comment">// all ranges are provided</span>
<a name="l00399"></a>00399     <span class="keywordflow">if</span> (master_port_id == <a class="code" href="classBaseBus.html#a1abe9ff1bd388d3defe19d161a569af7" title="Port that handles requests that don&amp;#39;t match any of the interfaces.">defaultPortID</a>) {
<a name="l00400"></a>00400         <span class="comment">// only update if we are indeed checking ranges for the</span>
<a name="l00401"></a>00401         <span class="comment">// default port since the port might not have a valid range</span>
<a name="l00402"></a>00402         <span class="comment">// otherwise</span>
<a name="l00403"></a>00403         <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a4f2dabd2f8fe46f4e5743c9d5543c3cc" title="If true, use address range provided by default device.">useDefaultRange</a>) {
<a name="l00404"></a>00404             <a class="code" href="classstd_1_1list.html">AddrRangeList</a> ranges = <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>[master_port_id]-&gt;getAddrRanges();
<a name="l00405"></a>00405 
<a name="l00406"></a>00406             <span class="keywordflow">if</span> (ranges.size() != 1)
<a name="l00407"></a>00407                 <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Bus %s may only have a single default range&quot;</span>,
<a name="l00408"></a>00408                       <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00409"></a>00409 
<a name="l00410"></a>00410             <a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a> = ranges.front();
<a name="l00411"></a>00411         }
<a name="l00412"></a>00412     } <span class="keywordflow">else</span> {
<a name="l00413"></a>00413         <span class="comment">// the ports are allowed to update their address ranges</span>
<a name="l00414"></a>00414         <span class="comment">// dynamically, so remove any existing entries</span>
<a name="l00415"></a>00415         <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a6ffbd336a7afc35a1d96ea708aa9d410" title="Remember for each of the master ports of the bus if we got an address range from the connected slave...">gotAddrRanges</a>[master_port_id]) {
<a name="l00416"></a>00416             <span class="keywordflow">for</span> (<a class="code" href="classBaseBus.html#acb98aaf86a1902ba1c3567c7405dd870">PortMapIter</a> <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a> = <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#adcb247ed52b88a60a0a1489e2a1ee008">begin</a>(); <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a> != <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#ac471bee6c67d52c75a6578e73187b298">end</a>(); ) {
<a name="l00417"></a>00417                 <span class="keywordflow">if</span> (<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>-&gt;second == master_port_id)
<a name="l00418"></a>00418                     <span class="comment">// erasing invalidates the iterator, so advance it</span>
<a name="l00419"></a>00419                     <span class="comment">// before the deletion takes place</span>
<a name="l00420"></a>00420                     <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#aeb361e26da54ea30e6cf0843943c3de5">erase</a>(<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>++);
<a name="l00421"></a>00421                 <span class="keywordflow">else</span>
<a name="l00422"></a>00422                     <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>++;
<a name="l00423"></a>00423             }
<a name="l00424"></a>00424         }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         <a class="code" href="classstd_1_1list.html">AddrRangeList</a> ranges = <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>[master_port_id]-&gt;getAddrRanges();
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         <span class="keywordflow">for</span> (<a class="code" href="port_8hh.html#a0f4385f0a7bf93ed2e39e1a630b291b0">AddrRangeConstIter</a> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> = ranges.begin(); <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> != ranges.end(); ++<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>) {
<a name="l00429"></a>00429             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;Adding range %s for id %d\n&quot;</span>,
<a name="l00430"></a>00430                     <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;to_string(), master_port_id);
<a name="l00431"></a>00431             <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#a3a020d7d5be3ead4b8b57634f0182bdc">insert</a>(*<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>, master_port_id) == <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#ac471bee6c67d52c75a6578e73187b298">end</a>()) {
<a name="l00432"></a>00432                 <a class="code" href="base_2types_8hh.html#acef4d7d41cb21fdc252e20c04cd7bb8e" title="Port index/ID type, and a symbolic name for an invalid port id.">PortID</a> conflict_id = <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#a8bc6ae7f986debf8b073c3fddb0bf1b5">find</a>(*r)-&gt;second;
<a name="l00433"></a>00433                 <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;%s has two ports with same range:\n\t%s\n\t%s\n&quot;</span>,
<a name="l00434"></a>00434                       <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>(),
<a name="l00435"></a>00435                       <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>[master_port_id]-&gt;<a class="code" href="classBaseBus.html#af9b1a48f0f714485f60ef81b63eaea5c" title="Get a slave port with a given name and index.">getSlavePort</a>().<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>(),
<a name="l00436"></a>00436                       <a class="code" href="classBaseBus.html#a72f54451d62eaa83c9afff8d924e6a0d">masterPorts</a>[conflict_id]-&gt;<a class="code" href="classBaseBus.html#af9b1a48f0f714485f60ef81b63eaea5c" title="Get a slave port with a given name and index.">getSlavePort</a>().<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00437"></a>00437             }
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="comment">// if we have received ranges from all our neighbouring slave</span>
<a name="l00442"></a>00442     <span class="comment">// modules, go ahead and tell our connected master modules in</span>
<a name="l00443"></a>00443     <span class="comment">// turn, this effectively assumes a tree structure of the system</span>
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a>) {
<a name="l00445"></a>00445         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;Aggregating bus ranges\n&quot;</span>);
<a name="l00446"></a>00446         <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>.clear();
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         <span class="comment">// start out with the default range</span>
<a name="l00449"></a>00449         <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a4f2dabd2f8fe46f4e5743c9d5543c3cc" title="If true, use address range provided by default device.">useDefaultRange</a>) {
<a name="l00450"></a>00450             <span class="keywordflow">if</span> (!<a class="code" href="classBaseBus.html#a6ffbd336a7afc35a1d96ea708aa9d410" title="Remember for each of the master ports of the bus if we got an address range from the connected slave...">gotAddrRanges</a>[<a class="code" href="classBaseBus.html#a1abe9ff1bd388d3defe19d161a569af7" title="Port that handles requests that don&amp;#39;t match any of the interfaces.">defaultPortID</a>])
<a name="l00451"></a>00451                 <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Bus %s uses default range, but none provided&quot;</span>,
<a name="l00452"></a>00452                       <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00453"></a>00453 
<a name="l00454"></a>00454             <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>.push_back(<a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>);
<a name="l00455"></a>00455             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;-- Adding default %s\n&quot;</span>,
<a name="l00456"></a>00456                     <a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>.<a class="code" href="classAddrRange.html#ac60e568168f2ce5d1a39573c44c6be57" title="Get a string representation of the range.">to_string</a>());
<a name="l00457"></a>00457         }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         <span class="comment">// merge all interleaved ranges and add any range that is not</span>
<a name="l00460"></a>00460         <span class="comment">// a subset of the default range</span>
<a name="l00461"></a>00461         <a class="code" href="classstd_1_1vector.html">std::vector&lt;AddrRange&gt;</a> intlv_ranges;
<a name="l00462"></a>00462         <span class="keywordflow">for</span> (<a class="code" href="classAddrRangeMap.html" title="The AddrRangeMap uses an STL map to implement an interval tree for address decoding.">AddrRangeMap&lt;PortID&gt;::const_iterator</a> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> = <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#adcb247ed52b88a60a0a1489e2a1ee008">begin</a>();
<a name="l00463"></a>00463              <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> != <a class="code" href="classBaseBus.html#a0997bab8f4dd1ff9d64e0284454969c0">portMap</a>.<a class="code" href="classAddrRangeMap.html#ac471bee6c67d52c75a6578e73187b298">end</a>(); ++<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>) {
<a name="l00464"></a>00464             <span class="comment">// if the range is interleaved then save it for now</span>
<a name="l00465"></a>00465             <span class="keywordflow">if</span> (<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;first.interleaved()) {
<a name="l00466"></a>00466                 <span class="comment">// if we already got interleaved ranges that are not</span>
<a name="l00467"></a>00467                 <span class="comment">// part of the same range, then first do a merge</span>
<a name="l00468"></a>00468                 <span class="comment">// before we add the new one</span>
<a name="l00469"></a>00469                 <span class="keywordflow">if</span> (!intlv_ranges.empty() &amp;&amp;
<a name="l00470"></a>00470                     !intlv_ranges.back().mergesWith(<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;first)) {
<a name="l00471"></a>00471                     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;-- Merging range from %d ranges\n&quot;</span>,
<a name="l00472"></a>00472                             intlv_ranges.size());
<a name="l00473"></a>00473                     <a class="code" href="classAddrRange.html">AddrRange</a> merged_range(intlv_ranges);
<a name="l00474"></a>00474                     <span class="comment">// next decide if we keep the merged range or not</span>
<a name="l00475"></a>00475                     <span class="keywordflow">if</span> (!(<a class="code" href="classBaseBus.html#a4f2dabd2f8fe46f4e5743c9d5543c3cc" title="If true, use address range provided by default device.">useDefaultRange</a> &amp;&amp;
<a name="l00476"></a>00476                           merged_range.isSubset(<a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>))) {
<a name="l00477"></a>00477                         <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>.push_back(merged_range);
<a name="l00478"></a>00478                         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;-- Adding merged range %s\n&quot;</span>,
<a name="l00479"></a>00479                                 merged_range.to_string());
<a name="l00480"></a>00480                     }
<a name="l00481"></a>00481                     intlv_ranges.clear();
<a name="l00482"></a>00482                 }
<a name="l00483"></a>00483                 intlv_ranges.push_back(<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;first);
<a name="l00484"></a>00484             } <span class="keywordflow">else</span> {
<a name="l00485"></a>00485                 <span class="comment">// keep the current range if not a subset of the default</span>
<a name="l00486"></a>00486                 <span class="keywordflow">if</span> (!(<a class="code" href="classBaseBus.html#a4f2dabd2f8fe46f4e5743c9d5543c3cc" title="If true, use address range provided by default device.">useDefaultRange</a> &amp;&amp;
<a name="l00487"></a>00487                       <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;first.isSubset(<a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>))) {
<a name="l00488"></a>00488                     <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>.push_back(<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;first);
<a name="l00489"></a>00489                     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;-- Adding range %s\n&quot;</span>,
<a name="l00490"></a>00490                             <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;first.to_string());
<a name="l00491"></a>00491                 }
<a name="l00492"></a>00492             }
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         <span class="comment">// if there is still interleaved ranges waiting to be merged,</span>
<a name="l00496"></a>00496         <span class="comment">// go ahead and do it</span>
<a name="l00497"></a>00497         <span class="keywordflow">if</span> (!intlv_ranges.empty()) {
<a name="l00498"></a>00498             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;-- Merging range from %d ranges\n&quot;</span>,
<a name="l00499"></a>00499                     intlv_ranges.size());
<a name="l00500"></a>00500             <a class="code" href="classAddrRange.html">AddrRange</a> merged_range(intlv_ranges);
<a name="l00501"></a>00501             <span class="keywordflow">if</span> (!(<a class="code" href="classBaseBus.html#a4f2dabd2f8fe46f4e5743c9d5543c3cc" title="If true, use address range provided by default device.">useDefaultRange</a> &amp;&amp; merged_range.isSubset(<a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>))) {
<a name="l00502"></a>00502                 <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>.push_back(merged_range);
<a name="l00503"></a>00503                 <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;-- Adding merged range %s\n&quot;</span>,
<a name="l00504"></a>00504                         merged_range.to_string());
<a name="l00505"></a>00505             }
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="comment">// also check that no range partially overlaps with the</span>
<a name="l00509"></a>00509         <span class="comment">// default range, this has to be done after all ranges are set</span>
<a name="l00510"></a>00510         <span class="comment">// as there are no guarantees for when the default range is</span>
<a name="l00511"></a>00511         <span class="comment">// update with respect to the other ones</span>
<a name="l00512"></a>00512         <span class="keywordflow">if</span> (<a class="code" href="classBaseBus.html#a4f2dabd2f8fe46f4e5743c9d5543c3cc" title="If true, use address range provided by default device.">useDefaultRange</a>) {
<a name="l00513"></a>00513             <span class="keywordflow">for</span> (<a class="code" href="port_8hh.html#a0f4385f0a7bf93ed2e39e1a630b291b0">AddrRangeConstIter</a> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> = <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>.begin();
<a name="l00514"></a>00514                  <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> != <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>.end(); ++<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>) {
<a name="l00515"></a>00515                 <span class="comment">// see if the new range is partially</span>
<a name="l00516"></a>00516                 <span class="comment">// overlapping the default range</span>
<a name="l00517"></a>00517                 <span class="keywordflow">if</span> (<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;intersects(<a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>) &amp;&amp;
<a name="l00518"></a>00518                     !<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;isSubset(<a class="code" href="classBaseBus.html#a8294a3f19d034a6c9b0d1e64f3d2ecb3">defaultRange</a>))
<a name="l00519"></a>00519                     <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Range %s intersects the &quot;</span>                    \
<a name="l00520"></a>00520                           <span class="stringliteral">&quot;default range of %s but is not a &quot;</span>           \
<a name="l00521"></a>00521                           <span class="stringliteral">&quot;subset\n&quot;</span>, <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;to_string(), <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00522"></a>00522             }
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="comment">// tell all our neighbouring master ports that our address</span>
<a name="l00526"></a>00526         <span class="comment">// ranges have changed</span>
<a name="l00527"></a>00527         <span class="keywordflow">for</span> (<a class="code" href="classBaseBus.html#ac07d836f1db7b7c4eca65419a8405c00">SlavePortConstIter</a> <a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a> = <a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>.begin(); <a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a> != <a class="code" href="classBaseBus.html#ac6bead1b2e33370b98f078143357396c" title="The master and slave ports of the bus.">slavePorts</a>.end();
<a name="l00528"></a>00528              ++<a class="code" href="namespaceMipsISA.html#a36d11894e85e86352c6a5ddfd624fc7a">s</a>)
<a name="l00529"></a>00529             (*s)-&gt;sendRangeChange();
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <a class="code" href="classBaseBus.html#a9bbff67c0884af38a214216de290bdbc">clearPortCache</a>();
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <a class="code" href="classstd_1_1list.html">AddrRangeList</a>
<a name="l00536"></a><a class="code" href="classBaseBus.html#afe815f8116ce7cd388fe64afcd071916">00536</a> <a class="code" href="classBaseBus.html#afe815f8116ce7cd388fe64afcd071916" title="Return the address ranges the bus is responsible for.">BaseBus::getAddrRanges</a>()<span class="keyword"> const</span>
<a name="l00537"></a>00537 <span class="keyword"></span>{
<a name="l00538"></a>00538     <span class="comment">// we should never be asked without first having sent a range</span>
<a name="l00539"></a>00539     <span class="comment">// change, and the latter is only done once we have all the ranges</span>
<a name="l00540"></a>00540     <span class="comment">// of the connected devices</span>
<a name="l00541"></a>00541     assert(<a class="code" href="classBaseBus.html#a116edb10c035e8ff963a6251e81bf414">gotAllAddrRanges</a>);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="comment">// at the moment, this never happens, as there are no cycles in</span>
<a name="l00544"></a>00544     <span class="comment">// the range queries and no devices on the master side of a bus</span>
<a name="l00545"></a>00545     <span class="comment">// (CPU, cache, bridge etc) actually care about the ranges of the</span>
<a name="l00546"></a>00546     <span class="comment">// ports they are connected to</span>
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(BusAddrRanges, <span class="stringliteral">&quot;Received address range request\n&quot;</span>);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550     <span class="keywordflow">return</span> <a class="code" href="classBaseBus.html#a97a025ecf3da72d91c3d9a397090222a" title="all contigous ranges seen by this bus">busRanges</a>;
<a name="l00551"></a>00551 }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 <span class="keywordtype">unsigned</span>
<a name="l00554"></a><a class="code" href="classBaseBus.html#aa243701c009f7867963ecf3fb0d202cc">00554</a> <a class="code" href="classBaseBus.html#aa243701c009f7867963ecf3fb0d202cc" title="Ask everyone on the bus what their size is and determine the bus size as either the maximum...">BaseBus::deviceBlockSize</a>()<span class="keyword"> const</span>
<a name="l00555"></a>00555 <span class="keyword"></span>{
<a name="l00556"></a>00556     <span class="keywordflow">return</span> <a class="code" href="classBaseBus.html#a6eb437dd93e7ab9e2937c8d526807468">blockSize</a>;
<a name="l00557"></a>00557 }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PortClass&gt;
<a name="l00560"></a>00560 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00561"></a><a class="code" href="classBaseBus_1_1Layer.html#ae2614a07bc2fffb4d85c048702fa5b3a">00561</a> <a class="code" href="classBaseBus_1_1Layer.html#ae2614a07bc2fffb4d85c048702fa5b3a" title="Drain according to the normal semantics, so that the bus can tell the layer to drain, and pass an event to signal back when drained.">BaseBus::Layer&lt;PortClass&gt;::drain</a>(<a class="code" href="classDrainManager.html" title="This class coordinates draining of a System.">DrainManager</a> *<a class="code" href="namespaceMipsISA.html#afed89bf85db8c823833a4921f0b24ac8">dm</a>)
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563     <span class="comment">//We should check that we&#39;re not &quot;doing&quot; anything, and that noone is</span>
<a name="l00564"></a>00564     <span class="comment">//waiting. We might be idle but have someone waiting if the device we</span>
<a name="l00565"></a>00565     <span class="comment">//contacted for a retry didn&#39;t actually retry.</span>
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (!<a class="code" href="classBaseBus_1_1Layer.html#a94ea8ebf3bd08ff9372e9ee21ec9a5e5" title="An array of ports that retry should be called on because the original send failed for whatever reason...">retryList</a>.empty() || <a class="code" href="classBaseBus_1_1Layer.html#a5aedf8bbb41c5f6890a0f61cc5dc01e4" title="track the state of the bus layer">state</a> != IDLE) {
<a name="l00567"></a>00567         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Drain, <span class="stringliteral">&quot;Bus not drained\n&quot;</span>);
<a name="l00568"></a>00568         <a class="code" href="classBaseBus_1_1Layer.html#a04b762a3c9438c2389d88d9aaaded0e9" title="manager to signal when drained">drainManager</a> = dm;
<a name="l00569"></a>00569         <span class="keywordflow">return</span> 1;
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571     <span class="keywordflow">return</span> 0;
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00579"></a>00579 <span class="keyword">template</span> <span class="keyword">class </span><a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;SlavePort&gt;</a>;
<a name="l00580"></a>00580 <span class="keyword">template</span> <span class="keyword">class </span><a class="code" href="classBaseBus_1_1Layer.html" title="A bus layer is an internal bus structure with its own flow control and arbitration.">BaseBus::Layer&lt;MasterPort&gt;</a>;
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Sun Apr 7 2013 18:16:40 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.7.1</small></address>

</body>
</html>
