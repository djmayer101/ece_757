<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: dev/sinic.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>dev/sinic.cc</h1>  </div>
</div>
<div class="contents">
<a href="sinic_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2004-2005 The Regents of The University of Michigan</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00006"></a>00006 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00007"></a>00007 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00008"></a>00008 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00009"></a>00009 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00010"></a>00010 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00011"></a>00011 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00012"></a>00012 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00013"></a>00013 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00014"></a>00014 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00017"></a>00017 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00018"></a>00018 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00019"></a>00019 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00020"></a>00020 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00021"></a>00021 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00022"></a>00022 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00023"></a>00023 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00024"></a>00024 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00025"></a>00025 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00026"></a>00026 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * Authors: Nathan Binkert</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;deque&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;limits&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;arch/vtophys.hh&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="compiler_8hh.html">base/compiler.hh</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="base_2debug_8hh.html">base/debug.hh</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="inet_8hh.html">base/inet.hh</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="base_2types_8hh.html" title="Defines global host-dependent types: Counter, Tick, and (indirectly) {int,uint}{8,16,32,64}_t.">base/types.hh</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;config/the_isa.hh&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="intr__control_8hh.html">cpu/intr_control.hh</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="thread__context_8hh.html">cpu/thread_context.hh</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;debug/EthernetAll.hh&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="etherlink_8hh.html">dev/etherlink.hh</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="sinic_8hh.html">dev/sinic.hh</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="packet_8hh.html" title="Declaration of the Packet class.">mem/packet.hh</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="packet__access_8hh.html">mem/packet_access.hh</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="eventq_8hh.html">sim/eventq.hh</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="stats_8hh.html">sim/stats.hh</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">using namespace </span>std;
<a name="l00052"></a>00052 <span class="keyword">using namespace </span>Net;
<a name="l00053"></a>00053 <span class="keyword">using namespace </span>TheISA;
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="namespaceSinic.html">00055</a> <span class="keyword">namespace </span>Sinic {
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">00057</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[] =
<a name="l00058"></a>00058 {
<a name="l00059"></a>00059     <span class="stringliteral">&quot;rxIdle&quot;</span>,
<a name="l00060"></a>00060     <span class="stringliteral">&quot;rxFifoBlock&quot;</span>,
<a name="l00061"></a>00061     <span class="stringliteral">&quot;rxBeginCopy&quot;</span>,
<a name="l00062"></a>00062     <span class="stringliteral">&quot;rxCopy&quot;</span>,
<a name="l00063"></a>00063     <span class="stringliteral">&quot;rxCopyDone&quot;</span>
<a name="l00064"></a>00064 };
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="namespaceSinic.html#a79dc43034393462f74e022169469e7d2">00066</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="namespaceSinic.html#a79dc43034393462f74e022169469e7d2">TxStateStrings</a>[] =
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     <span class="stringliteral">&quot;txIdle&quot;</span>,
<a name="l00069"></a>00069     <span class="stringliteral">&quot;txFifoBlock&quot;</span>,
<a name="l00070"></a>00070     <span class="stringliteral">&quot;txBeginCopy&quot;</span>,
<a name="l00071"></a>00071     <span class="stringliteral">&quot;txCopy&quot;</span>,
<a name="l00072"></a>00072     <span class="stringliteral">&quot;txCopyDone&quot;</span>
<a name="l00073"></a>00073 };
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 
<a name="l00077"></a>00077 <span class="comment">//</span>
<a name="l00078"></a>00078 <span class="comment">// Sinic PCI Device</span>
<a name="l00079"></a>00079 <span class="comment">//</span>
<a name="l00080"></a><a class="code" href="classSinic_1_1Base.html#abf5d7582a5b7f1ac025aca081ab116be">00080</a> Base::Base(<span class="keyword">const</span> <a class="code" href="classDmaDevice.html#ac7bbaf5193e605eb9e8fd3491a131e95">Params</a> *<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>)
<a name="l00081"></a>00081     : <a class="code" href="classEtherDevBase.html" title="Dummy class to keep the Python class hierarchy in sync with the C++ object hierarchy.">EtherDevBase</a>(p), rxEnable(false), txEnable(false),
<a name="l00082"></a>00082       intrDelay(p-&gt;intr_delay), intrTick(0), cpuIntrEnable(false),
<a name="l00083"></a>00083       cpuPendingIntr(false), intrEvent(0), interface(NULL)
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="classSinic_1_1Device.html#ac26c275c96a501f66102a346897b4728">00087</a> <a class="code" href="classSinic_1_1Device.html#ac26c275c96a501f66102a346897b4728">Device::Device</a>(<span class="keyword">const</span> <a class="code" href="classDmaDevice.html#ac7bbaf5193e605eb9e8fd3491a131e95">Params</a> *<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>)
<a name="l00088"></a>00088     : <a class="code" href="classSinic_1_1Base.html">Base</a>(p), rxUnique(0), txUnique(0),
<a name="l00089"></a>00089       virtualRegs(p-&gt;virtual_count &lt; 1 ? 1 : p-&gt;virtual_count),
<a name="l00090"></a>00090       rxFifo(p-&gt;rx_fifo_size), txFifo(p-&gt;tx_fifo_size),
<a name="l00091"></a>00091       rxKickTick(0), txKickTick(0),
<a name="l00092"></a>00092       txEvent(this), rxDmaEvent(this), txDmaEvent(this),
<a name="l00093"></a>00093       dmaReadDelay(p-&gt;dma_read_delay), dmaReadFactor(p-&gt;dma_read_factor),
<a name="l00094"></a>00094       dmaWriteDelay(p-&gt;dma_write_delay), dmaWriteFactor(p-&gt;dma_write_factor)
<a name="l00095"></a>00095 {
<a name="l00096"></a>00096     <a class="code" href="classSinic_1_1Base.html#a8c4580dbdec1abfdbcb82573e49a3dcf">interface</a> = <span class="keyword">new</span> <a class="code" href="classSinic_1_1Interface.html">Interface</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.int0&quot;</span>, <span class="keyword">this</span>);
<a name="l00097"></a>00097     <a class="code" href="classSinic_1_1Device.html#ad67d7883b3f6e10f009921c7b3a504cf">reset</a>();
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="classSinic_1_1Device.html#a6b7655482a344b5e99e7a1e5cfa9c603">00101</a> <a class="code" href="classSinic_1_1Device.html#a6b7655482a344b5e99e7a1e5cfa9c603">Device::~Device</a>()
<a name="l00102"></a>00102 {}
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="keywordtype">void</span>
<a name="l00105"></a><a class="code" href="classSinic_1_1Device.html#a216cff7026983ccb79cb9bbafef11ec6">00105</a> <a class="code" href="classSinic_1_1Device.html#a216cff7026983ccb79cb9bbafef11ec6" title="Register statistics for this object.">Device::regStats</a>()
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107     <a class="code" href="classSinic_1_1Device.html#a216cff7026983ccb79cb9bbafef11ec6" title="Register statistics for this object.">Base::regStats</a>();
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <a class="code" href="classSinic_1_1Device.html#a3da2f3bb12aa7874db945bd0a40f8b9b">_maxVnicDistance</a> = 0;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <a class="code" href="classSinic_1_1Device.html#a916329d6c1b58db9b295a16c1b173428">maxVnicDistance</a>
<a name="l00112"></a>00112         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.maxVnicDistance&quot;</span>)
<a name="l00113"></a>00113         .desc(<span class="stringliteral">&quot;maximum vnic distance&quot;</span>)
<a name="l00114"></a>00114         ;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <a class="code" href="classSinic_1_1Device.html#ad8d2bcbd116501735ab8963427d285c4" title="Statistics.">totalVnicDistance</a>
<a name="l00117"></a>00117         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.totalVnicDistance&quot;</span>)
<a name="l00118"></a>00118         .desc(<span class="stringliteral">&quot;total vnic distance&quot;</span>)
<a name="l00119"></a>00119         ;
<a name="l00120"></a>00120     <a class="code" href="classSinic_1_1Device.html#af4e2aeaff168d298b3eedfb0e302a71d">numVnicDistance</a>
<a name="l00121"></a>00121         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.numVnicDistance&quot;</span>)
<a name="l00122"></a>00122         .desc(<span class="stringliteral">&quot;number of vnic distance measurements&quot;</span>)
<a name="l00123"></a>00123         ;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <a class="code" href="classSinic_1_1Device.html#a06af002b99965bbeb9d3f42ae06b611e">avgVnicDistance</a>
<a name="l00126"></a>00126         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgVnicDistance&quot;</span>)
<a name="l00127"></a>00127         .desc(<span class="stringliteral">&quot;average vnic distance&quot;</span>)
<a name="l00128"></a>00128         ;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <a class="code" href="classSinic_1_1Device.html#a06af002b99965bbeb9d3f42ae06b611e">avgVnicDistance</a> = <a class="code" href="classSinic_1_1Device.html#ad8d2bcbd116501735ab8963427d285c4" title="Statistics.">totalVnicDistance</a> / <a class="code" href="classSinic_1_1Device.html#af4e2aeaff168d298b3eedfb0e302a71d">numVnicDistance</a>;
<a name="l00131"></a>00131 }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="keywordtype">void</span>
<a name="l00134"></a><a class="code" href="classSinic_1_1Device.html#ab198d4f8c3a46cfa4fe8524c4e5b02bd">00134</a> <a class="code" href="classSinic_1_1Device.html#ab198d4f8c3a46cfa4fe8524c4e5b02bd" title="Reset statistics associated with this object.">Device::resetStats</a>()
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     <a class="code" href="classSinic_1_1Device.html#ab198d4f8c3a46cfa4fe8524c4e5b02bd" title="Reset statistics associated with this object.">Base::resetStats</a>();
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <a class="code" href="classSinic_1_1Device.html#a3da2f3bb12aa7874db945bd0a40f8b9b">_maxVnicDistance</a> = 0;
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <a class="code" href="classEtherInt.html">EtherInt</a>*
<a name="l00142"></a><a class="code" href="classSinic_1_1Device.html#ac04df87b5a9d5871ab4dea60e518e8c6">00142</a> <a class="code" href="classSinic_1_1Device.html#ac04df87b5a9d5871ab4dea60e518e8c6" title="Additional function to return the Port of a memory object.">Device::getEthPort</a>(<span class="keyword">const</span> std::string &amp;if_name, <span class="keywordtype">int</span> idx)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (if_name == <span class="stringliteral">&quot;interface&quot;</span>) {
<a name="l00145"></a>00145         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a8c4580dbdec1abfdbcb82573e49a3dcf">interface</a>-&gt;<a class="code" href="classEtherInt.html#a98c02fdff5a81c539ca2c98f186473a9">getPeer</a>())
<a name="l00146"></a>00146             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;interface already connected to\n&quot;</span>);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <span class="keywordflow">return</span> <a class="code" href="classSinic_1_1Base.html#a8c4580dbdec1abfdbcb82573e49a3dcf">interface</a>;
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150     <span class="keywordflow">return</span> NULL;
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="keywordtype">void</span>
<a name="l00155"></a><a class="code" href="classSinic_1_1Device.html#a0ab0817b161e71cccb34c7f14ed10bda">00155</a> <a class="code" href="classSinic_1_1Device.html#a0ab0817b161e71cccb34c7f14ed10bda">Device::prepareIO</a>(<span class="keywordtype">int</span> cpu, <span class="keywordtype">int</span> <a class="code" href="namespaceMipsISA.html#aeeb2c1446acc9f3e056faacf09c36f7a">index</a>)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157     <span class="keywordtype">int</span> size = <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.size();
<a name="l00158"></a>00158     <span class="keywordflow">if</span> (index &gt; size)
<a name="l00159"></a>00159         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Trying to access a vnic that doesn&#39;t exist %d &gt; %d\n&quot;</span>,
<a name="l00160"></a>00160               index, size);
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">//add stats for head of line blocking</span>
<a name="l00164"></a>00164 <span class="comment">//add stats for average fifo length</span>
<a name="l00165"></a>00165 <span class="comment">//add stats for average number of vnics busy</span>
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 <span class="keywordtype">void</span>
<a name="l00168"></a><a class="code" href="classSinic_1_1Device.html#a5ba9a3551e90d2b29e4131ada6661b82">00168</a> <a class="code" href="classSinic_1_1Device.html#a5ba9a3551e90d2b29e4131ada6661b82">Device::prepareRead</a>(<span class="keywordtype">int</span> cpu, <span class="keywordtype">int</span> <a class="code" href="namespaceMipsISA.html#aeeb2c1446acc9f3e056faacf09c36f7a">index</a>)
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170     <span class="keyword">using namespace </span>Regs;
<a name="l00171"></a>00171     <a class="code" href="classSinic_1_1Device.html#a0ab0817b161e71cccb34c7f14ed10bda">prepareIO</a>(cpu, index);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <a class="code" href="structSinic_1_1Device_1_1VirtualReg.html">VirtualReg</a> &amp;vnic = <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[index];
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">// update rx registers</span>
<a name="l00176"></a>00176     uint64_t rxdone = vnic.RxDone;
<a name="l00177"></a>00177     rxdone = set_RxDone_Packets(rxdone, <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#ab54fbcb3fd75f31211508d0deaaf70ee">countPacketsAfter</a>(<a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a>));
<a name="l00178"></a>00178     rxdone = set_RxDone_Empty(rxdone, <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aa4dbf488d04bc18c8c388595869a5d17">empty</a>());
<a name="l00179"></a>00179     rxdone = set_RxDone_High(rxdone, <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>() &gt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxFifoHigh);
<a name="l00180"></a>00180     rxdone = set_RxDone_NotHigh(rxdone, <a class="code" href="classSinic_1_1Device.html#afc34d30a3bb928788bb6b5eb417744f6">rxLow</a>);
<a name="l00181"></a>00181     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxData = vnic.RxData;
<a name="l00182"></a>00182     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxDone = rxdone;
<a name="l00183"></a>00183     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxWait = rxdone;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <span class="comment">// update tx regsiters</span>
<a name="l00186"></a>00186     uint64_t txdone = vnic.TxDone;
<a name="l00187"></a>00187     txdone = set_TxDone_Packets(txdone, <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a1ce8e3b4048c7bc6879a534cc493ead0">packets</a>());
<a name="l00188"></a>00188     txdone = set_TxDone_Full(txdone, <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a5abf953b4c5e2ef51cdb1045424d3214">avail</a>() &lt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxMaxCopy);
<a name="l00189"></a>00189     txdone = set_TxDone_Low(txdone, <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>() &lt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxFifoLow);
<a name="l00190"></a>00190     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxData = vnic.TxData;
<a name="l00191"></a>00191     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxDone = txdone;
<a name="l00192"></a>00192     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxWait = txdone;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="keywordtype">int</span> head = 0xffff;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aa4dbf488d04bc18c8c388595869a5d17">empty</a>()) {
<a name="l00197"></a>00197         <span class="keywordtype">int</span> vnic = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a82402a69186659a7e351a58655727fee">begin</a>()-&gt;priv;
<a name="l00198"></a>00198         <span class="keywordflow">if</span> (vnic != -1 &amp;&amp; <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[vnic].rxPacketOffset &gt; 0)
<a name="l00199"></a>00199             head = vnic;
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus = set_RxStatus_Head(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus, head);
<a name="l00203"></a>00203     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus = set_RxStatus_Busy(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus, <a class="code" href="classSinic_1_1Device.html#a363277e491705b47984ab89a3b5b8a51">rxBusyCount</a>);
<a name="l00204"></a>00204     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus = set_RxStatus_Mapped(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus, <a class="code" href="classSinic_1_1Device.html#ad0d621055c108fe203c4940c9f62e6e1">rxMappedCount</a>);
<a name="l00205"></a>00205     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus = set_RxStatus_Dirty(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxStatus, <a class="code" href="classSinic_1_1Device.html#a67ed568c7303777a89c64e5b4f4c2013">rxDirtyCount</a>);
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="keywordtype">void</span>
<a name="l00209"></a><a class="code" href="classSinic_1_1Device.html#a1bafaec0d7281a91b876011a08579c79">00209</a> <a class="code" href="classSinic_1_1Device.html#a1bafaec0d7281a91b876011a08579c79">Device::prepareWrite</a>(<span class="keywordtype">int</span> cpu, <span class="keywordtype">int</span> <a class="code" href="namespaceMipsISA.html#aeeb2c1446acc9f3e056faacf09c36f7a">index</a>)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211     <a class="code" href="classSinic_1_1Device.html#a0ab0817b161e71cccb34c7f14ed10bda">prepareIO</a>(cpu, index);
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00217"></a>00217 <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a>
<a name="l00218"></a><a class="code" href="classSinic_1_1Device.html#af63cc6673bcf81c68fca6b0f1f57c873">00218</a> <a class="code" href="classSinic_1_1Device.html#af63cc6673bcf81c68fca6b0f1f57c873" title="Memory Interface.">Device::read</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system (e...">PacketPtr</a> pkt)
<a name="l00219"></a>00219 {
<a name="l00220"></a>00220     assert(<a class="code" href="classPciDev.html#a79570d54c378a76ee402587fc5063857" title="The current config space.">config</a>.<a class="code" href="unionPCIConfig.html#aa310901519713f23fe0cc9de9bbb9682">command</a> &amp; <a class="code" href="pcireg_8h.html#a19eeefdf3c3100d9ab29182cbbcba083">PCI_CMD_MSE</a>);
<a name="l00221"></a>00221     assert(pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() &gt;= <a class="code" href="classPciDev.html#adefbaa9f12b46ae8e6cf3336f563f89d" title="The current address mapping of the BARs.">BARAddrs</a>[0] &amp;&amp; pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>() &lt; <a class="code" href="classPciDev.html#a66b521e93214deb2570c473ad2755a00" title="The size of the BARs.">BARSize</a>[0]);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordtype">int</span> cpu = pkt-&gt;<a class="code" href="classPacket.html#ae348c208f0ffb3cf22f1f65a19c13c4f" title="A pointer to the original request.">req</a>-&gt;<a class="code" href="classRequest.html#a49fb5bcad2ab0d274bdb4f5efb8cf8d9" title="Accessor function for context ID.">contextId</a>();
<a name="l00224"></a>00224     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> daddr = pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() - <a class="code" href="classPciDev.html#adefbaa9f12b46ae8e6cf3336f563f89d" title="The current address mapping of the BARs.">BARAddrs</a>[0];
<a name="l00225"></a>00225     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#aeeb2c1446acc9f3e056faacf09c36f7a">index</a> = daddr &gt;&gt; <a class="code" href="namespaceSinic_1_1Regs.html#a370b77dffaebcf4825f678637face11f">Regs::VirtualShift</a>;
<a name="l00226"></a>00226     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> raddr = daddr &amp; <a class="code" href="namespaceSinic_1_1Regs.html#a82be3d370337018afdbe809eeabcb2b9">Regs::VirtualMask</a>;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     pkt-&gt;<a class="code" href="classPacket.html#aaa5d4a16d37597168dcff5857d9c6717" title="If there isn&amp;#39;t data in the packet, allocate some.">allocate</a>();
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="keywordflow">if</span> (!<a class="code" href="namespaceSinic.html#af92abee16113e5012fa829e4935d917a">regValid</a>(raddr))
<a name="l00231"></a>00231         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;invalid register: cpu=%d vnic=%d da=%#x pa=%#x size=%d&quot;</span>,
<a name="l00232"></a>00232               cpu, index, daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="keyword">const</span> <a class="code" href="structSinic_1_1Regs_1_1Info.html">Regs::Info</a> &amp;info = <a class="code" href="namespaceSinic.html#aed2d64d4f995743e60f0fee5cca4e739">regInfo</a>(raddr);
<a name="l00235"></a>00235     <span class="keywordflow">if</span> (!info.read)
<a name="l00236"></a>00236         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;read %s (write only): &quot;</span>
<a name="l00237"></a>00237               <span class="stringliteral">&quot;cpu=%d vnic=%d da=%#x pa=%#x size=%d&quot;</span>,
<a name="l00238"></a>00238               info.name, cpu, index, daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;read %s (invalid size): &quot;</span>
<a name="l00241"></a>00241               <span class="stringliteral">&quot;cpu=%d vnic=%d da=%#x pa=%#x size=%d&quot;</span>,
<a name="l00242"></a>00242               info.name, cpu, index, daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <a class="code" href="classSinic_1_1Device.html#a5ba9a3551e90d2b29e4131ada6661b82">prepareRead</a>(cpu, index);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     uint64_t value M5_VAR_USED = 0;
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>() == 4) {
<a name="l00248"></a>00248         <a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="namespaceX86ISA.html#a6c9f38e48611db30642897e93a05104c">reg</a> = <a class="code" href="classSinic_1_1Device.html#a9ba5e72c64e333a06d4c1ca466d1ef2c">regData32</a>(raddr);
<a name="l00249"></a>00249         pkt-&gt;<a class="code" href="classPacket.html#ac63debc6335e01dcb4941e4c760a6962" title="set the value in the data pointer to v.">set</a>(reg);
<a name="l00250"></a>00250         value = reg;
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>() == 8) {
<a name="l00254"></a>00254         uint64_t <a class="code" href="namespaceX86ISA.html#a6c9f38e48611db30642897e93a05104c">reg</a> = <a class="code" href="classSinic_1_1Device.html#a9cc045a78c0cff75ba37c9be9ce728ea">regData64</a>(raddr);
<a name="l00255"></a>00255         pkt-&gt;<a class="code" href="classPacket.html#ac63debc6335e01dcb4941e4c760a6962" title="set the value in the data pointer to v.">set</a>(reg);
<a name="l00256"></a>00256         value = reg;
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO,
<a name="l00260"></a>00260             <span class="stringliteral">&quot;read %s: cpu=%d vnic=%d da=%#x pa=%#x size=%d val=%#x\n&quot;</span>,
<a name="l00261"></a>00261             info.name, cpu, index, daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>(), value);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="comment">// reading the interrupt status register has the side effect of</span>
<a name="l00264"></a>00264     <span class="comment">// clearing it</span>
<a name="l00265"></a>00265     <span class="keywordflow">if</span> (raddr == Regs::IntrStatus)
<a name="l00266"></a>00266         <a class="code" href="classSinic_1_1Device.html#a14ff7738c287c127412b00adaeb798bd">devIntrClear</a>();
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="keywordflow">return</span> <a class="code" href="classPciDev.html#a8f5bebdc51249cfa29fe1f87a81d5fc1">pioDelay</a>;
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00304"></a>00304 <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a>
<a name="l00305"></a><a class="code" href="classSinic_1_1Device.html#a88f495e79253042779bd827f676d2d58">00305</a> <a class="code" href="classSinic_1_1Device.html#a88f495e79253042779bd827f676d2d58" title="IPR read of device register.">Device::write</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system (e...">PacketPtr</a> pkt)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307     assert(<a class="code" href="classPciDev.html#a79570d54c378a76ee402587fc5063857" title="The current config space.">config</a>.<a class="code" href="unionPCIConfig.html#aa310901519713f23fe0cc9de9bbb9682">command</a> &amp; <a class="code" href="pcireg_8h.html#a19eeefdf3c3100d9ab29182cbbcba083">PCI_CMD_MSE</a>);
<a name="l00308"></a>00308     assert(pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() &gt;= <a class="code" href="classPciDev.html#adefbaa9f12b46ae8e6cf3336f563f89d" title="The current address mapping of the BARs.">BARAddrs</a>[0] &amp;&amp; pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>() &lt; <a class="code" href="classPciDev.html#a66b521e93214deb2570c473ad2755a00" title="The size of the BARs.">BARSize</a>[0]);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="keywordtype">int</span> cpu = pkt-&gt;<a class="code" href="classPacket.html#ae348c208f0ffb3cf22f1f65a19c13c4f" title="A pointer to the original request.">req</a>-&gt;<a class="code" href="classRequest.html#a49fb5bcad2ab0d274bdb4f5efb8cf8d9" title="Accessor function for context ID.">contextId</a>();
<a name="l00311"></a>00311     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> daddr = pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() - <a class="code" href="classPciDev.html#adefbaa9f12b46ae8e6cf3336f563f89d" title="The current address mapping of the BARs.">BARAddrs</a>[0];
<a name="l00312"></a>00312     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#aeeb2c1446acc9f3e056faacf09c36f7a">index</a> = daddr &gt;&gt; <a class="code" href="namespaceSinic_1_1Regs.html#a370b77dffaebcf4825f678637face11f">Regs::VirtualShift</a>;
<a name="l00313"></a>00313     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> raddr = daddr &amp; <a class="code" href="namespaceSinic_1_1Regs.html#a82be3d370337018afdbe809eeabcb2b9">Regs::VirtualMask</a>;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="keywordflow">if</span> (!<a class="code" href="namespaceSinic.html#af92abee16113e5012fa829e4935d917a">regValid</a>(raddr))
<a name="l00316"></a>00316         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;invalid register: cpu=%d, da=%#x pa=%#x size=%d&quot;</span>,
<a name="l00317"></a>00317                 cpu, daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keyword">const</span> <a class="code" href="structSinic_1_1Regs_1_1Info.html">Regs::Info</a> &amp;info = <a class="code" href="namespaceSinic.html#aed2d64d4f995743e60f0fee5cca4e739">regInfo</a>(raddr);
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (!info.write)
<a name="l00321"></a>00321         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;write %s (read only): &quot;</span>
<a name="l00322"></a>00322               <span class="stringliteral">&quot;cpu=%d vnic=%d da=%#x pa=%#x size=%d&quot;</span>,
<a name="l00323"></a>00323               info.name, cpu, index, daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>() != info.size)
<a name="l00326"></a>00326         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;write %s (invalid size): &quot;</span>
<a name="l00327"></a>00327               <span class="stringliteral">&quot;cpu=%d vnic=%d da=%#x pa=%#x size=%d&quot;</span>,
<a name="l00328"></a>00328               info.name, cpu, index, daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <a class="code" href="structSinic_1_1Device_1_1VirtualReg.html">VirtualReg</a> &amp;vnic = <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[index];
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO,
<a name="l00333"></a>00333             <span class="stringliteral">&quot;write %s vnic %d: cpu=%d val=%#x da=%#x pa=%#x size=%d\n&quot;</span>,
<a name="l00334"></a>00334             info.name, index, cpu, info.size == 4 ? pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&gt;() :
<a name="l00335"></a>00335             pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;uint64_t&gt;(), daddr, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <a class="code" href="classSinic_1_1Device.html#a1bafaec0d7281a91b876011a08579c79">prepareWrite</a>(cpu, index);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="keywordflow">switch</span> (raddr) {
<a name="l00340"></a>00340       <span class="keywordflow">case</span> Regs::Config:
<a name="l00341"></a>00341         <a class="code" href="classSinic_1_1Device.html#ac00804d2897ecfebf1f335bcfe400300" title="device configuration">changeConfig</a>(pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&gt;());
<a name="l00342"></a>00342         <span class="keywordflow">break</span>;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344       <span class="keywordflow">case</span> Regs::Command:
<a name="l00345"></a>00345         <a class="code" href="classSinic_1_1Device.html#a56f3fef36c954d548ade7c780cc34509">command</a>(pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&gt;());
<a name="l00346"></a>00346         <span class="keywordflow">break</span>;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348       <span class="keywordflow">case</span> Regs::IntrStatus:
<a name="l00349"></a>00349         <a class="code" href="classSinic_1_1Device.html#a14ff7738c287c127412b00adaeb798bd">devIntrClear</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus &amp; pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&gt;());
<a name="l00350"></a>00350         <span class="keywordflow">break</span>;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       <span class="keywordflow">case</span> Regs::IntrMask:
<a name="l00353"></a>00353         <a class="code" href="classSinic_1_1Device.html#a14d3650ef49ad04e7c42e22f79e0c685">devIntrChangeMask</a>(pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>&gt;());
<a name="l00354"></a>00354         <span class="keywordflow">break</span>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356       <span class="keywordflow">case</span> Regs::RxData:
<a name="l00357"></a>00357         <span class="keywordflow">if</span> (Regs::get_RxDone_Busy(vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a>))
<a name="l00358"></a>00358             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;receive machine busy with another request! rxState=%s&quot;</span>,
<a name="l00359"></a>00359                   <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[<a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a>]);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a> = <a class="code" href="classSinic_1_1Device.html#a6a5cad238c3c51fe5a4e792b527732d8">rxUnique</a>++;
<a name="l00362"></a>00362         vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a> = Regs::RxDone_Busy;
<a name="l00363"></a>00363         vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a> = pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;uint64_t&gt;();
<a name="l00364"></a>00364         <a class="code" href="classSinic_1_1Device.html#a363277e491705b47984ab89a3b5b8a51">rxBusyCount</a>++;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <span class="keywordflow">if</span> (Regs::get_RxData_Vaddr(pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;uint64_t&gt;())) {
<a name="l00367"></a>00367             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;vtophys not implemented in newmem&quot;</span>);
<a name="l00368"></a>00368 <span class="preprocessor">#ifdef SINIC_VTOPHYS</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>            <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a9bab751e4fa25d88bf84ee970a01a641">vaddr</a> = Regs::get_RxData_Addr(reg64);
<a name="l00370"></a>00370             <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> paddr = <a class="code" href="namespaceAlphaISA.html#a97aaf5bc76cca900eb38eadd7e8b0db5">vtophys</a>(req-&gt;xc, vaddr);
<a name="l00371"></a>00371             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO, <span class="stringliteral">&quot;write RxData vnic %d (rxunique %d): &quot;</span>
<a name="l00372"></a>00372                     <span class="stringliteral">&quot;vaddr=%#x, paddr=%#x\n&quot;</span>,
<a name="l00373"></a>00373                     index, vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>, vaddr, paddr);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375             vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a> = Regs::set_RxData_Addr(vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a>, paddr);
<a name="l00376"></a>00376 <span class="preprocessor">#endif</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l00378"></a>00378             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO, <span class="stringliteral">&quot;write RxData vnic %d (rxunique %d)\n&quot;</span>,
<a name="l00379"></a>00379                     index, vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>);
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="keywordflow">if</span> (vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> == <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>()) {
<a name="l00383"></a>00383             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO, <span class="stringliteral">&quot;request new packet...appending to rxList\n&quot;</span>);
<a name="l00384"></a>00384             <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.push_back(index);
<a name="l00385"></a>00385         } <span class="keywordflow">else</span> {
<a name="l00386"></a>00386             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO, <span class="stringliteral">&quot;packet exists...appending to rxBusy\n&quot;</span>);
<a name="l00387"></a>00387             <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.push_back(index);
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a9c3b79bff019b3906b29a960c1996a0c">rxEnable</a> &amp;&amp; (rxState == <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aeaab732bb2100850d024718ebeda232120">rxIdle</a> || rxState == <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aea6aa349a95720909e767d96b18907abb1">rxFifoBlock</a>)) {
<a name="l00391"></a>00391             rxState = rxFifoBlock;
<a name="l00392"></a>00392             <a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">rxKick</a>();
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394         <span class="keywordflow">break</span>;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396       <span class="keywordflow">case</span> Regs::TxData:
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (Regs::get_TxDone_Busy(vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a05bed8f8b5379c39943ca0f45755a7d5">TxDone</a>))
<a name="l00398"></a>00398             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;transmit machine busy with another request! txState=%s&quot;</span>,
<a name="l00399"></a>00399                   <a class="code" href="namespaceSinic.html#a79dc43034393462f74e022169469e7d2">TxStateStrings</a>[<a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a>]);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#acd1254bcf087d9fdc4f83e7d8546bbe8">txUnique</a> = <a class="code" href="classSinic_1_1Device.html#aeeb0f182a7a5311450ea258712327266">txUnique</a>++;
<a name="l00402"></a>00402         vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a05bed8f8b5379c39943ca0f45755a7d5">TxDone</a> = Regs::TxDone_Busy;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         <span class="keywordflow">if</span> (Regs::get_TxData_Vaddr(pkt-&gt;<a class="code" href="classPacket.html#a4fa1463610c7bda8c0b160b1457f1a52" title="return the value of what is pointed to in the packet.">get</a>&lt;uint64_t&gt;())) {
<a name="l00405"></a>00405             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;vtophys won&#39;t work here in newmem.\n&quot;</span>);
<a name="l00406"></a>00406 <span class="preprocessor">#ifdef SINIC_VTOPHYS</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span>            <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a9bab751e4fa25d88bf84ee970a01a641">vaddr</a> = Regs::get_TxData_Addr(reg64);
<a name="l00408"></a>00408             <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> paddr = <a class="code" href="namespaceAlphaISA.html#a97aaf5bc76cca900eb38eadd7e8b0db5">vtophys</a>(req-&gt;xc, vaddr);
<a name="l00409"></a>00409             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO, <span class="stringliteral">&quot;write TxData vnic %d (txunique %d): &quot;</span>
<a name="l00410"></a>00410                     <span class="stringliteral">&quot;vaddr=%#x, paddr=%#x\n&quot;</span>,
<a name="l00411"></a>00411                     index, vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#acd1254bcf087d9fdc4f83e7d8546bbe8">txUnique</a>, vaddr, paddr);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413             vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a4436214670ccca3073273379e7379702">TxData</a> = Regs::set_TxData_Addr(vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a4436214670ccca3073273379e7379702">TxData</a>, paddr);
<a name="l00414"></a>00414 <span class="preprocessor">#endif</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l00416"></a>00416             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetPIO, <span class="stringliteral">&quot;write TxData vnic %d (txunique %d)\n&quot;</span>,
<a name="l00417"></a>00417                     index, vnic.<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#acd1254bcf087d9fdc4f83e7d8546bbe8">txUnique</a>);
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.empty() || <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.front() != index)
<a name="l00421"></a>00421             <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.push_back(index);
<a name="l00422"></a>00422         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a6dc6eafd3facc6b367f2c22fb62da54e">txEnable</a> &amp;&amp; txState == <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fae2f8ed22f90e63123776fe576352e381">txIdle</a> &amp;&amp; <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.front() == index) {
<a name="l00423"></a>00423             txState = txFifoBlock;
<a name="l00424"></a>00424             <a class="code" href="classSinic_1_1Device.html#a328928a054fb0ac8251fbaf6187e8dd6">txKick</a>();
<a name="l00425"></a>00425         }
<a name="l00426"></a>00426         <span class="keywordflow">break</span>;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="keywordflow">return</span> <a class="code" href="classPciDev.html#a8f5bebdc51249cfa29fe1f87a81d5fc1">pioDelay</a>;
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="keywordtype">void</span>
<a name="l00433"></a><a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6">00433</a> <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">Device::devIntrPost</a>(<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> interrupts)
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435     <span class="keywordflow">if</span> ((interrupts &amp; Regs::Intr_Res))
<a name="l00436"></a>00436         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Cannot set a reserved interrupt&quot;</span>);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus |= interrupts;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr,
<a name="l00441"></a>00441             <span class="stringliteral">&quot;interrupt written to intStatus: intr=%#x status=%#x mask=%#x\n&quot;</span>,
<a name="l00442"></a>00442             interrupts, <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus, <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     interrupts = <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus &amp; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="comment">// Intr_RxHigh is special, we only signal it if we&#39;ve emptied the fifo</span>
<a name="l00447"></a>00447     <span class="comment">// and then filled it above the high watermark</span>
<a name="l00448"></a>00448     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a449a3e1293fea54968f22511f528e4d9">rxEmpty</a>)
<a name="l00449"></a>00449         <a class="code" href="classSinic_1_1Device.html#a449a3e1293fea54968f22511f528e4d9">rxEmpty</a> = <span class="keyword">false</span>;
<a name="l00450"></a>00450     <span class="keywordflow">else</span>
<a name="l00451"></a>00451         interrupts &amp;= ~Regs::Intr_RxHigh;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <span class="comment">// Intr_TxLow is special, we only signal it if we&#39;ve filled up the fifo</span>
<a name="l00454"></a>00454     <span class="comment">// and then dropped below the low watermark</span>
<a name="l00455"></a>00455     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a8bcfb307be9e155ffee88c88309b423d">txFull</a>)
<a name="l00456"></a>00456         <a class="code" href="classSinic_1_1Device.html#a8bcfb307be9e155ffee88c88309b423d">txFull</a> = <span class="keyword">false</span>;
<a name="l00457"></a>00457     <span class="keywordflow">else</span>
<a name="l00458"></a>00458         interrupts &amp;= ~Regs::Intr_TxLow;
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="keywordflow">if</span> (interrupts) {
<a name="l00461"></a>00461         <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> when = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l00462"></a>00462         <span class="keywordflow">if</span> ((interrupts &amp; Regs::Intr_NoDelay) == 0)
<a name="l00463"></a>00463             when += <a class="code" href="classSinic_1_1Base.html#a3da3263e5ffbe0dde58e00a16e8e400c">intrDelay</a>;
<a name="l00464"></a>00464         <a class="code" href="classSinic_1_1Base.html#aac9f3323f719a5d82640288264794907">cpuIntrPost</a>(when);
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 <span class="keywordtype">void</span>
<a name="l00469"></a><a class="code" href="classSinic_1_1Device.html#a14ff7738c287c127412b00adaeb798bd">00469</a> <a class="code" href="classSinic_1_1Device.html#a14ff7738c287c127412b00adaeb798bd">Device::devIntrClear</a>(<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> interrupts)
<a name="l00470"></a>00470 {
<a name="l00471"></a>00471     <span class="keywordflow">if</span> ((interrupts &amp; Regs::Intr_Res))
<a name="l00472"></a>00472         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Cannot clear a reserved interrupt&quot;</span>);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus &amp;= ~interrupts;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr,
<a name="l00477"></a>00477             <span class="stringliteral">&quot;interrupt cleared from intStatus: intr=%x status=%x mask=%x\n&quot;</span>,
<a name="l00478"></a>00478             interrupts, <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus, <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask);
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <span class="keywordflow">if</span> (!(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus &amp; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask))
<a name="l00481"></a>00481         <a class="code" href="classSinic_1_1Base.html#a4d1056f303c1fb6fe70b00b57f7a223c">cpuIntrClear</a>();
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="keywordtype">void</span>
<a name="l00485"></a><a class="code" href="classSinic_1_1Device.html#a14d3650ef49ad04e7c42e22f79e0c685">00485</a> <a class="code" href="classSinic_1_1Device.html#a14d3650ef49ad04e7c42e22f79e0c685">Device::devIntrChangeMask</a>(<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> newmask)
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask == newmask)
<a name="l00488"></a>00488         <span class="keywordflow">return</span>;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask = newmask;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr,
<a name="l00493"></a>00493             <span class="stringliteral">&quot;interrupt mask changed: intStatus=%x intMask=%x masked=%x\n&quot;</span>,
<a name="l00494"></a>00494             <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus, <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask, <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus &amp; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus &amp; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask)
<a name="l00497"></a>00497         <a class="code" href="classSinic_1_1Base.html#aac9f3323f719a5d82640288264794907">cpuIntrPost</a>(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l00498"></a>00498     <span class="keywordflow">else</span>
<a name="l00499"></a>00499         <a class="code" href="classSinic_1_1Base.html#a4d1056f303c1fb6fe70b00b57f7a223c">cpuIntrClear</a>();
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <span class="keywordtype">void</span>
<a name="l00503"></a><a class="code" href="classSinic_1_1Base.html#aac9f3323f719a5d82640288264794907">00503</a> <a class="code" href="classSinic_1_1Base.html#aac9f3323f719a5d82640288264794907">Base::cpuIntrPost</a>(<a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> when)
<a name="l00504"></a>00504 {
<a name="l00505"></a>00505     <span class="comment">// If the interrupt you want to post is later than an interrupt</span>
<a name="l00506"></a>00506     <span class="comment">// already scheduled, just let it post in the coming one and don&#39;t</span>
<a name="l00507"></a>00507     <span class="comment">// schedule another.</span>
<a name="l00508"></a>00508     <span class="comment">// HOWEVER, must be sure that the scheduled intrTick is in the</span>
<a name="l00509"></a>00509     <span class="comment">// future (this was formerly the source of a bug)</span>
<a name="l00514"></a>00514 <span class="comment"></span>    assert(when &gt;= <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l00515"></a>00515     assert(<a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> &gt;= <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() || <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> == 0);
<a name="l00516"></a>00516     <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Base.html#ad473c8d2e4b9e82bede75913c3f2a4df">cpuIntrEnable</a>) {
<a name="l00517"></a>00517         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr, <span class="stringliteral">&quot;interrupts not enabled.\n&quot;</span>,
<a name="l00518"></a>00518                 <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a>);
<a name="l00519"></a>00519         <span class="keywordflow">return</span>;
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (when &gt; <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> &amp;&amp; <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> != 0) {
<a name="l00523"></a>00523         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr, <span class="stringliteral">&quot;don&#39;t need to schedule event...intrTick=%d\n&quot;</span>,
<a name="l00524"></a>00524                 <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a>);
<a name="l00525"></a>00525         <span class="keywordflow">return</span>;
<a name="l00526"></a>00526     }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> = when;
<a name="l00529"></a>00529     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> &lt; <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>()) {
<a name="l00530"></a>00530         <a class="code" href="namespaceDebug.html#a3a24898e3ca48ef89e2029ab6e43665c">Debug::breakpoint</a>();
<a name="l00531"></a>00531         <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr, <span class="stringliteral">&quot;going to schedule an interrupt for intrTick=%d\n&quot;</span>,
<a name="l00535"></a>00535             <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a>);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>)
<a name="l00538"></a>00538         <a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>-&gt;<a class="code" href="classEvent.html#a91707c0c1d479ac987d1ec416406cb3f" title="Squash the current event.">squash</a>();
<a name="l00539"></a>00539     <a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a> = <span class="keyword">new</span> <a class="code" href="classSinic_1_1Base.html#a14b434b89740b865bf1638ad427ba0dd">IntrEvent</a>(<span class="keyword">this</span>, <span class="keyword">true</span>);
<a name="l00540"></a>00540     <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>, <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a>);
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="keywordtype">void</span>
<a name="l00544"></a><a class="code" href="classSinic_1_1Base.html#ac8be991167a97c26c53c6dd1141b3263">00544</a> <a class="code" href="classSinic_1_1Base.html#ac8be991167a97c26c53c6dd1141b3263">Base::cpuInterrupt</a>()
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546     assert(<a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> == <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="comment">// Whether or not there&#39;s a pending interrupt, we don&#39;t care about</span>
<a name="l00549"></a>00549     <span class="comment">// it anymore</span>
<a name="l00550"></a>00550     <a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a> = 0;
<a name="l00551"></a>00551     <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> = 0;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     <span class="comment">// Don&#39;t send an interrupt if there&#39;s already one</span>
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#ad23d5a37ea8cee31feb1502e59f553e3">cpuPendingIntr</a>) {
<a name="l00555"></a>00555         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr,
<a name="l00556"></a>00556                 <span class="stringliteral">&quot;would send an interrupt now, but there&#39;s already pending\n&quot;</span>);
<a name="l00557"></a>00557     } <span class="keywordflow">else</span> {
<a name="l00558"></a>00558         <span class="comment">// Send interrupt</span>
<a name="l00559"></a>00559         <a class="code" href="classSinic_1_1Base.html#ad23d5a37ea8cee31feb1502e59f553e3">cpuPendingIntr</a> = <span class="keyword">true</span>;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr, <span class="stringliteral">&quot;posting interrupt\n&quot;</span>);
<a name="l00562"></a>00562         <a class="code" href="classPciDev.html#aba354b60d7d6818157ddecfcca99183a">intrPost</a>();
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 <span class="keywordtype">void</span>
<a name="l00567"></a><a class="code" href="classSinic_1_1Base.html#a4d1056f303c1fb6fe70b00b57f7a223c">00567</a> <a class="code" href="classSinic_1_1Base.html#a4d1056f303c1fb6fe70b00b57f7a223c">Base::cpuIntrClear</a>()
<a name="l00568"></a>00568 {
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Base.html#ad23d5a37ea8cee31feb1502e59f553e3">cpuPendingIntr</a>)
<a name="l00570"></a>00570         <span class="keywordflow">return</span>;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>) {
<a name="l00573"></a>00573         <a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>-&gt;<a class="code" href="classEvent.html#a91707c0c1d479ac987d1ec416406cb3f" title="Squash the current event.">squash</a>();
<a name="l00574"></a>00574         <a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a> = 0;
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a> = 0;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <a class="code" href="classSinic_1_1Base.html#ad23d5a37ea8cee31feb1502e59f553e3">cpuPendingIntr</a> = <span class="keyword">false</span>;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetIntr, <span class="stringliteral">&quot;clearing cchip interrupt\n&quot;</span>);
<a name="l00582"></a>00582     <a class="code" href="classPciDev.html#a942e28b3d96095320f51a6f6c0c36c8a">intrClear</a>();
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585 <span class="keywordtype">bool</span>
<a name="l00586"></a><a class="code" href="classSinic_1_1Base.html#a575f188defeaee19d0aeadfa26906272">00586</a> <a class="code" href="classSinic_1_1Base.html#a575f188defeaee19d0aeadfa26906272">Base::cpuIntrPending</a>()<span class="keyword"> const</span>
<a name="l00587"></a>00587 <span class="keyword"></span>{ <span class="keywordflow">return</span> <a class="code" href="classSinic_1_1Base.html#ad23d5a37ea8cee31feb1502e59f553e3">cpuPendingIntr</a>; }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="keywordtype">void</span>
<a name="l00590"></a><a class="code" href="classSinic_1_1Device.html#ac00804d2897ecfebf1f335bcfe400300">00590</a> <a class="code" href="classSinic_1_1Device.html#ac00804d2897ecfebf1f335bcfe400300" title="device configuration">Device::changeConfig</a>(<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> newconf)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     <a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> changed = <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config ^ newconf;
<a name="l00593"></a>00593     <span class="keywordflow">if</span> (!changed)
<a name="l00594"></a>00594         <span class="keywordflow">return</span>;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config = newconf;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <span class="keywordflow">if</span> ((changed &amp; Regs::Config_IntEn)) {
<a name="l00599"></a>00599         <a class="code" href="classSinic_1_1Base.html#ad473c8d2e4b9e82bede75913c3f2a4df">cpuIntrEnable</a> = <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config &amp; Regs::Config_IntEn;
<a name="l00600"></a>00600         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#ad473c8d2e4b9e82bede75913c3f2a4df">cpuIntrEnable</a>) {
<a name="l00601"></a>00601             <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus &amp; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask)
<a name="l00602"></a>00602                 <a class="code" href="classSinic_1_1Base.html#aac9f3323f719a5d82640288264794907">cpuIntrPost</a>(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l00603"></a>00603         } <span class="keywordflow">else</span> {
<a name="l00604"></a>00604             <a class="code" href="classSinic_1_1Base.html#a4d1056f303c1fb6fe70b00b57f7a223c">cpuIntrClear</a>();
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="keywordflow">if</span> ((changed &amp; Regs::Config_TxEn)) {
<a name="l00609"></a>00609         <a class="code" href="classSinic_1_1Base.html#a6dc6eafd3facc6b367f2c22fb62da54e">txEnable</a> = <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config &amp; Regs::Config_TxEn;
<a name="l00610"></a>00610         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a6dc6eafd3facc6b367f2c22fb62da54e">txEnable</a>)
<a name="l00611"></a>00611             <a class="code" href="classSinic_1_1Device.html#a328928a054fb0ac8251fbaf6187e8dd6">txKick</a>();
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="keywordflow">if</span> ((changed &amp; Regs::Config_RxEn)) {
<a name="l00615"></a>00615         <a class="code" href="classSinic_1_1Base.html#a9c3b79bff019b3906b29a960c1996a0c">rxEnable</a> = <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config &amp; Regs::Config_RxEn;
<a name="l00616"></a>00616         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a9c3b79bff019b3906b29a960c1996a0c">rxEnable</a>)
<a name="l00617"></a>00617             <a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">rxKick</a>();
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619 }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="keywordtype">void</span>
<a name="l00622"></a><a class="code" href="classSinic_1_1Device.html#a56f3fef36c954d548ade7c780cc34509">00622</a> <a class="code" href="classSinic_1_1Device.html#a56f3fef36c954d548ade7c780cc34509">Device::command</a>(<a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> command)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (command &amp; Regs::Command_Intr)
<a name="l00625"></a>00625         <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_Soft);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (command &amp; Regs::Command_Reset)
<a name="l00628"></a>00628         <a class="code" href="classSinic_1_1Device.html#ad67d7883b3f6e10f009921c7b3a504cf">reset</a>();
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="keywordtype">void</span>
<a name="l00632"></a><a class="code" href="classSinic_1_1Device.html#ad67d7883b3f6e10f009921c7b3a504cf">00632</a> <a class="code" href="classSinic_1_1Device.html#ad67d7883b3f6e10f009921c7b3a504cf">Device::reset</a>()
<a name="l00633"></a>00633 {
<a name="l00634"></a>00634     <span class="keyword">using namespace </span>Regs;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     memset(&amp;<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>));
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config = 0;
<a name="l00639"></a>00639     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;rx_thread)
<a name="l00640"></a>00640         <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config |= Config_RxThread;
<a name="l00641"></a>00641     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;tx_thread)
<a name="l00642"></a>00642         <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config |= Config_TxThread;
<a name="l00643"></a>00643     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;rss)
<a name="l00644"></a>00644         <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config |= Config_RSS;
<a name="l00645"></a>00645     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;zero_copy)
<a name="l00646"></a>00646         <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config |= Config_ZeroCopy;
<a name="l00647"></a>00647     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;delay_copy)
<a name="l00648"></a>00648         <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config |= Config_DelayCopy;
<a name="l00649"></a>00649     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;virtual_addr)
<a name="l00650"></a>00650         <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config |= Config_Vaddr;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;delay_copy &amp;&amp; <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;zero_copy)
<a name="l00653"></a>00653         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Can&#39;t delay copy and zero copy&quot;</span>);
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask = Intr_Soft | Intr_RxHigh | Intr_RxPacket | Intr_TxLow;
<a name="l00656"></a>00656     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxMaxCopy = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;rx_max_copy;
<a name="l00657"></a>00657     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxMaxCopy = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;tx_max_copy;
<a name="l00658"></a>00658     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.ZeroCopySize = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;zero_copy_size;
<a name="l00659"></a>00659     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.ZeroCopyMark = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;zero_copy_threshold;
<a name="l00660"></a>00660     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.VirtualCount = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;virtual_count;
<a name="l00661"></a>00661     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxMaxIntr = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;rx_max_intr;
<a name="l00662"></a>00662     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxFifoSize = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;rx_fifo_size;
<a name="l00663"></a>00663     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxFifoSize = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;tx_fifo_size;
<a name="l00664"></a>00664     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxFifoLow = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;rx_fifo_low_mark;
<a name="l00665"></a>00665     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxFifoLow = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;tx_fifo_threshold;
<a name="l00666"></a>00666     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxFifoHigh = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;rx_fifo_threshold;
<a name="l00667"></a>00667     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxFifoHigh = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;tx_fifo_high_mark;
<a name="l00668"></a>00668     <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.HwAddr = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;hardware_address;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxMaxCopy &lt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.ZeroCopyMark)
<a name="l00671"></a>00671         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Must be able to copy at least as many bytes as the threshold&quot;</span>);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.ZeroCopySize &gt;= <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.ZeroCopyMark)
<a name="l00674"></a>00674         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;The number of bytes to copy must be less than the threshold&quot;</span>);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.clear();
<a name="l00677"></a>00677     <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.clear();
<a name="l00678"></a>00678     <a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a> = -1;
<a name="l00679"></a>00679     <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.clear();
<a name="l00680"></a>00680     <a class="code" href="classSinic_1_1Device.html#a363277e491705b47984ab89a3b5b8a51">rxBusyCount</a> = 0;
<a name="l00681"></a>00681     <a class="code" href="classSinic_1_1Device.html#a67ed568c7303777a89c64e5b4f4c2013">rxDirtyCount</a> = 0;
<a name="l00682"></a>00682     <a class="code" href="classSinic_1_1Device.html#ad0d621055c108fe203c4940c9f62e6e1">rxMappedCount</a> = 0;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a> = rxIdle;
<a name="l00685"></a>00685     <a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a> = txIdle;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff6614db891b7a01bb43853894806534">clear</a>();
<a name="l00688"></a>00688     <a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a> = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>();
<a name="l00689"></a>00689     <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#aff6614db891b7a01bb43853894806534">clear</a>();
<a name="l00690"></a>00690     <a class="code" href="classSinic_1_1Device.html#a449a3e1293fea54968f22511f528e4d9">rxEmpty</a> = <span class="keyword">false</span>;
<a name="l00691"></a>00691     <a class="code" href="classSinic_1_1Device.html#afc34d30a3bb928788bb6b5eb417744f6">rxLow</a> = <span class="keyword">true</span>;
<a name="l00692"></a>00692     <a class="code" href="classSinic_1_1Device.html#a8bcfb307be9e155ffee88c88309b423d">txFull</a> = <span class="keyword">false</span>;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="keywordtype">int</span> size = <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.size();
<a name="l00695"></a>00695     <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.clear();
<a name="l00696"></a>00696     <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.resize(size);
<a name="l00697"></a>00697     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; size; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>)
<a name="l00698"></a>00698         <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].rxIndex = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>();
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 <span class="keywordtype">void</span>
<a name="l00702"></a><a class="code" href="classSinic_1_1Device.html#adfc520f990ab1e18539158fd9546543e">00702</a> <a class="code" href="classSinic_1_1Device.html#adfc520f990ab1e18539158fd9546543e" title="DMA parameters.">Device::rxDmaDone</a>()
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704     assert(<a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a> == <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aea5d0458f04a3a66b635adbfe9e2c178fb">rxCopy</a>);
<a name="l00705"></a>00705     <a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a> = rxCopyDone;
<a name="l00706"></a>00706     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetDMA, <span class="stringliteral">&quot;end rx dma write paddr=%#x len=%d\n&quot;</span>,
<a name="l00707"></a>00707             <a class="code" href="classSinic_1_1Device.html#ab4e91921df640779fdbef6243f32dff3">rxDmaAddr</a>, <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a>);
<a name="l00708"></a>00708     <a class="code" href="trace_8hh.html#a556faf39d3fa9f7db5f344487ddbb397">DDUMP</a>(EthernetData, <a class="code" href="classSinic_1_1Device.html#abebd649c2a03d6d13916bab6a31a3197">rxDmaData</a>, <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a>);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="comment">// If the transmit state machine  has a pending DMA, let it go first</span>
<a name="l00711"></a>00711     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a> == <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fa660ed050592a2ee60d24c7cdbf43a285">txBeginCopy</a>)
<a name="l00712"></a>00712         <a class="code" href="classSinic_1_1Device.html#a328928a054fb0ac8251fbaf6187e8dd6">txKick</a>();
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     <a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">rxKick</a>();
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 <span class="keywordtype">void</span>
<a name="l00718"></a><a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">00718</a> <a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">Device::rxKick</a>()
<a name="l00719"></a>00719 {
<a name="l00720"></a>00720     <a class="code" href="structSinic_1_1Device_1_1VirtualReg.html">VirtualReg</a> *vnic = NULL;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;rxKick: rxState=%s (rxFifo.size=%d)\n&quot;</span>,
<a name="l00723"></a>00723             <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[<a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a>], <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>());
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a6f815cce0044f6efb88c78a65c4758a7">rxKickTick</a> &gt; <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>()) {
<a name="l00726"></a>00726         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;rxKick: exiting, can&#39;t run till %d\n&quot;</span>,
<a name="l00727"></a>00727                 <a class="code" href="classSinic_1_1Device.html#a6f815cce0044f6efb88c78a65c4758a7">rxKickTick</a>);
<a name="l00728"></a>00728         <span class="keywordflow">return</span>;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731   next:
<a name="l00732"></a>00732     <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#acc23be12fa4da66841bf813b183e45d1">check</a>();
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (rxState == <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aeaab732bb2100850d024718ebeda232120">rxIdle</a>)
<a name="l00734"></a>00734         <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a> == -1) {
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (rxState != <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aea6aa349a95720909e767d96b18907abb1">rxFifoBlock</a>)
<a name="l00738"></a>00738             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;no active vnic while in state %s&quot;</span>, <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[rxState]);
<a name="l00739"></a>00739 
<a name="l00740"></a>00740         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;processing rxState=%s\n&quot;</span>,
<a name="l00741"></a>00741                 <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[rxState]);
<a name="l00742"></a>00742     } <span class="keywordflow">else</span> {
<a name="l00743"></a>00743         vnic = &amp;<a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[<a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a>];
<a name="l00744"></a>00744         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM,
<a name="l00745"></a>00745                 <span class="stringliteral">&quot;processing rxState=%s for vnic %d (rxunique %d)\n&quot;</span>,
<a name="l00746"></a>00746                 <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[rxState], <a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>);
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="keywordflow">switch</span> (rxState) {
<a name="l00750"></a>00750       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aea6aa349a95720909e767d96b18907abb1">rxFifoBlock</a>:
<a name="l00751"></a>00751         <span class="keywordflow">if</span> (<a class="code" href="trace_8hh.html#af76c9f7776aade1bf9d7dfa8a0c6b341">DTRACE</a>(EthernetSM)) {
<a name="l00752"></a>00752             <a class="code" href="classPacketFifo.html#a6974f7ef22ca73cf315e996237bdab76">PacketFifo::iterator</a> end = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>();
<a name="l00753"></a>00753             <span class="keywordtype">int</span> size = <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.size();
<a name="l00754"></a>00754             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; size; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00755"></a>00755                 <a class="code" href="structSinic_1_1Device_1_1VirtualReg.html">VirtualReg</a> *vn = &amp;<a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>];
<a name="l00756"></a>00756                 <span class="keywordtype">bool</span> busy = Regs::get_RxDone_Busy(vn-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a>);
<a name="l00757"></a>00757                 <span class="keywordflow">if</span> (vn-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> != end) {
<a name="l00758"></a>00758 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>                    <span class="keywordtype">bool</span> dirty = vn-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a> &gt; 0;
<a name="l00760"></a>00760                     <span class="keyword">const</span> <span class="keywordtype">char</span> *status;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762                     <span class="keywordflow">if</span> (busy &amp;&amp; dirty)
<a name="l00763"></a>00763                         status = <span class="stringliteral">&quot;busy,dirty&quot;</span>;
<a name="l00764"></a>00764                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (busy)
<a name="l00765"></a>00765                         status = <span class="stringliteral">&quot;busy&quot;</span>;
<a name="l00766"></a>00766                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirty)
<a name="l00767"></a>00767                         status = <span class="stringliteral">&quot;dirty&quot;</span>;
<a name="l00768"></a>00768                     <span class="keywordflow">else</span>
<a name="l00769"></a>00769                         status = <span class="stringliteral">&quot;mapped&quot;</span>;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771                     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM,
<a name="l00772"></a>00772                             <span class="stringliteral">&quot;vnic %d %s (rxunique %d), packet %d, slack %d\n&quot;</span>,
<a name="l00773"></a>00773                             <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>, status, vn-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>,
<a name="l00774"></a>00774                             <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#ae8f915f525fad1a353dc3165c0b4dbd1">countPacketsBefore</a>(vn-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>),
<a name="l00775"></a>00775                             vn-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>-&gt;slack);
<a name="l00776"></a>00776 <span class="preprocessor">#endif</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (busy) {
<a name="l00778"></a>00778                     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;vnic %d unmapped (rxunique %d)\n&quot;</span>,
<a name="l00779"></a>00779                             <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>, vn-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>);
<a name="l00780"></a>00780                 }
<a name="l00781"></a>00781             }
<a name="l00782"></a>00782         }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784         <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.empty()) {
<a name="l00785"></a>00785             <a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a> = <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.front();
<a name="l00786"></a>00786             <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.pop_front();
<a name="l00787"></a>00787             vnic = &amp;<a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[<a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a>];
<a name="l00788"></a>00788 
<a name="l00789"></a>00789             <span class="keywordflow">if</span> (vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> == <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>())
<a name="l00790"></a>00790                 <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;continuing vnic without packet\n&quot;</span>);
<a name="l00791"></a>00791 
<a name="l00792"></a>00792             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM,
<a name="l00793"></a>00793                     <span class="stringliteral">&quot;continue processing for vnic %d (rxunique %d)\n&quot;</span>,
<a name="l00794"></a>00794                     <a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796             rxState = rxBeginCopy;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798             <span class="keywordtype">int</span> vnic_distance = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#ae8f915f525fad1a353dc3165c0b4dbd1">countPacketsBefore</a>(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>);
<a name="l00799"></a>00799             <a class="code" href="classSinic_1_1Device.html#ad8d2bcbd116501735ab8963427d285c4" title="Statistics.">totalVnicDistance</a> += vnic_distance;
<a name="l00800"></a>00800             <a class="code" href="classSinic_1_1Device.html#af4e2aeaff168d298b3eedfb0e302a71d">numVnicDistance</a> += 1;
<a name="l00801"></a>00801             <span class="keywordflow">if</span> (vnic_distance &gt; <a class="code" href="classSinic_1_1Device.html#a3da2f3bb12aa7874db945bd0a40f8b9b">_maxVnicDistance</a>) {
<a name="l00802"></a>00802                 <a class="code" href="classSinic_1_1Device.html#a916329d6c1b58db9b295a16c1b173428">maxVnicDistance</a> = vnic_distance;
<a name="l00803"></a>00803                 <a class="code" href="classSinic_1_1Device.html#a3da2f3bb12aa7874db945bd0a40f8b9b">_maxVnicDistance</a> = vnic_distance;
<a name="l00804"></a>00804             }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806             <span class="keywordflow">break</span>;
<a name="l00807"></a>00807         }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a> == <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>()) {
<a name="l00810"></a>00810             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;receive waiting for data.  Nothing to do.\n&quot;</span>);
<a name="l00811"></a>00811             <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.empty())
<a name="l00815"></a>00815             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Not idle, but nothing to do!&quot;</span>);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         assert(!<a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aa4dbf488d04bc18c8c388595869a5d17">empty</a>());
<a name="l00818"></a>00818 
<a name="l00819"></a>00819         <a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a> = <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.front();
<a name="l00820"></a>00820         <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.pop_front();
<a name="l00821"></a>00821         vnic = &amp;<a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[rxActive];
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM,
<a name="l00824"></a>00824                 <span class="stringliteral">&quot;processing new packet for vnic %d (rxunique %d)\n&quot;</span>,
<a name="l00825"></a>00825                 rxActive, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827         <span class="comment">// Grab a new packet from the fifo.</span>
<a name="l00828"></a>00828         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> = <a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a>++;
<a name="l00829"></a>00829         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>-&gt;priv = rxActive;
<a name="l00830"></a>00830         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a> = 0;
<a name="l00831"></a>00831         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a> = vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>-&gt;packet-&gt;length;
<a name="l00832"></a>00832         assert(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a>);
<a name="l00833"></a>00833         <a class="code" href="classSinic_1_1Device.html#ad0d621055c108fe203c4940c9f62e6e1">rxMappedCount</a>++;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a> = 0;
<a name="l00836"></a>00836         <span class="comment">/* scope for variables */</span> {
<a name="l00837"></a>00837             <a class="code" href="classNet_1_1IpPtr.html">IpPtr</a> <a class="code" href="namespaceiGbReg_1_1TxdOp.html#a95c40243f7e4760653e10ce95673f381">ip</a>(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>-&gt;packet);
<a name="l00838"></a>00838             <span class="keywordflow">if</span> (ip) {
<a name="l00839"></a>00839                 <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;ID is %d\n&quot;</span>, ip-&gt;id());
<a name="l00840"></a>00840                 vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a> |= Regs::RxDone_IpPacket;
<a name="l00841"></a>00841                 <a class="code" href="classEtherDevice.html#aee9c236ec7515e3e42242628ce2fc0a1">rxIpChecksums</a>++;
<a name="l00842"></a>00842                 <span class="keywordflow">if</span> (<a class="code" href="namespaceNet.html#a5ec87e377d6c9fd11933ed008df58af2">cksum</a>(ip) != 0) {
<a name="l00843"></a>00843                     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetCksum, <span class="stringliteral">&quot;Rx IP Checksum Error\n&quot;</span>);
<a name="l00844"></a>00844                     vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a> |= Regs::RxDone_IpError;
<a name="l00845"></a>00845                 }
<a name="l00846"></a>00846                 <a class="code" href="classNet_1_1TcpPtr.html">TcpPtr</a> <a class="code" href="namespaceiGbReg_1_1TxdOp.html#aff380643c92de5f84ae7d6675820723c">tcp</a>(ip);
<a name="l00847"></a>00847                 <a class="code" href="classNet_1_1UdpPtr.html">UdpPtr</a> udp(ip);
<a name="l00848"></a>00848                 <span class="keywordflow">if</span> (tcp) {
<a name="l00849"></a>00849                     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet,
<a name="l00850"></a>00850                             <span class="stringliteral">&quot;Src Port=%d, Dest Port=%d, Seq=%d, Ack=%d\n&quot;</span>,
<a name="l00851"></a>00851                             tcp-&gt;sport(), tcp-&gt;dport(), tcp-&gt;seq(),
<a name="l00852"></a>00852                             tcp-&gt;ack());
<a name="l00853"></a>00853                     vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a> |= Regs::RxDone_TcpPacket;
<a name="l00854"></a>00854                     <a class="code" href="classEtherDevice.html#a769d97454c861bbfdcb1055e9c2c274e">rxTcpChecksums</a>++;
<a name="l00855"></a>00855                     <span class="keywordflow">if</span> (<a class="code" href="namespaceNet.html#a5ec87e377d6c9fd11933ed008df58af2">cksum</a>(tcp) != 0) {
<a name="l00856"></a>00856                         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetCksum, <span class="stringliteral">&quot;Rx TCP Checksum Error\n&quot;</span>);
<a name="l00857"></a>00857                         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a> |= Regs::RxDone_TcpError;
<a name="l00858"></a>00858                     }
<a name="l00859"></a>00859                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (udp) {
<a name="l00860"></a>00860                     vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a> |= Regs::RxDone_UdpPacket;
<a name="l00861"></a>00861                     <a class="code" href="classEtherDevice.html#ae1d8f1273caae826a2f3a16e50f5c328">rxUdpChecksums</a>++;
<a name="l00862"></a>00862                     <span class="keywordflow">if</span> (<a class="code" href="namespaceNet.html#a5ec87e377d6c9fd11933ed008df58af2">cksum</a>(udp) != 0) {
<a name="l00863"></a>00863                         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetCksum, <span class="stringliteral">&quot;Rx UDP Checksum Error\n&quot;</span>);
<a name="l00864"></a>00864                         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a> |= Regs::RxDone_UdpError;
<a name="l00865"></a>00865                     }
<a name="l00866"></a>00866                 }
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869         rxState = rxBeginCopy;
<a name="l00870"></a>00870         <span class="keywordflow">break</span>;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aeaeda0bb96a454a1f758834faa3840b8d5">rxBeginCopy</a>:
<a name="l00873"></a>00873         <span class="keywordflow">if</span> (<a class="code" href="classDmaDevice.html#a4672e6f8435fb000ee7830f235ec11d5">dmaPending</a>() || <a class="code" href="classDrainable.html#a0e5f525d2e1df1af3e87ce17530b40dc">getDrainState</a>() != <a class="code" href="classDrainable.html#a6173416423af6af1bfe17262be40b5ffa2cea28320073053047fb4cd4471b5075">Drainable::Running</a>)
<a name="l00874"></a>00874             <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876         <a class="code" href="classSinic_1_1Device.html#ab4e91921df640779fdbef6243f32dff3">rxDmaAddr</a> = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;platform-&gt;pciToDma(
<a name="l00877"></a>00877                 Regs::get_RxData_Addr(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a>));
<a name="l00878"></a>00878         <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a> = min&lt;unsigned&gt;(Regs::get_RxData_Len(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a>),
<a name="l00879"></a>00879                                  vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a>);
<a name="l00880"></a>00880 
<a name="l00881"></a>00881         <span class="comment">/*</span>
<a name="l00882"></a>00882 <span class="comment">         * if we&#39;re doing zero/delay copy and we&#39;re below the fifo</span>
<a name="l00883"></a>00883 <span class="comment">         * threshold, see if we should try to do the zero/defer copy</span>
<a name="l00884"></a>00884 <span class="comment">         */</span>
<a name="l00885"></a>00885         <span class="keywordflow">if</span> ((Regs::get_Config_ZeroCopy(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config) ||
<a name="l00886"></a>00886              Regs::get_Config_DelayCopy(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config)) &amp;&amp;
<a name="l00887"></a>00887             !Regs::get_RxData_NoDelay(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a>) &amp;&amp; <a class="code" href="classSinic_1_1Device.html#afc34d30a3bb928788bb6b5eb417744f6">rxLow</a>) {
<a name="l00888"></a>00888             <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a> &gt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.ZeroCopyMark)
<a name="l00889"></a>00889                 <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a> = <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.ZeroCopySize;
<a name="l00890"></a>00890         }
<a name="l00891"></a>00891         <a class="code" href="classSinic_1_1Device.html#abebd649c2a03d6d13916bab6a31a3197">rxDmaData</a> = vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>-&gt;packet-&gt;data + vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a>;
<a name="l00892"></a>00892         rxState = rxCopy;
<a name="l00893"></a>00893         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#ab4e91921df640779fdbef6243f32dff3">rxDmaAddr</a> == 1<a class="code" href="base_2types_8hh.html#a959db1cfc6f9f5c23aefcda92bfc763e" title="int64_t constant">LL</a>) {
<a name="l00894"></a>00894             rxState = rxCopyDone;
<a name="l00895"></a>00895             <span class="keywordflow">break</span>;
<a name="l00896"></a>00896         }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898         <a class="code" href="classDmaDevice.html#ada6ca94d958378ea74a108a52f067888">dmaWrite</a>(<a class="code" href="classSinic_1_1Device.html#ab4e91921df640779fdbef6243f32dff3">rxDmaAddr</a>, <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a>, &amp;<a class="code" href="classSinic_1_1Device.html#a865c1868006f3877a60586189d77e738">rxDmaEvent</a>, <a class="code" href="classSinic_1_1Device.html#abebd649c2a03d6d13916bab6a31a3197">rxDmaData</a>);
<a name="l00899"></a>00899         <span class="keywordflow">break</span>;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aea5d0458f04a3a66b635adbfe9e2c178fb">rxCopy</a>:
<a name="l00902"></a>00902         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;receive machine still copying\n&quot;</span>);
<a name="l00903"></a>00903         <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aeaeb2986ae40553a141aa436cc956aa204">rxCopyDone</a>:
<a name="l00906"></a>00906         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a> = vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a>;
<a name="l00907"></a>00907         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a> |= Regs::RxDone_Complete;
<a name="l00908"></a>00908         <a class="code" href="classSinic_1_1Device.html#a363277e491705b47984ab89a3b5b8a51">rxBusyCount</a>--;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         <span class="keywordflow">if</span> (vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a> == <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a>) {
<a name="l00911"></a>00911             <span class="keywordflow">if</span> (vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a>)
<a name="l00912"></a>00912                 <a class="code" href="classSinic_1_1Device.html#a67ed568c7303777a89c64e5b4f4c2013">rxDirtyCount</a>--;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914             <span class="comment">// Packet is complete.  Indicate how many bytes were copied</span>
<a name="l00915"></a>00915             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a> = Regs::set_RxDone_CopyLen(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a>, <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a>);
<a name="l00916"></a>00916 
<a name="l00917"></a>00917             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM,
<a name="l00918"></a>00918                     <span class="stringliteral">&quot;rxKick: packet complete on vnic %d (rxunique %d)\n&quot;</span>,
<a name="l00919"></a>00919                     rxActive, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>);
<a name="l00920"></a>00920             <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a54de6452f03299cbae7c2f26ed929f7c">remove</a>(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>);
<a name="l00921"></a>00921             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>();
<a name="l00922"></a>00922             <a class="code" href="classSinic_1_1Device.html#ad0d621055c108fe203c4940c9f62e6e1">rxMappedCount</a>--;
<a name="l00923"></a>00923         } <span class="keywordflow">else</span> {
<a name="l00924"></a>00924             <span class="keywordflow">if</span> (!vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a>)
<a name="l00925"></a>00925                 <a class="code" href="classSinic_1_1Device.html#a67ed568c7303777a89c64e5b4f4c2013">rxDirtyCount</a>++;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a> -= <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a>;
<a name="l00928"></a>00928             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a> += <a class="code" href="classSinic_1_1Device.html#a26edeeed98cda25499759d59a54227c3">rxDmaLen</a>;
<a name="l00929"></a>00929             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a> |= Regs::RxDone_More;
<a name="l00930"></a>00930             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a> = Regs::set_RxDone_CopyLen(vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a>,
<a name="l00931"></a>00931                                                     vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a>);
<a name="l00932"></a>00932             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM,
<a name="l00933"></a>00933                     <span class="stringliteral">&quot;rxKick: packet not complete on vnic %d (rxunique %d): &quot;</span>
<a name="l00934"></a>00934                     <span class="stringliteral">&quot;%d bytes left\n&quot;</span>,
<a name="l00935"></a>00935                     rxActive, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a>);
<a name="l00936"></a>00936         }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938         rxActive = -1;
<a name="l00939"></a>00939         rxState = <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.empty() &amp;&amp; <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.empty() ? <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aeaab732bb2100850d024718ebeda232120">rxIdle</a> : rxFifoBlock;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aa4dbf488d04bc18c8c388595869a5d17">empty</a>()) {
<a name="l00942"></a>00942             <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_RxEmpty);
<a name="l00943"></a>00943             <a class="code" href="classSinic_1_1Device.html#a449a3e1293fea54968f22511f528e4d9">rxEmpty</a> = <span class="keyword">true</span>;
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>() &lt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxFifoLow)
<a name="l00947"></a>00947             <a class="code" href="classSinic_1_1Device.html#afc34d30a3bb928788bb6b5eb417744f6">rxLow</a> = <span class="keyword">true</span>;
<a name="l00948"></a>00948 
<a name="l00949"></a>00949         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>() &gt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxFifoHigh)
<a name="l00950"></a>00950             <a class="code" href="classSinic_1_1Device.html#afc34d30a3bb928788bb6b5eb417744f6">rxLow</a> = <span class="keyword">false</span>;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952         <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_RxDMA);
<a name="l00953"></a>00953         <span class="keywordflow">break</span>;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955       <span class="keywordflow">default</span>:
<a name="l00956"></a>00956         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Invalid rxState!&quot;</span>);
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;entering next rxState=%s\n&quot;</span>,
<a name="l00960"></a>00960             <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[rxState]);
<a name="l00961"></a>00961 
<a name="l00962"></a>00962     <span class="keywordflow">goto</span> next;
<a name="l00963"></a>00963 
<a name="l00964"></a>00964   <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>:
<a name="l00968"></a>00968     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;rx state machine exited rxState=%s\n&quot;</span>,
<a name="l00969"></a>00969             <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[rxState]);
<a name="l00970"></a>00970 }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972 <span class="keywordtype">void</span>
<a name="l00973"></a><a class="code" href="classSinic_1_1Device.html#ad9f5882c5220b3f259e4f44bf785e889">00973</a> <a class="code" href="classSinic_1_1Device.html#ad9f5882c5220b3f259e4f44bf785e889">Device::txDmaDone</a>()
<a name="l00974"></a>00974 {
<a name="l00975"></a>00975     assert(<a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a> == <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fa0f8f603780a4f7595e3766ababa41e12">txCopy</a>);
<a name="l00976"></a>00976     <a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a> = txCopyDone;
<a name="l00977"></a>00977     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetDMA, <span class="stringliteral">&quot;tx dma read paddr=%#x len=%d\n&quot;</span>,
<a name="l00978"></a>00978             <a class="code" href="classSinic_1_1Device.html#aa9e0f6cbc705f5fc31c80a697547ea11">txDmaAddr</a>, <a class="code" href="classSinic_1_1Device.html#aab6c1dedd36b84d0ab1518bf75ad5ee0">txDmaLen</a>);
<a name="l00979"></a>00979     <a class="code" href="trace_8hh.html#a556faf39d3fa9f7db5f344487ddbb397">DDUMP</a>(EthernetData, <a class="code" href="classSinic_1_1Device.html#ad3c8f84d51273f465d8d5d0d1bb746d4">txDmaData</a>, <a class="code" href="classSinic_1_1Device.html#aab6c1dedd36b84d0ab1518bf75ad5ee0">txDmaLen</a>);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     <span class="comment">// If the receive state machine  has a pending DMA, let it go first</span>
<a name="l00982"></a>00982     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a> == <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aeaeda0bb96a454a1f758834faa3840b8d5">rxBeginCopy</a>)
<a name="l00983"></a>00983         <a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">rxKick</a>();
<a name="l00984"></a>00984 
<a name="l00985"></a>00985     <a class="code" href="classSinic_1_1Device.html#a328928a054fb0ac8251fbaf6187e8dd6">txKick</a>();
<a name="l00986"></a>00986 }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 <span class="keywordtype">void</span>
<a name="l00989"></a><a class="code" href="classSinic_1_1Device.html#acbb118da11e31e00ec853c56ad6da953">00989</a> <a class="code" href="classSinic_1_1Device.html#acbb118da11e31e00ec853c56ad6da953" title="Retransmit event.">Device::transmit</a>()
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#aa4dbf488d04bc18c8c388595869a5d17">empty</a>()) {
<a name="l00992"></a>00992         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;nothing to transmit\n&quot;</span>);
<a name="l00993"></a>00993         <span class="keywordflow">return</span>;
<a name="l00994"></a>00994     }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <a class="code" href="Type_8hh.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> interrupts;
<a name="l00997"></a>00997     <a class="code" href="classRefCountingPtr.html">EthPacketPtr</a> packet = <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a748426efffbc0b6e2f151cbc0b5d9884">front</a>();
<a name="l00998"></a>00998     <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Base.html#a8c4580dbdec1abfdbcb82573e49a3dcf">interface</a>-&gt;<a class="code" href="classEtherInt.html#a7e6519bf1b247256aab9ef8bcc9441c3">sendPacket</a>(packet)) {
<a name="l00999"></a>00999         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;Packet Transmit: failed txFifo available %d\n&quot;</span>,
<a name="l01000"></a>01000                 <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a5abf953b4c5e2ef51cdb1045424d3214">avail</a>());
<a name="l01001"></a>01001         <span class="keywordflow">return</span>;
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#ad56389c821fb424d8e71dde61c33aed4">pop</a>();
<a name="l01005"></a>01005 <span class="preprocessor">#if TRACING_ON</span>
<a name="l01006"></a>01006 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="trace_8hh.html#af76c9f7776aade1bf9d7dfa8a0c6b341">DTRACE</a>(Ethernet)) {
<a name="l01007"></a>01007         <a class="code" href="classNet_1_1IpPtr.html">IpPtr</a> <a class="code" href="namespaceiGbReg_1_1TxdOp.html#a95c40243f7e4760653e10ce95673f381">ip</a>(packet);
<a name="l01008"></a>01008         <span class="keywordflow">if</span> (ip) {
<a name="l01009"></a>01009             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;ID is %d\n&quot;</span>, ip-&gt;id());
<a name="l01010"></a>01010             <a class="code" href="classNet_1_1TcpPtr.html">TcpPtr</a> <a class="code" href="namespaceiGbReg_1_1TxdOp.html#aff380643c92de5f84ae7d6675820723c">tcp</a>(ip);
<a name="l01011"></a>01011             <span class="keywordflow">if</span> (tcp) {
<a name="l01012"></a>01012                 <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet,
<a name="l01013"></a>01013                         <span class="stringliteral">&quot;Src Port=%d, Dest Port=%d, Seq=%d, Ack=%d\n&quot;</span>,
<a name="l01014"></a>01014                         tcp-&gt;sport(), tcp-&gt;dport(), tcp-&gt;seq(),
<a name="l01015"></a>01015                         tcp-&gt;ack());
<a name="l01016"></a>01016             }
<a name="l01017"></a>01017         }
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019 <span class="preprocessor">#endif</span>
<a name="l01020"></a>01020 <span class="preprocessor"></span>
<a name="l01021"></a>01021     <a class="code" href="trace_8hh.html#a556faf39d3fa9f7db5f344487ddbb397">DDUMP</a>(EthernetData, packet-&gt;<a class="code" href="classRefCountingPtr.html#a6b357f8b956e6421ef12211897528b6d" title="The stored pointer.">data</a>, packet-&gt;length);
<a name="l01022"></a>01022     <a class="code" href="classEtherDevice.html#a372ada2debd208f712085a2ac60c12ab">txBytes</a> += packet-&gt;length;
<a name="l01023"></a>01023     <a class="code" href="classEtherDevice.html#a844ad3c63250e548dd5557c44a9fd89c">txPackets</a>++;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;Packet Transmit: successful txFifo Available %d\n&quot;</span>,
<a name="l01026"></a>01026             <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a5abf953b4c5e2ef51cdb1045424d3214">avail</a>());
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     interrupts = Regs::Intr_TxPacket;
<a name="l01029"></a>01029     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>() &lt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxFifoLow)
<a name="l01030"></a>01030         interrupts |= Regs::Intr_TxLow;
<a name="l01031"></a>01031     <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(interrupts);
<a name="l01032"></a>01032 }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 <span class="keywordtype">void</span>
<a name="l01035"></a><a class="code" href="classSinic_1_1Device.html#a328928a054fb0ac8251fbaf6187e8dd6">01035</a> <a class="code" href="classSinic_1_1Device.html#a328928a054fb0ac8251fbaf6187e8dd6">Device::txKick</a>()
<a name="l01036"></a>01036 {
<a name="l01037"></a>01037     <a class="code" href="structSinic_1_1Device_1_1VirtualReg.html">VirtualReg</a> *vnic;
<a name="l01038"></a>01038     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;txKick: txState=%s (txFifo.size=%d)\n&quot;</span>,
<a name="l01039"></a>01039             <a class="code" href="namespaceSinic.html#a79dc43034393462f74e022169469e7d2">TxStateStrings</a>[<a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a>], <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>());
<a name="l01040"></a>01040 
<a name="l01041"></a>01041     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af414fa3cc9d31eac6cf4d6fba2856749">txKickTick</a> &gt; <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>()) {
<a name="l01042"></a>01042         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;txKick: exiting, can&#39;t run till %d\n&quot;</span>,
<a name="l01043"></a>01043                 <a class="code" href="classSinic_1_1Device.html#af414fa3cc9d31eac6cf4d6fba2856749">txKickTick</a>);
<a name="l01044"></a>01044         <span class="keywordflow">return</span>;
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047   next:
<a name="l01048"></a>01048     <span class="keywordflow">if</span> (txState == <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fae2f8ed22f90e63123776fe576352e381">txIdle</a>)
<a name="l01049"></a>01049         <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     assert(!<a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.empty());
<a name="l01052"></a>01052     vnic = &amp;<a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[<a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.front()];
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="keywordflow">switch</span> (txState) {
<a name="l01055"></a>01055       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fa34ee09fdbe98db23525e99722be89ef2">txFifoBlock</a>:
<a name="l01056"></a>01056         assert(Regs::get_TxDone_Busy(vnic-&gt;TxDone));
<a name="l01057"></a>01057         <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>) {
<a name="l01058"></a>01058             <span class="comment">// Grab a new packet from the fifo.</span>
<a name="l01059"></a>01059             <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a> = <span class="keyword">new</span> <a class="code" href="classEthPacketData.html">EthPacketData</a>(16384);
<a name="l01060"></a>01060             <a class="code" href="classSinic_1_1Device.html#a6dcb1288a314bfce9f0979c3ff0f60b3">txPacketOffset</a> = 0;
<a name="l01061"></a>01061         }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a5abf953b4c5e2ef51cdb1045424d3214">avail</a>() - <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>-&gt;length &lt;
<a name="l01064"></a>01064             Regs::get_TxData_Len(vnic-&gt;TxData)) {
<a name="l01065"></a>01065             <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;transmit fifo full.  Nothing to do.\n&quot;</span>);
<a name="l01066"></a>01066             <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l01067"></a>01067         }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069         txState = txBeginCopy;
<a name="l01070"></a>01070         <span class="keywordflow">break</span>;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fa660ed050592a2ee60d24c7cdbf43a285">txBeginCopy</a>:
<a name="l01073"></a>01073         <span class="keywordflow">if</span> (<a class="code" href="classDmaDevice.html#a4672e6f8435fb000ee7830f235ec11d5">dmaPending</a>() || <a class="code" href="classDrainable.html#a0e5f525d2e1df1af3e87ce17530b40dc">getDrainState</a>() != <a class="code" href="classDrainable.html#a6173416423af6af1bfe17262be40b5ffa2cea28320073053047fb4cd4471b5075">Drainable::Running</a>)
<a name="l01074"></a>01074             <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076         <a class="code" href="classSinic_1_1Device.html#aa9e0f6cbc705f5fc31c80a697547ea11">txDmaAddr</a> = <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>()-&gt;platform-&gt;pciToDma(
<a name="l01077"></a>01077                 Regs::get_TxData_Addr(vnic-&gt;TxData));
<a name="l01078"></a>01078         <a class="code" href="classSinic_1_1Device.html#aab6c1dedd36b84d0ab1518bf75ad5ee0">txDmaLen</a> = Regs::get_TxData_Len(vnic-&gt;TxData);
<a name="l01079"></a>01079         <a class="code" href="classSinic_1_1Device.html#ad3c8f84d51273f465d8d5d0d1bb746d4">txDmaData</a> = <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>-&gt;<a class="code" href="classRefCountingPtr.html#a6b357f8b956e6421ef12211897528b6d" title="The stored pointer.">data</a> + <a class="code" href="classSinic_1_1Device.html#a6dcb1288a314bfce9f0979c3ff0f60b3">txPacketOffset</a>;
<a name="l01080"></a>01080         txState = txCopy;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082         <a class="code" href="classDmaDevice.html#a5e2f5335eff62ca1326f567cd355d992">dmaRead</a>(<a class="code" href="classSinic_1_1Device.html#aa9e0f6cbc705f5fc31c80a697547ea11">txDmaAddr</a>, <a class="code" href="classSinic_1_1Device.html#aab6c1dedd36b84d0ab1518bf75ad5ee0">txDmaLen</a>, &amp;<a class="code" href="classSinic_1_1Device.html#ac59b7d722623e93de4ccaf3ea04bde43">txDmaEvent</a>, <a class="code" href="classSinic_1_1Device.html#ad3c8f84d51273f465d8d5d0d1bb746d4">txDmaData</a>);
<a name="l01083"></a>01083         <span class="keywordflow">break</span>;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fa0f8f603780a4f7595e3766ababa41e12">txCopy</a>:
<a name="l01086"></a>01086         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;transmit machine still copying\n&quot;</span>);
<a name="l01087"></a>01087         <span class="keywordflow">goto</span> <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>;
<a name="l01088"></a>01088 
<a name="l01089"></a>01089       <span class="keywordflow">case</span> <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fa5de582ec267b8c9bb6038ac7ec8573c9">txCopyDone</a>:
<a name="l01090"></a>01090         vnic-&gt;TxDone = <a class="code" href="classSinic_1_1Device.html#aab6c1dedd36b84d0ab1518bf75ad5ee0">txDmaLen</a> | Regs::TxDone_Complete;
<a name="l01091"></a>01091         <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>-&gt;length += <a class="code" href="classSinic_1_1Device.html#aab6c1dedd36b84d0ab1518bf75ad5ee0">txDmaLen</a>;
<a name="l01092"></a>01092         <span class="keywordflow">if</span> ((vnic-&gt;TxData &amp; Regs::TxData_More)) {
<a name="l01093"></a>01093             <a class="code" href="classSinic_1_1Device.html#a6dcb1288a314bfce9f0979c3ff0f60b3">txPacketOffset</a> += <a class="code" href="classSinic_1_1Device.html#aab6c1dedd36b84d0ab1518bf75ad5ee0">txDmaLen</a>;
<a name="l01094"></a>01094             txState = txIdle;
<a name="l01095"></a>01095             <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_TxDMA);
<a name="l01096"></a>01096             <span class="keywordflow">break</span>;
<a name="l01097"></a>01097         }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099         assert(<a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>-&gt;length &lt;= <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a5abf953b4c5e2ef51cdb1045424d3214">avail</a>());
<a name="l01100"></a>01100         <span class="keywordflow">if</span> ((vnic-&gt;TxData &amp; Regs::TxData_Checksum)) {
<a name="l01101"></a>01101             <a class="code" href="classNet_1_1IpPtr.html">IpPtr</a> <a class="code" href="namespaceiGbReg_1_1TxdOp.html#a95c40243f7e4760653e10ce95673f381">ip</a>(<a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>);
<a name="l01102"></a>01102             <span class="keywordflow">if</span> (ip) {
<a name="l01103"></a>01103                 <a class="code" href="classNet_1_1TcpPtr.html">TcpPtr</a> <a class="code" href="namespaceiGbReg_1_1TxdOp.html#aff380643c92de5f84ae7d6675820723c">tcp</a>(ip);
<a name="l01104"></a>01104                 <span class="keywordflow">if</span> (tcp) {
<a name="l01105"></a>01105                     tcp-&gt;sum(0);
<a name="l01106"></a>01106                     tcp-&gt;sum(<a class="code" href="namespaceNet.html#a5ec87e377d6c9fd11933ed008df58af2">cksum</a>(tcp));
<a name="l01107"></a>01107                     <a class="code" href="classEtherDevice.html#a269c1095e07975f5e1f8ce043ba9b073">txTcpChecksums</a>++;
<a name="l01108"></a>01108                 }
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                 <a class="code" href="classNet_1_1UdpPtr.html">UdpPtr</a> udp(ip);
<a name="l01111"></a>01111                 <span class="keywordflow">if</span> (udp) {
<a name="l01112"></a>01112                     udp-&gt;sum(0);
<a name="l01113"></a>01113                     udp-&gt;sum(<a class="code" href="namespaceNet.html#a5ec87e377d6c9fd11933ed008df58af2">cksum</a>(udp));
<a name="l01114"></a>01114                     <a class="code" href="classEtherDevice.html#aefeac9de1e6ede671dbbb5efc3eaa844">txUdpChecksums</a>++;
<a name="l01115"></a>01115                 }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117                 ip-&gt;sum(0);
<a name="l01118"></a>01118                 ip-&gt;sum(<a class="code" href="namespaceNet.html#a5ec87e377d6c9fd11933ed008df58af2">cksum</a>(ip));
<a name="l01119"></a>01119                 <a class="code" href="classEtherDevice.html#a3c7383c5bcf750d544a59ece87090dd1">txIpChecksums</a>++;
<a name="l01120"></a>01120             }
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123         <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a701330089d5bd938c0c87cc45f4ae08c">push</a>(<a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>);
<a name="l01124"></a>01124         <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#a5abf953b4c5e2ef51cdb1045424d3214">avail</a>() &lt; <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxMaxCopy) {
<a name="l01125"></a>01125             <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_TxFull);
<a name="l01126"></a>01126             <a class="code" href="classSinic_1_1Device.html#a8bcfb307be9e155ffee88c88309b423d">txFull</a> = <span class="keyword">true</span>;
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128         <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a> = 0;
<a name="l01129"></a>01129         <a class="code" href="classSinic_1_1Device.html#acbb118da11e31e00ec853c56ad6da953" title="Retransmit event.">transmit</a>();
<a name="l01130"></a>01130         <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.pop_front();
<a name="l01131"></a>01131         txState = <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.empty() ? <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fae2f8ed22f90e63123776fe576352e381">txIdle</a> : txFifoBlock;
<a name="l01132"></a>01132         <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_TxDMA);
<a name="l01133"></a>01133         <span class="keywordflow">break</span>;
<a name="l01134"></a>01134 
<a name="l01135"></a>01135       <span class="keywordflow">default</span>:
<a name="l01136"></a>01136         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Invalid txState!&quot;</span>);
<a name="l01137"></a>01137     }
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;entering next txState=%s\n&quot;</span>,
<a name="l01140"></a>01140             <a class="code" href="namespaceSinic.html#a79dc43034393462f74e022169469e7d2">TxStateStrings</a>[txState]);
<a name="l01141"></a>01141 
<a name="l01142"></a>01142     <span class="keywordflow">goto</span> next;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144   <a class="code" href="namespaceX86ISA.html#a1d7b1aefeb0ba5e276e1e6379cfda554">exit</a>:
<a name="l01148"></a>01148     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(EthernetSM, <span class="stringliteral">&quot;tx state machine exited txState=%s\n&quot;</span>,
<a name="l01149"></a>01149             <a class="code" href="namespaceSinic.html#a79dc43034393462f74e022169469e7d2">TxStateStrings</a>[txState]);
<a name="l01150"></a>01150 }
<a name="l01151"></a>01151 
<a name="l01152"></a>01152 <span class="keywordtype">void</span>
<a name="l01153"></a><a class="code" href="classSinic_1_1Device.html#a35be8454a296ab14338210f921a3539c">01153</a> <a class="code" href="classSinic_1_1Device.html#a35be8454a296ab14338210f921a3539c">Device::transferDone</a>()
<a name="l01154"></a>01154 {
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#aa4dbf488d04bc18c8c388595869a5d17">empty</a>()) {
<a name="l01156"></a>01156         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;transfer complete: txFifo empty...nothing to do\n&quot;</span>);
<a name="l01157"></a>01157         <span class="keywordflow">return</span>;
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;transfer complete: data in txFifo...schedule xmit\n&quot;</span>);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162     <a class="code" href="classEventManager.html#a766c5f955dfa1609696955f075492687">reschedule</a>(<a class="code" href="classSinic_1_1Device.html#ad011cd0c6ce5f55f2b76bdca738b1227">txEvent</a>, <a class="code" href="classClockedObject.html#a7c1f64c925f158530be84323a503dbb7" title="Determine the tick when a cycle begins, by default the current one, but the argument also enables the...">clockEdge</a>(<a class="code" href="classCycles.html" title="Cycles is a wrapper class for representing cycle counts, i.e.">Cycles</a>(1)), <span class="keyword">true</span>);
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 
<a name="l01165"></a>01165 <span class="keywordtype">bool</span>
<a name="l01166"></a><a class="code" href="classSinic_1_1Device.html#ad42d79c3e591f9e1b2e74805fa601d88">01166</a> <a class="code" href="classSinic_1_1Device.html#ad42d79c3e591f9e1b2e74805fa601d88" title="receive address filter">Device::rxFilter</a>(<span class="keyword">const</span> <a class="code" href="classRefCountingPtr.html">EthPacketPtr</a> &amp;packet)
<a name="l01167"></a>01167 {
<a name="l01168"></a>01168     <span class="keywordflow">if</span> (!Regs::get_Config_Filter(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config))
<a name="l01169"></a>01169         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171     <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;receive filter not implemented\n&quot;</span>);
<a name="l01172"></a>01172     <span class="keywordtype">bool</span> drop = <span class="keyword">true</span>;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="preprocessor">#if 0</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span>    <span class="keywordtype">string</span> <a class="code" href="namespaceX86ISA.html#abd6d20afe8f06aa5708282b98f926658">type</a>;
<a name="l01176"></a>01176 
<a name="l01177"></a>01177     <a class="code" href="structNet_1_1EthHdr.html">EthHdr</a> *eth = packet-&gt;eth();
<a name="l01178"></a>01178     <span class="keywordflow">if</span> (eth-&gt;unicast()) {
<a name="l01179"></a>01179         <span class="comment">// If we&#39;re accepting all unicast addresses</span>
<a name="l01180"></a>01180         <span class="keywordflow">if</span> (acceptUnicast)
<a name="l01181"></a>01181             drop = <span class="keyword">false</span>;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         <span class="comment">// If we make a perfect match</span>
<a name="l01184"></a>01184         <span class="keywordflow">if</span> (acceptPerfect &amp;&amp; <a class="code" href="classSinic_1_1Base.html#a1a9630600bf87c211cabbe679832574d">params</a>-&gt;eaddr == eth.<a class="code" href="structNet_1_1EthHdr.html#a910bcb0ae23667336290a482764b88a0">dst</a>())
<a name="l01185"></a>01185             drop = <span class="keyword">false</span>;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187         <span class="keywordflow">if</span> (acceptArp &amp;&amp; eth-&gt;<a class="code" href="structNet_1_1EthHdr.html#a8dddbbfea8c2da37764724c98384fd60">type</a>() == ETH_TYPE_ARP)
<a name="l01188"></a>01188             drop = <span class="keyword">false</span>;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eth-&gt;broadcast()) {
<a name="l01191"></a>01191         <span class="comment">// if we&#39;re accepting broadcasts</span>
<a name="l01192"></a>01192         <span class="keywordflow">if</span> (acceptBroadcast)
<a name="l01193"></a>01193             drop = <span class="keyword">false</span>;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eth-&gt;multicast()) {
<a name="l01196"></a>01196         <span class="comment">// if we&#39;re accepting all multicasts</span>
<a name="l01197"></a>01197         <span class="keywordflow">if</span> (acceptMulticast)
<a name="l01198"></a>01198             drop = <span class="keyword">false</span>;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200     }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202     <span class="keywordflow">if</span> (drop) {
<a name="l01203"></a>01203         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;rxFilter drop\n&quot;</span>);
<a name="l01204"></a>01204         <a class="code" href="trace_8hh.html#a556faf39d3fa9f7db5f344487ddbb397">DDUMP</a>(EthernetData, packet-&gt;<a class="code" href="classRefCountingPtr.html#a6b357f8b956e6421ef12211897528b6d" title="The stored pointer.">data</a>, packet-&gt;length);
<a name="l01205"></a>01205     }
<a name="l01206"></a>01206 <span class="preprocessor">#endif</span>
<a name="l01207"></a>01207 <span class="preprocessor"></span>    <span class="keywordflow">return</span> drop;
<a name="l01208"></a>01208 }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210 <span class="keywordtype">bool</span>
<a name="l01211"></a><a class="code" href="classSinic_1_1Device.html#affc29a7344d352f0ec6b974481c63037">01211</a> <a class="code" href="classSinic_1_1Device.html#affc29a7344d352f0ec6b974481c63037" title="device ethernet interface">Device::recvPacket</a>(<a class="code" href="classRefCountingPtr.html">EthPacketPtr</a> packet)
<a name="l01212"></a>01212 {
<a name="l01213"></a>01213     <a class="code" href="classEtherDevice.html#afe5b8a7cb1ab4d0e25c58102fb13ca8e">rxBytes</a> += packet-&gt;length;
<a name="l01214"></a>01214     <a class="code" href="classEtherDevice.html#a2f8e70cb709879302685be328170e6e2">rxPackets</a>++;
<a name="l01215"></a>01215 
<a name="l01216"></a>01216     <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;Receiving packet from wire, rxFifo Available is %d\n&quot;</span>,
<a name="l01217"></a>01217             <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a5abf953b4c5e2ef51cdb1045424d3214">avail</a>());
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Base.html#a9c3b79bff019b3906b29a960c1996a0c">rxEnable</a>) {
<a name="l01220"></a>01220         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;receive disabled...packet dropped\n&quot;</span>);
<a name="l01221"></a>01221         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01222"></a>01222     }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#ad42d79c3e591f9e1b2e74805fa601d88" title="receive address filter">rxFilter</a>(packet)) {
<a name="l01225"></a>01225         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet, <span class="stringliteral">&quot;packet filtered...dropped\n&quot;</span>);
<a name="l01226"></a>01226         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01227"></a>01227     }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a2dbca9a15d75e1729f8d3f5581161773">size</a>() &gt;= <a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxFifoHigh)
<a name="l01230"></a>01230         <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_RxHigh);
<a name="l01231"></a>01231 
<a name="l01232"></a>01232     <span class="keywordflow">if</span> (!<a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a701330089d5bd938c0c87cc45f4ae08c">push</a>(packet)) {
<a name="l01233"></a>01233         <a class="code" href="trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Ethernet,
<a name="l01234"></a>01234                 <span class="stringliteral">&quot;packet will not fit in receive buffer...packet dropped\n&quot;</span>);
<a name="l01235"></a>01235         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01236"></a>01236     }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     <span class="comment">// If we were at the last element, back up one ot go to the new</span>
<a name="l01239"></a>01239     <span class="comment">// last element of the list.</span>
<a name="l01240"></a>01240     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a> == <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>())
<a name="l01241"></a>01241         --<a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a>;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     <a class="code" href="classSinic_1_1Device.html#a1a6a711f8921d4a3c67c27a874b068f6" title="Interrupt management.">devIntrPost</a>(Regs::Intr_RxPacket);
<a name="l01244"></a>01244     <a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">rxKick</a>();
<a name="l01245"></a>01245     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01246"></a>01246 }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 <span class="keywordtype">void</span>
<a name="l01249"></a><a class="code" href="classSinic_1_1Device.html#ab7002d56b84b46b1f20a682c4a1159d1">01249</a> <a class="code" href="classSinic_1_1Device.html#ab7002d56b84b46b1f20a682c4a1159d1" title="Resume execution after a successful drain.">Device::drainResume</a>()
<a name="l01250"></a>01250 {
<a name="l01251"></a>01251     <a class="code" href="classSinic_1_1Device.html#ab7002d56b84b46b1f20a682c4a1159d1" title="Resume execution after a successful drain.">Drainable::drainResume</a>();
<a name="l01252"></a>01252 
<a name="l01253"></a>01253     <span class="comment">// During drain we could have left the state machines in a waiting state and</span>
<a name="l01254"></a>01254     <span class="comment">// they wouldn&#39;t get out until some other event occured to kick them.</span>
<a name="l01255"></a>01255     <span class="comment">// This way they&#39;ll get out immediately</span>
<a name="l01256"></a>01256     <a class="code" href="classSinic_1_1Device.html#a328928a054fb0ac8251fbaf6187e8dd6">txKick</a>();
<a name="l01257"></a>01257     <a class="code" href="classSinic_1_1Device.html#a3c0694b7d39175c4c4604601e4d6c87d">rxKick</a>();
<a name="l01258"></a>01258 }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260 <span class="comment">//=====================================================================</span>
<a name="l01261"></a>01261 <span class="comment">//</span>
<a name="l01262"></a>01262 <span class="comment">//</span>
<a name="l01263"></a>01263 <span class="keywordtype">void</span>
<a name="l01264"></a><a class="code" href="classSinic_1_1Base.html#a5cb09bcd7b14c4410ccbad2691f7e579">01264</a> <a class="code" href="classSinic_1_1Base.html#a5cb09bcd7b14c4410ccbad2691f7e579" title="Serialization stuff.">Base::serialize</a>(std::ostream &amp;<a class="code" href="namespaceX86ISA.html#aea9fbab71662ba06cf536e05edfaaad1">os</a>)
<a name="l01265"></a>01265 {
<a name="l01266"></a>01266     <span class="comment">// Serialize the PciDev base class</span>
<a name="l01267"></a>01267     <a class="code" href="classSinic_1_1Base.html#a5cb09bcd7b14c4410ccbad2691f7e579" title="Serialization stuff.">PciDev::serialize</a>(os);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#a9c3b79bff019b3906b29a960c1996a0c">rxEnable</a>);
<a name="l01270"></a>01270     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#a6dc6eafd3facc6b367f2c22fb62da54e">txEnable</a>);
<a name="l01271"></a>01271     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#ad473c8d2e4b9e82bede75913c3f2a4df">cpuIntrEnable</a>);
<a name="l01272"></a>01272 
<a name="l01273"></a>01273     <span class="comment">/*</span>
<a name="l01274"></a>01274 <span class="comment">     * Keep track of pending interrupt status.</span>
<a name="l01275"></a>01275 <span class="comment">     */</span>
<a name="l01276"></a>01276     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a>);
<a name="l01277"></a>01277     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#ad23d5a37ea8cee31feb1502e59f553e3">cpuPendingIntr</a>);
<a name="l01278"></a>01278     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> intrEventTick = 0;
<a name="l01279"></a>01279     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>)
<a name="l01280"></a>01280         intrEventTick = <a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>-&gt;<a class="code" href="classEvent.html#a3ff737aa0692f1ea9b8dd232778f2fcb" title="Get the time that the event is scheduled.">when</a>();
<a name="l01281"></a>01281     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(intrEventTick);
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284 <span class="keywordtype">void</span>
<a name="l01285"></a><a class="code" href="classSinic_1_1Base.html#ad0e511912c7f357b8bdc8d317d580ac1">01285</a> <a class="code" href="classSinic_1_1Base.html#ad0e511912c7f357b8bdc8d317d580ac1" title="Reconstruct the state of this object from a checkpoint.">Base::unserialize</a>(<a class="code" href="classCheckpoint.html">Checkpoint</a> *cp, <span class="keyword">const</span> std::string &amp;section)
<a name="l01286"></a>01286 {
<a name="l01287"></a>01287     <span class="comment">// Unserialize the PciDev base class</span>
<a name="l01288"></a>01288     <a class="code" href="classSinic_1_1Base.html#ad0e511912c7f357b8bdc8d317d580ac1" title="Reconstruct the state of this object from a checkpoint.">PciDev::unserialize</a>(cp, section);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#a9c3b79bff019b3906b29a960c1996a0c">rxEnable</a>);
<a name="l01291"></a>01291     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#a6dc6eafd3facc6b367f2c22fb62da54e">txEnable</a>);
<a name="l01292"></a>01292     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#ad473c8d2e4b9e82bede75913c3f2a4df">cpuIntrEnable</a>);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294     <span class="comment">/*</span>
<a name="l01295"></a>01295 <span class="comment">     * Keep track of pending interrupt status.</span>
<a name="l01296"></a>01296 <span class="comment">     */</span>
<a name="l01297"></a>01297     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#aa7271c11e2ab5a29cd0ab9a22c01cf56">intrTick</a>);
<a name="l01298"></a>01298     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Base.html#ad23d5a37ea8cee31feb1502e59f553e3">cpuPendingIntr</a>);
<a name="l01299"></a>01299     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> intrEventTick;
<a name="l01300"></a>01300     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(intrEventTick);
<a name="l01301"></a>01301     <span class="keywordflow">if</span> (intrEventTick) {
<a name="l01302"></a>01302         <a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a> = <span class="keyword">new</span> <a class="code" href="classSinic_1_1Base.html#a14b434b89740b865bf1638ad427ba0dd">IntrEvent</a>(<span class="keyword">this</span>, <span class="keyword">true</span>);
<a name="l01303"></a>01303         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classSinic_1_1Base.html#aefffe7971fadc64b4eb629ebd6668b78">intrEvent</a>, intrEventTick);
<a name="l01304"></a>01304     }
<a name="l01305"></a>01305 }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 <span class="keywordtype">void</span>
<a name="l01308"></a><a class="code" href="classSinic_1_1Device.html#a8cf4465c744efceee61c633211b3e60f">01308</a> <a class="code" href="classSinic_1_1Device.html#a8cf4465c744efceee61c633211b3e60f" title="Serialization stuff.">Device::serialize</a>(std::ostream &amp;<a class="code" href="namespaceX86ISA.html#aea9fbab71662ba06cf536e05edfaaad1">os</a>)
<a name="l01309"></a>01309 {
<a name="l01310"></a>01310     <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>;
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     <span class="comment">// Serialize the PciDev base class</span>
<a name="l01313"></a>01313     <a class="code" href="classSinic_1_1Device.html#a8cf4465c744efceee61c633211b3e60f" title="Serialization stuff.">Base::serialize</a>(os);
<a name="l01314"></a>01314 
<a name="l01315"></a>01315     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a> == <a class="code" href="classSinic_1_1Device.html#a96be4ba539ab0c89debf6739b80182aea5d0458f04a3a66b635adbfe9e2c178fb">rxCopy</a>)
<a name="l01316"></a>01316         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;can&#39;t serialize with an in flight dma request rxState=%s&quot;</span>,
<a name="l01317"></a>01317               <a class="code" href="namespaceSinic.html#a927fcdccf0ef2c9181ea11da74cd0153">RxStateStrings</a>[<a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a>]);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (<a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a> == <a class="code" href="classSinic_1_1Device.html#a2dd11913f2f9348d637f91aefc1b954fa0f8f603780a4f7595e3766ababa41e12">txCopy</a>)
<a name="l01320"></a>01320         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;can&#39;t serialize with an in flight dma request txState=%s&quot;</span>,
<a name="l01321"></a>01321               <a class="code" href="namespaceSinic.html#a79dc43034393462f74e022169469e7d2">TxStateStrings</a>[<a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a>]);
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     <span class="comment">/*</span>
<a name="l01324"></a>01324 <span class="comment">     * Serialize the device registers that could be modified by the OS.</span>
<a name="l01325"></a>01325 <span class="comment">     */</span>
<a name="l01326"></a>01326     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config);
<a name="l01327"></a>01327     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus);
<a name="l01328"></a>01328     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask);
<a name="l01329"></a>01329     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxData);
<a name="l01330"></a>01330     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxData);
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     <span class="comment">/*</span>
<a name="l01333"></a>01333 <span class="comment">     * Serialize the virtual nic state</span>
<a name="l01334"></a>01334 <span class="comment">     */</span>
<a name="l01335"></a>01335     <span class="keywordtype">int</span> virtualRegsSize = <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.size();
<a name="l01336"></a>01336     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(virtualRegsSize);
<a name="l01337"></a>01337     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; virtualRegsSize; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l01338"></a>01338         <a class="code" href="structSinic_1_1Device_1_1VirtualReg.html">VirtualReg</a> *vnic = &amp;<a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>];
<a name="l01339"></a>01339 
<a name="l01340"></a>01340         std::string <a class="code" href="namespaceX86ISA.html#a6c9f38e48611db30642897e93a05104c">reg</a> = <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;vnic%d&quot;</span>, <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>);
<a name="l01341"></a>01341         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.RxData&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a>);
<a name="l01342"></a>01342         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.RxDone&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a>);
<a name="l01343"></a>01343         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.TxData&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a4436214670ccca3073273379e7379702">TxData</a>);
<a name="l01344"></a>01344         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.TxDone&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a05bed8f8b5379c39943ca0f45755a7d5">TxDone</a>);
<a name="l01345"></a>01345 
<a name="l01346"></a>01346         <span class="keywordtype">bool</span> rxPacketExists = vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> != <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>();
<a name="l01347"></a>01347         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.rxPacketExists&quot;</span>, rxPacketExists);
<a name="l01348"></a>01348         <span class="keywordflow">if</span> (rxPacketExists) {
<a name="l01349"></a>01349             <span class="keywordtype">int</span> rxPacket = 0;
<a name="l01350"></a>01350             <a class="code" href="classPacketFifo.html#a6974f7ef22ca73cf315e996237bdab76">PacketFifo::iterator</a> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a82402a69186659a7e351a58655727fee">begin</a>();
<a name="l01351"></a>01351             <span class="keywordflow">while</span> (i != vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>) {
<a name="l01352"></a>01352                 assert(i != <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>());
<a name="l01353"></a>01353                 ++i;
<a name="l01354"></a>01354                 ++rxPacket;
<a name="l01355"></a>01355             }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357             <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.rxPacket&quot;</span>, rxPacket);
<a name="l01358"></a>01358             <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.rxPacketOffset&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a>);
<a name="l01359"></a>01359             <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.rxPacketBytes&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a>);
<a name="l01360"></a>01360         }
<a name="l01361"></a>01361         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, reg + <span class="stringliteral">&quot;.rxDoneData&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a>);
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363 
<a name="l01364"></a>01364     <span class="keywordtype">int</span> <a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a> = -1;
<a name="l01365"></a>01365     <span class="keywordflow">if</span> (this-&gt;rxFifoPtr != <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>())
<a name="l01366"></a>01366         rxFifoPtr = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#ae8f915f525fad1a353dc3165c0b4dbd1">countPacketsBefore</a>(this-&gt;rxFifoPtr);
<a name="l01367"></a>01367     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(rxFifoPtr);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a>);
<a name="l01370"></a>01370     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a363277e491705b47984ab89a3b5b8a51">rxBusyCount</a>);
<a name="l01371"></a>01371     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a67ed568c7303777a89c64e5b4f4c2013">rxDirtyCount</a>);
<a name="l01372"></a>01372     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#ad0d621055c108fe203c4940c9f62e6e1">rxMappedCount</a>);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374     VirtualList::iterator <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>, end;
<a name="l01375"></a>01375     <span class="keywordflow">for</span> (count = 0, i = <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.begin(), end = <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.end(); i != end; ++i)
<a name="l01376"></a>01376         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;rxList%d&quot;</span>, count++), *i);
<a name="l01377"></a>01377     <span class="keywordtype">int</span> rxListSize = count;
<a name="l01378"></a>01378     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(rxListSize);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380     <span class="keywordflow">for</span> (count = 0, i = <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.begin(), end = <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.end(); i != end; ++i)
<a name="l01381"></a>01381         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;rxBusy%d&quot;</span>, count++), *i);
<a name="l01382"></a>01382     <span class="keywordtype">int</span> rxBusySize = count;
<a name="l01383"></a>01383     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(rxBusySize);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385     <span class="keywordflow">for</span> (count = 0, i = <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.begin(), end = <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.end(); i != end; ++i)
<a name="l01386"></a>01386         <a class="code" href="arch_2x86_2types_8cc.html#adc6b6ea750b0d7ff7441ea35588abbdb">paramOut</a>(os, <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;txList%d&quot;</span>, count++), *i);
<a name="l01387"></a>01387     <span class="keywordtype">int</span> txListSize = count;
<a name="l01388"></a>01388     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(txListSize);
<a name="l01389"></a>01389 
<a name="l01390"></a>01390     <span class="comment">/*</span>
<a name="l01391"></a>01391 <span class="comment">     * Serialize rx state machine</span>
<a name="l01392"></a>01392 <span class="comment">     */</span>
<a name="l01393"></a>01393     <span class="keywordtype">int</span> rxState = this-&gt;rxState;
<a name="l01394"></a>01394     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(rxState);
<a name="l01395"></a>01395     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a449a3e1293fea54968f22511f528e4d9">rxEmpty</a>);
<a name="l01396"></a>01396     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#afc34d30a3bb928788bb6b5eb417744f6">rxLow</a>);
<a name="l01397"></a>01397     <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#ad9e262b830aa9a2f26dd47c7b34763fb" title="Serialization stuff.">serialize</a>(<span class="stringliteral">&quot;rxFifo&quot;</span>, os);
<a name="l01398"></a>01398 
<a name="l01399"></a>01399     <span class="comment">/*</span>
<a name="l01400"></a>01400 <span class="comment">     * Serialize tx state machine</span>
<a name="l01401"></a>01401 <span class="comment">     */</span>
<a name="l01402"></a>01402     <span class="keywordtype">int</span> txState = this-&gt;txState;
<a name="l01403"></a>01403     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(txState);
<a name="l01404"></a>01404     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a8bcfb307be9e155ffee88c88309b423d">txFull</a>);
<a name="l01405"></a>01405     <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#ad9e262b830aa9a2f26dd47c7b34763fb" title="Serialization stuff.">serialize</a>(<span class="stringliteral">&quot;txFifo&quot;</span>, os);
<a name="l01406"></a>01406     <span class="keywordtype">bool</span> txPacketExists = <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>;
<a name="l01407"></a>01407     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(txPacketExists);
<a name="l01408"></a>01408     <span class="keywordflow">if</span> (txPacketExists) {
<a name="l01409"></a>01409         <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>-&gt;serialize(<span class="stringliteral">&quot;txPacket&quot;</span>, os);
<a name="l01410"></a>01410         <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a6dcb1288a314bfce9f0979c3ff0f60b3">txPacketOffset</a>);
<a name="l01411"></a>01411         <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#adb0b1996cd0cad369b6b24dde6c1c5ff">txPacketBytes</a>);
<a name="l01412"></a>01412     }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414     <span class="comment">/*</span>
<a name="l01415"></a>01415 <span class="comment">     * If there&#39;s a pending transmit, store the time so we can</span>
<a name="l01416"></a>01416 <span class="comment">     * reschedule it later</span>
<a name="l01417"></a>01417 <span class="comment">     */</span>
<a name="l01418"></a>01418     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> transmitTick = <a class="code" href="classSinic_1_1Device.html#ad011cd0c6ce5f55f2b76bdca738b1227">txEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>() ? <a class="code" href="classSinic_1_1Device.html#ad011cd0c6ce5f55f2b76bdca738b1227">txEvent</a>.<a class="code" href="classEvent.html#a3ff737aa0692f1ea9b8dd232778f2fcb" title="Get the time that the event is scheduled.">when</a>() - <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() : 0;
<a name="l01419"></a>01419     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(transmitTick);
<a name="l01420"></a>01420 }
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 <span class="keywordtype">void</span>
<a name="l01423"></a><a class="code" href="classSinic_1_1Device.html#ab0bbf996be8494404318a9491323c6eb">01423</a> <a class="code" href="classSinic_1_1Device.html#ab0bbf996be8494404318a9491323c6eb" title="Reconstruct the state of this object from a checkpoint.">Device::unserialize</a>(<a class="code" href="classCheckpoint.html">Checkpoint</a> *cp, <span class="keyword">const</span> std::string &amp;section)
<a name="l01424"></a>01424 {
<a name="l01425"></a>01425     <span class="comment">// Unserialize the PciDev base class</span>
<a name="l01426"></a>01426     <a class="code" href="classSinic_1_1Device.html#ab0bbf996be8494404318a9491323c6eb" title="Reconstruct the state of this object from a checkpoint.">Base::unserialize</a>(cp, section);
<a name="l01427"></a>01427 
<a name="l01428"></a>01428     <span class="comment">/*</span>
<a name="l01429"></a>01429 <span class="comment">     * Unserialize the device registers that may have been written by the OS.</span>
<a name="l01430"></a>01430 <span class="comment">     */</span>
<a name="l01431"></a>01431     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.Config);
<a name="l01432"></a>01432     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrStatus);
<a name="l01433"></a>01433     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.IntrMask);
<a name="l01434"></a>01434     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.RxData);
<a name="l01435"></a>01435     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#af1369e2efdd45bdbf1508b2c5d058bbc" title="device register file">regs</a>.TxData);
<a name="l01436"></a>01436 
<a name="l01437"></a>01437     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a7bba0307ee1abcf302af6cc0e195752d">rxActive</a>);
<a name="l01438"></a>01438     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a363277e491705b47984ab89a3b5b8a51">rxBusyCount</a>);
<a name="l01439"></a>01439     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a67ed568c7303777a89c64e5b4f4c2013">rxDirtyCount</a>);
<a name="l01440"></a>01440     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#ad0d621055c108fe203c4940c9f62e6e1">rxMappedCount</a>);
<a name="l01441"></a>01441 
<a name="l01442"></a>01442     <span class="keywordtype">int</span> rxListSize;
<a name="l01443"></a>01443     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(rxListSize);
<a name="l01444"></a>01444     <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.clear();
<a name="l01445"></a>01445     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; rxListSize; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l01446"></a>01446         <span class="keywordtype">int</span> value;
<a name="l01447"></a>01447         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;rxList%d&quot;</span>, <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>), value);
<a name="l01448"></a>01448         <a class="code" href="classSinic_1_1Device.html#a89b626bc635e5aff43f458f6f34c81f0">rxList</a>.push_back(value);
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451     <span class="keywordtype">int</span> rxBusySize;
<a name="l01452"></a>01452     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(rxBusySize);
<a name="l01453"></a>01453     <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.clear();
<a name="l01454"></a>01454     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; rxBusySize; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l01455"></a>01455         <span class="keywordtype">int</span> value;
<a name="l01456"></a>01456         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;rxBusy%d&quot;</span>, <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>), value);
<a name="l01457"></a>01457         <a class="code" href="classSinic_1_1Device.html#a5e254c8630c8b4ec427423e35ec6b84f">rxBusy</a>.push_back(value);
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     <span class="keywordtype">int</span> txListSize;
<a name="l01461"></a>01461     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(txListSize);
<a name="l01462"></a>01462     <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.clear();
<a name="l01463"></a>01463     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; txListSize; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l01464"></a>01464         <span class="keywordtype">int</span> value;
<a name="l01465"></a>01465         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;txList%d&quot;</span>, <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>), value);
<a name="l01466"></a>01466         <a class="code" href="classSinic_1_1Device.html#a15d684db82644ebf00a1c9dfa7edac77">txList</a>.push_back(value);
<a name="l01467"></a>01467     }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <span class="comment">/*</span>
<a name="l01470"></a>01470 <span class="comment">     * Unserialize rx state machine</span>
<a name="l01471"></a>01471 <span class="comment">     */</span>
<a name="l01472"></a>01472     <span class="keywordtype">int</span> <a class="code" href="classSinic_1_1Device.html#afca11925fcae4605723130576099c5fa">rxState</a>;
<a name="l01473"></a>01473     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(rxState);
<a name="l01474"></a>01474     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a449a3e1293fea54968f22511f528e4d9">rxEmpty</a>);
<a name="l01475"></a>01475     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#afc34d30a3bb928788bb6b5eb417744f6">rxLow</a>);
<a name="l01476"></a>01476     this-&gt;rxState = (RxState) rxState;
<a name="l01477"></a>01477     <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aeef26656cf88d146e92d318ca36c3aaf">unserialize</a>(<span class="stringliteral">&quot;rxFifo&quot;</span>, cp, section);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479     <span class="keywordtype">int</span> <a class="code" href="classSinic_1_1Device.html#add235e55b2e6baef20a27dcfff7c1848">rxFifoPtr</a>;
<a name="l01480"></a>01480     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(rxFifoPtr);
<a name="l01481"></a>01481     <span class="keywordflow">if</span> (rxFifoPtr &gt;= 0) {
<a name="l01482"></a>01482         this-&gt;rxFifoPtr = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a82402a69186659a7e351a58655727fee">begin</a>();
<a name="l01483"></a>01483         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; rxFifoPtr; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>)
<a name="l01484"></a>01484             ++this-&gt;rxFifoPtr;
<a name="l01485"></a>01485     } <span class="keywordflow">else</span> {
<a name="l01486"></a>01486         this-&gt;rxFifoPtr = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>();
<a name="l01487"></a>01487     }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489     <span class="comment">/*</span>
<a name="l01490"></a>01490 <span class="comment">     * Unserialize tx state machine</span>
<a name="l01491"></a>01491 <span class="comment">     */</span>
<a name="l01492"></a>01492     <span class="keywordtype">int</span> <a class="code" href="classSinic_1_1Device.html#aa8fc498341b5dd98d2d089db4626a838">txState</a>;
<a name="l01493"></a>01493     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(txState);
<a name="l01494"></a>01494     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a8bcfb307be9e155ffee88c88309b423d">txFull</a>);
<a name="l01495"></a>01495     this-&gt;txState = (TxState) txState;
<a name="l01496"></a>01496     <a class="code" href="classSinic_1_1Device.html#af40204c2b7cb7509627755870424db27">txFifo</a>.<a class="code" href="classPacketFifo.html#aeef26656cf88d146e92d318ca36c3aaf">unserialize</a>(<span class="stringliteral">&quot;txFifo&quot;</span>, cp, section);
<a name="l01497"></a>01497     <span class="keywordtype">bool</span> txPacketExists;
<a name="l01498"></a>01498     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(txPacketExists);
<a name="l01499"></a>01499     <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a> = 0;
<a name="l01500"></a>01500     <span class="keywordflow">if</span> (txPacketExists) {
<a name="l01501"></a>01501         <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a> = <span class="keyword">new</span> <a class="code" href="classEthPacketData.html">EthPacketData</a>(16384);
<a name="l01502"></a>01502         <a class="code" href="classSinic_1_1Device.html#ad4be9a3fb8bc18d9c82868f9b90a1f77">txPacket</a>-&gt;unserialize(<span class="stringliteral">&quot;txPacket&quot;</span>, cp, section);
<a name="l01503"></a>01503         <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#a6dcb1288a314bfce9f0979c3ff0f60b3">txPacketOffset</a>);
<a name="l01504"></a>01504         <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classSinic_1_1Device.html#adb0b1996cd0cad369b6b24dde6c1c5ff">txPacketBytes</a>);
<a name="l01505"></a>01505     }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507     <span class="comment">/*</span>
<a name="l01508"></a>01508 <span class="comment">     * unserialize the virtual nic registers/state</span>
<a name="l01509"></a>01509 <span class="comment">     *</span>
<a name="l01510"></a>01510 <span class="comment">     * this must be done after the unserialization of the rxFifo</span>
<a name="l01511"></a>01511 <span class="comment">     * because the packet iterators depend on the fifo being populated</span>
<a name="l01512"></a>01512 <span class="comment">     */</span>
<a name="l01513"></a>01513     <span class="keywordtype">int</span> virtualRegsSize;
<a name="l01514"></a>01514     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(virtualRegsSize);
<a name="l01515"></a>01515     <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.clear();
<a name="l01516"></a>01516     <a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>.resize(virtualRegsSize);
<a name="l01517"></a>01517     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; virtualRegsSize; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l01518"></a>01518         <a class="code" href="structSinic_1_1Device_1_1VirtualReg.html">VirtualReg</a> *vnic = &amp;<a class="code" href="classSinic_1_1Device.html#a2770f4bf1518ad5b7b1f4c01e3b5f913">virtualRegs</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>];
<a name="l01519"></a>01519         std::string <a class="code" href="namespaceX86ISA.html#a6c9f38e48611db30642897e93a05104c">reg</a> = <a class="code" href="cprintf_8hh.html#ace22d1c39f2df58e593bc49d1613eca2">csprintf</a>(<span class="stringliteral">&quot;vnic%d&quot;</span>, <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>);
<a name="l01520"></a>01520 
<a name="l01521"></a>01521         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.RxData&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a2947ccfee0184b327039b40088286991">RxData</a>);
<a name="l01522"></a>01522         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.RxDone&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a891a406f4bba99bff1ba557d5a478400">RxDone</a>);
<a name="l01523"></a>01523         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.TxData&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a4436214670ccca3073273379e7379702">TxData</a>);
<a name="l01524"></a>01524         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.TxDone&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a05bed8f8b5379c39943ca0f45755a7d5">TxDone</a>);
<a name="l01525"></a>01525 
<a name="l01526"></a>01526         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#ab07339cb582cf0041762db36e6b53d5a">rxUnique</a> = <a class="code" href="classSinic_1_1Device.html#a6a5cad238c3c51fe5a4e792b527732d8">rxUnique</a>++;
<a name="l01527"></a>01527         vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#acd1254bcf087d9fdc4f83e7d8546bbe8">txUnique</a> = <a class="code" href="classSinic_1_1Device.html#aeeb0f182a7a5311450ea258712327266">txUnique</a>++;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529         <span class="keywordtype">bool</span> rxPacketExists;
<a name="l01530"></a>01530         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.rxPacketExists&quot;</span>, rxPacketExists);
<a name="l01531"></a>01531         <span class="keywordflow">if</span> (rxPacketExists) {
<a name="l01532"></a>01532             <span class="keywordtype">int</span> rxPacket;
<a name="l01533"></a>01533             <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.rxPacket&quot;</span>, rxPacket);
<a name="l01534"></a>01534             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#a82402a69186659a7e351a58655727fee">begin</a>();
<a name="l01535"></a>01535             <span class="keywordflow">while</span> (rxPacket--)
<a name="l01536"></a>01536                 ++vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a>;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538             <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.rxPacketOffset&quot;</span>,
<a name="l01539"></a>01539                     vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a99de165e5d0d855bda477769bc1b859d">rxPacketOffset</a>);
<a name="l01540"></a>01540             <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.rxPacketBytes&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#a53cc97d37afa639b6a8735994bd938f4">rxPacketBytes</a>);
<a name="l01541"></a>01541         } <span class="keywordflow">else</span> {
<a name="l01542"></a>01542             vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#af4ea65796edb652a5305e16229b7ad3e">rxIndex</a> = <a class="code" href="classSinic_1_1Device.html#a4b590aae51c077a247a671919fa40d0c">rxFifo</a>.<a class="code" href="classPacketFifo.html#aff46ba8e1d41ee95911c1e0c34a54053">end</a>();
<a name="l01543"></a>01543         }
<a name="l01544"></a>01544         <a class="code" href="arch_2x86_2types_8cc.html#a2c99d2d69578d585494e1182085cb158">paramIn</a>(cp, section, reg + <span class="stringliteral">&quot;.rxDoneData&quot;</span>, vnic-&gt;<a class="code" href="structSinic_1_1Device_1_1VirtualReg.html#abddf80b43c346973e79a530d08aa2698">rxDoneData</a>);
<a name="l01545"></a>01545     }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     <span class="comment">/*</span>
<a name="l01548"></a>01548 <span class="comment">     * If there&#39;s a pending transmit, reschedule it now</span>
<a name="l01549"></a>01549 <span class="comment">     */</span>
<a name="l01550"></a>01550     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> transmitTick;
<a name="l01551"></a>01551     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(transmitTick);
<a name="l01552"></a>01552     <span class="keywordflow">if</span> (transmitTick)
<a name="l01553"></a>01553         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classSinic_1_1Device.html#ad011cd0c6ce5f55f2b76bdca738b1227">txEvent</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() + transmitTick);
<a name="l01554"></a>01554 
<a name="l01555"></a>01555     <a class="code" href="classPioDevice.html#a81c4d0791b19b64007a79efe336a65e8" title="The pioPort that handles the requests for us and provides us requests that it sees.">pioPort</a>.<a class="code" href="classSlavePort.html#a335e5649623f9976259f34aa10bbebdd" title="Called by the owner to send a range change.">sendRangeChange</a>();
<a name="l01556"></a>01556 
<a name="l01557"></a>01557 }
<a name="l01558"></a>01558 
<a name="l01559"></a>01559 } <span class="comment">// namespace Sinic</span>
<a name="l01560"></a>01560 
<a name="l01561"></a>01561 <a class="code" href="classSinic_1_1Device.html">Sinic::Device</a> *
<a name="l01562"></a>01562 SinicParams::create()
<a name="l01563"></a>01563 {
<a name="l01564"></a>01564     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classSinic_1_1Device.html#ac26c275c96a501f66102a346897b4728">Sinic::Device</a>(<span class="keyword">this</span>);
<a name="l01565"></a>01565 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Sun Apr 7 2013 18:16:37 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.7.1</small></address>

</body>
</html>
